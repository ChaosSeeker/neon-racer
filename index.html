<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Neon Highway Racer ‚Äî Ultimate</title>

  <style>
    :root{
      --bg:#050814; --panel:#0b1230; --text:#eaf0ff; --muted:#9fb0e6;
      --a:#7cffea; --p:#ff6adf; --g:#ffd24d;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 700px at 50% 15%, #1a2a7a 0%, var(--bg) 60%);
      color:var(--text);
      overflow:hidden;
    }
    .wrap{width:min(1140px, 95vw); display:grid; gap:14px;}
    header{
      background:rgba(11,18,48,.82);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px; padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    h1{margin:0; font-size:16px; letter-spacing:.3px}
    .sub{font-size:12px; color:var(--muted)}
    .left{display:flex; flex-direction:column; gap:2px}
    .stats{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      padding:8px 12px; border-radius:999px; font-size:13px;
      display:flex; gap:6px; align-items:center;
    }
    .pill b{font-weight:950}
    .bar{
      width:120px; height:8px; border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > i{display:block; height:100%; width:50%; background:rgba(120,255,220,.85)}
    .btns{display:flex; gap:8px; flex-wrap:wrap}
    button{
      cursor:pointer; color:var(--text);
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      border-radius:12px; padding:10px 12px;
      font-weight:950; font-size:13px;
      transition:.15s transform,.15s background;
      user-select:none;
    }
    button:hover{background:rgba(255,255,255,.12)}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.55; cursor:not-allowed}

    .board{
      position:relative;
      background:rgba(11,18,48,.62);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px; padding:12px;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    canvas{
      width:100%;
      height:auto;
      aspect-ratio:16/9;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      display:block;
      touch-action:none;
    }

    /* HUD mini menu button (top-right) */
    .miniMenu{
      position:absolute; top:14px; right:14px; z-index:20;
      display:flex; gap:8px; align-items:center;
    }
    .miniBtn{
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.25);
      display:grid; place-items:center;
      font-size:18px; font-weight:900;
    }

    .help{
      margin-top:10px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color:var(--muted); font-size:13px;
    }
    .kbd{font-family: ui-monospace,SFMono-Regular,Menlo,monospace}

    /* Mobile controls */
    .mobileControls{
      display:none; margin-top:10px; gap:10px; flex-wrap:wrap;
      justify-content:space-between; align-items:center;
      user-select:none;
    }
    .pad{display:flex; gap:10px; align-items:center}
    .big{padding:14px 16px; border-radius:16px; font-size:14px; min-width:92px; text-align:center;}
    @media (max-width:760px){ .mobileControls{display:flex} }

    /* Overlays */
    .overlay{
      position:fixed; inset:0;
      display:grid; place-items:center;
      background:rgba(0,0,0,.62);
      backdrop-filter: blur(7px);
      padding:18px;
      z-index:50;
    }
    .panel{
      width:min(980px, 94vw);
      background:rgba(11,18,48,.94);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      padding:16px;
      box-shadow:0 24px 70px rgba(0,0,0,.6);
      max-height:min(86vh, 820px);
      overflow:auto;
    }
    .panel h2{margin:0 0 6px; font-size:20px; letter-spacing:.4px}
    .panel p{margin:0 0 12px; color:var(--muted); line-height:1.5}
    .grid2{display:grid; grid-template-columns: 1.2fr 1fr; gap:12px;}
    @media (max-width:900px){ .grid2{grid-template-columns:1fr} }

    .card{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      border-radius:16px; padding:12px;
    }
    .card h3{margin:0 0 6px; font-size:14px}
    .card p{margin:0; color:var(--muted); font-size:13px; line-height:1.5}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      user-select:none;
      font-size:13px; font-weight:950;
    }
    .chip input{accent-color:#6ff; cursor:pointer}

    .nameBox label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    .nameBox input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      font-weight:900;
    }
    .nameBox input:focus{border-color: rgba(124,255,234,.7)}

    /* Countdown overlay */
    .countdown{
      position:absolute; inset:0;
      display:none;
      place-items:center;
      z-index:30;
      background: radial-gradient(900px 520px at 50% 45%, rgba(124,255,234,.08), rgba(0,0,0,.65));
      border-radius:14px;
    }
    .countdown .num{
      font-size:min(120px, 22vw);
      font-weight:1000;
      letter-spacing:2px;
      text-shadow:0 18px 60px rgba(0,0,0,.75);
      transform: translateY(-6px);
    }
    .countdown .sub{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
      text-align:center;
    }

    /* Game Over overlay */
    .gameover{
      position:absolute; inset:0;
      display:none;
      place-items:center;
      z-index:35;
      background: rgba(0,0,0,.55);
      border-radius:14px;
    }
    .gameover .box{
      width:min(520px, 92vw);
      border:1px solid rgba(255,255,255,.14);
      background:rgba(11,18,48,.92);
      border-radius:18px;
      padding:14px;
      box-shadow:0 24px 70px rgba(0,0,0,.6);
      text-align:center;
    }
    .gameover h3{margin:0 0 8px; font-size:22px}
    .gameover .meta{color:var(--muted); font-size:13px; line-height:1.45; margin-bottom:12px}
    .gameover .bigScore{font-size:34px; font-weight:1000; margin:10px 0 8px}

    /* Emoji layer */
    .emojiLayer{position:fixed; inset:0; pointer-events:none; z-index:80;}
    .emojiPop{
      position:absolute;
      transform: translate(-50%, -50%) scale(1);
      font-size:44px;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.45));
      will-change: transform, opacity;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="left">
        <h1>Neon Highway Racer ‚Äî Ultimate</h1>
        <div class="sub">Homepage ‚Üí Play ‚Üí Countdown ‚Üí Race ‚Ä¢ Mobile-ready ‚Ä¢ Share challenge</div>
      </div>

      <div class="stats">
        <div class="pill">Player: <b id="playerName">Gamer</b></div>
        <div class="pill">Score: <b id="score">0</b></div>
        <div class="pill">Best: <b id="best">0</b></div>
        <div class="pill">Mode: <b id="mode">Easy</b></div>
        <div class="pill" title="Nitro">
          Nitro:
          <span class="bar"><i id="nitroFill"></i></span>
        </div>
        <div class="pill" title="Coins in this run">Run ü™ô: <b id="runCoins">0</b></div>
        <div class="pill" title="Total coins saved">Bank ü™ô: <b id="bankCoins">0</b></div>
        <div class="pill" title="Lives this run">Lives: <b id="lives">2</b></div>
      </div>

      <div class="btns">
        <button id="pauseBtn" title="Pause/Resume (Space)" disabled>Pause</button>
        <button id="restartBtn" title="Restart (R)" disabled>Restart</button>
        <button id="shareTopBtn" title="Share challenge">Share</button>
      </div>
    </header>

    <div class="board">
      <div class="miniMenu">
        <button class="miniBtn" id="openMenuBtn" title="Menu">‚â°</button>
      </div>

      <canvas id="game" width="960" height="540"></canvas>

      <!-- Countdown overlay inside canvas card -->
      <div class="countdown" id="countdown">
        <div>
          <div class="num" id="countNum">3</div>
          <div class="sub">Get ready‚Ä¶</div>
        </div>
      </div>

      <!-- Game over overlay inside canvas card -->
      <div class="gameover" id="gameover">
        <div class="box">
          <h3>Game Over üò≠</h3>
          <div class="meta" id="goMeta">Nice run!</div>
          <div class="bigScore" id="goScore">0</div>
          <div class="row" style="justify-content:center">
            <button id="goRestart">Restart</button>
            <button id="goHome">Home</button>
            <button id="goShare">Share</button>
          </div>
          <p class="meta" style="margin-top:10px">Tip: Close calls give bonus points + a drift whoosh.</p>
        </div>
      </div>

      <div class="help">
        <div>
          Controls: <span class="kbd">‚Üê ‚Üí</span>/<span class="kbd">A D</span> steer ‚Ä¢
          <span class="kbd">‚Üë</span>/<span class="kbd">W</span> nitro ‚Ä¢
          <span class="kbd">Shift</span> drift ‚Ä¢
          <span class="kbd">Space</span> pause ‚Ä¢ <span class="kbd">R</span> restart
        </div>
        <div class="sub">Mobile: buttons below (or swipe left/right; swipe up = nitro)</div>
      </div>

      <div class="mobileControls">
        <div class="pad">
          <button class="big" id="mLeft">‚óÄ Left</button>
          <button class="big" id="mRight">Right ‚ñ∂</button>
        </div>
        <div class="pad">
          <button class="big" id="mDrift">‚ö° Drift</button>
          <button class="big" id="mNitro">üöÄ Nitro</button>
        </div>
      </div>
    </div>
  </div>

  <!-- HOMEPAGE / MENU OVERLAY -->
  <div class="overlay" id="home">
    <div class="panel">
      <h2>üèÅ Neon Highway Racer</h2>
      <p>Welcome! Set your name, pick difficulty, then hit Play. (Game will NOT start until you click Play.)</p>

      <div class="grid2">
        <div class="card nameBox">
          <h3>Player name</h3>
          <p style="margin-bottom:10px">This is stored on your device (local). Default: <b>Gamer</b>.</p>
          <label for="nameInput">Name</label>
          <input id="nameInput" maxlength="18" placeholder="e.g., Gamer" />
          <div class="row" style="margin-top:10px">
            <button id="saveNameBtn">Save</button>
            <button id="playBtn">Play</button>
          </div>

          <div class="row" style="margin-top:10px">
            <label class="chip"><input id="musicToggle" type="checkbox" checked /> Music</label>
            <label class="chip"><input id="sfxToggle" type="checkbox" checked /> SFX</label>
          </div>
        </div>

        <div class="card">
          <h3>Difficulty</h3>
          <p>Easy is relaxed. Medium is normal. Hard is intense.</p>
          <div class="row" style="margin-top:10px">
            <button class="modeBtn" data-mode="easy">Easy</button>
            <button class="modeBtn" data-mode="medium">Medium</button>
            <button class="modeBtn" data-mode="hard">Hard</button>
          </div>
          <p class="sub" style="margin-top:10px">Leaderboard will show when Supabase is online again.</p>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="grid2">
        <div class="card">
          <h3>How to play</h3>
          <p>Dodge cars, grab coins, and keep your streak alive. Nitro helps you escape tight gaps.</p>
        </div>
        <div class="card">
          <h3>Feedback</h3>
          <p>Send feedback via Instagram DM: <b>@daily__discipline.01</b></p>
          <div class="row" style="margin-top:10px">
            <button id="feedbackBtn">Open DM</button>
            <button id="shareHomeBtn">Share challenge</button>
          </div>
        </div>
      </div>

      <p class="sub" style="margin-top:12px">
        ‚úÖ Homepage first ‚Ä¢ ‚úÖ Countdown ‚Ä¢ ‚úÖ Game Over overlay ‚Ä¢ ‚úÖ Mobile controls
      </p>
    </div>
  </div>

  <div class="emojiLayer" id="emojiLayer"></div>

<script>
(() => {
  // =========================
  // SUPABASE CONFIG (kept as-is; no changes)
  // =========================
  const SUPABASE_URL = "https://dnyibstgahnjbkjo.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_1PLhDg4aoFucc0-7qWH0KA_unYKueat";

  // ===== DOM =====
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;

  const playerNameEl = document.getElementById("playerName");
  const scoreEl = document.getElementById("score");
  const bestEl  = document.getElementById("best");
  const modeEl  = document.getElementById("mode");
  const nitroFill = document.getElementById("nitroFill");
  const runCoinsEl = document.getElementById("runCoins");
  const bankCoinsEl = document.getElementById("bankCoins");
  const livesEl = document.getElementById("lives");

  const pauseBtn = document.getElementById("pauseBtn");
  const restartBtn = document.getElementById("restartBtn");
  const shareTopBtn = document.getElementById("shareTopBtn");

  const openMenuBtn = document.getElementById("openMenuBtn");

  const homeOverlay = document.getElementById("home");
  const nameInput = document.getElementById("nameInput");
  const saveNameBtn = document.getElementById("saveNameBtn");
  const playBtn = document.getElementById("playBtn");
  const modeBtns = document.querySelectorAll(".modeBtn");

  const musicToggle = document.getElementById("musicToggle");
  const sfxToggle = document.getElementById("sfxToggle");

  const countdownEl = document.getElementById("countdown");
  const countNumEl = document.getElementById("countNum");

  const gameoverEl = document.getElementById("gameover");
  const goMetaEl = document.getElementById("goMeta");
  const goScoreEl = document.getElementById("goScore");
  const goRestart = document.getElementById("goRestart");
  const goHome = document.getElementById("goHome");
  const goShare = document.getElementById("goShare");

  const feedbackBtn = document.getElementById("feedbackBtn");
  const shareHomeBtn = document.getElementById("shareHomeBtn");

  const emojiLayer = document.getElementById("emojiLayer");

  const mLeft = document.getElementById("mLeft");
  const mRight = document.getElementById("mRight");
  const mNitro = document.getElementById("mNitro");
  const mDrift = document.getElementById("mDrift");

  // ===== helpers =====
  const clamp = (v,a,b)=>Math.max(a, Math.min(b, v));
  const randInt = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const lerp = (a,b,t)=> a + (b-a)*t;

  function rectHit(ax,ay,aw,ah, bx,by,bw,bh){
    const aL = ax-aw/2, aR = ax+aw/2, aT = ay-ah/2, aB = ay+ah/2;
    const bL = bx-bw/2, bR = bx+bw/2, bT = by-bh/2, bB = by+bh/2;
    return (aL < bR && aR > bL && aT < bB && aB > bT);
  }
  function distRect(ax,ay,aw,ah, bx,by,bw,bh){
    const aL = ax-aw/2, aR = ax+aw/2, aT = ay-ah/2, aB = ay+ah/2;
    const bL = bx-bw/2, bR = bx+bw/2, bT = by-bh/2, bB = by+bh/2;
    const dx = Math.max(bL - aR, aL - bR, 0);
    const dy = Math.max(bT - aB, aT - bB, 0);
    return Math.hypot(dx, dy);
  }

  // ===== Difficulty =====
  const MODES = {
    easy:   { name:"Easy",   baseSpeed: 230, accel: 7,  spawnRate: 0.85, maxTraffic: 7,  wiggle: 28,
              trafficRelMin:0.60, trafficRelMax:0.98,
              laneChangeRate: 0.050, laneChangeSpeed: 2.6, laneChangeCooldown:[1.4, 2.4] },

    medium: { name:"Medium", baseSpeed: 300, accel: 10, spawnRate: 1.10, maxTraffic: 10, wiggle: 55,
              trafficRelMin:0.64, trafficRelMax:1.12,
              laneChangeRate: 0.095, laneChangeSpeed: 5.0, laneChangeCooldown:[0.85, 1.6] },

    hard:   { name:"Hard",   baseSpeed: 360, accel: 13, spawnRate: 1.35, maxTraffic: 13, wiggle: 75,
              trafficRelMin:0.68, trafficRelMax:1.22,
              laneChangeRate: 0.150, laneChangeSpeed: 7.0, laneChangeCooldown:[0.55, 1.2] },
  };

  // ===== Road/Lanes =====
  const road = { x: W*0.18, w: W*0.64, y: 0, h: H };
  const laneCount = 3;
  const laneW = road.w / laneCount;
  const laneCenter = (lane)=> road.x + laneW*(lane + 0.5);

  // ===== Local profile =====
  const PROFILE_KEY = "neon_racer_profile_v4";
  function loadProfile(){
    try{ return JSON.parse(localStorage.getItem(PROFILE_KEY) || "null"); } catch { return null; }
  }
  function saveProfile(p){ localStorage.setItem(PROFILE_KEY, JSON.stringify(p)); }

  let profile = loadProfile() || { name:"Gamer", bestScore:0, bankCoins:0 };

  // ===== Emoji effects =====
  function popEmoji(emoji, x, y, duration=650){
    const el=document.createElement("div");
    el.className="emojiPop";
    el.textContent=emoji;
    el.style.left=x+"px";
    el.style.top=y+"px";
    el.style.opacity="0";
    emojiLayer.appendChild(el);

    const start=performance.now();
    function anim(now){
      const t=(now-start)/duration;
      if(t>=1){ el.remove(); return; }
      const ease=t<0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2;
      const scale=0.75 + 0.95*ease;
      const floatY=-22*ease;
      el.style.opacity=String(1 - t*0.85);
      el.style.transform=`translate(-50%,-50%) translateY(${floatY}px) scale(${scale})`;
      requestAnimationFrame(anim);
    }
    requestAnimationFrame(anim);
  }

  // =========================
  // AUDIO (music + engine + whoosh)
  // =========================
  let audioCtx=null, master=null, musicGain=null, sfxGain=null;
  let song=null;
  let engine = { osc:null, gain:null, filter:null, on:false };

  function ensureAudio(){
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    master = audioCtx.createGain();
    master.gain.value = 0.55;
    master.connect(audioCtx.destination);

    musicGain = audioCtx.createGain();
    musicGain.gain.value = musicToggle.checked ? 0.22 : 0.0;
    musicGain.connect(master);

    sfxGain = audioCtx.createGain();
    sfxGain.gain.value = sfxToggle.checked ? 0.95 : 0.0;
    sfxGain.connect(master);

    song = createRacingMusic(audioCtx, musicGain);
    song.start();
  }

  function createRacingMusic(ctx, out){
    const tempo = 140;
    const beat = 60/tempo;
    const step = beat/2;
    const state = { t: ctx.currentTime, timer:null, on:true };

    const bus = ctx.createGain(); bus.gain.value = 0.95;
    const comp = ctx.createDynamicsCompressor();
    comp.threshold.value=-18; comp.knee.value=20; comp.ratio.value=6;
    comp.attack.value=0.005; comp.release.value=0.1;

    const lp = ctx.createBiquadFilter();
    lp.type="lowpass"; lp.frequency.value=1700;

    bus.connect(comp); comp.connect(lp); lp.connect(out);

    const base = 220;
    const freq = (semi)=> base * Math.pow(2, semi/12);

    const prog = [0,0,-2,-2,-5,-5,-2,-2];
    const leadNotes = [7,10,12,10,7,5,3,5];

    function kick(t){
      const o=ctx.createOscillator(); const g=ctx.createGain();
      o.type="sine";
      o.frequency.setValueAtTime(160,t);
      o.frequency.exponentialRampToValueAtTime(52,t+0.10);
      g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(0.75,t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001,t+0.13);
      o.connect(g); g.connect(bus);
      o.start(t); o.stop(t+0.14);
    }
    function snare(t){
      const dur=0.09;
      const buffer=ctx.createBuffer(1, ctx.sampleRate*dur, ctx.sampleRate);
      const data=buffer.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*Math.exp(-i/(data.length/3));
      const src=ctx.createBufferSource(); src.buffer=buffer;
      const bp=ctx.createBiquadFilter(); bp.type="bandpass"; bp.frequency.value=1800; bp.Q.value=0.9;
      const g=ctx.createGain();
      g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(0.35,t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
      src.connect(bp); bp.connect(g); g.connect(bus);
      src.start(t); src.stop(t+dur);
    }
    function hat(t){
      const dur=0.03;
      const buffer=ctx.createBuffer(1, ctx.sampleRate*dur, ctx.sampleRate);
      const data=buffer.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*Math.exp(-i/(data.length/2));
      const src=ctx.createBufferSource(); src.buffer=buffer;
      const hp=ctx.createBiquadFilter(); hp.type="highpass"; hp.frequency.value=6500;
      const g=ctx.createGain();
      g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(0.14,t+0.005);
      g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
      src.connect(hp); hp.connect(g); g.connect(bus);
      src.start(t); src.stop(t+dur);
    }
    function bass(t, semi){
      const o=ctx.createOscillator(); const g=ctx.createGain();
      const f=ctx.createBiquadFilter();
      o.type="square";
      o.frequency.setValueAtTime(freq(semi-12),t);
      f.type="lowpass"; f.frequency.value=320;
      g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(0.22,t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001,t+step*1.8);
      o.connect(f); f.connect(g); g.connect(bus);
      o.start(t); o.stop(t+step*2);
    }
    function lead(t, semi){
      const o=ctx.createOscillator(); const g=ctx.createGain();
      const d=ctx.createDelay(); d.delayTime.value=0.11;
      const fb=ctx.createGain(); fb.gain.value=0.22;
      d.connect(fb); fb.connect(d);

      o.type="sawtooth";
      o.frequency.setValueAtTime(freq(semi+12),t);
      g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(0.08,t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001,t+step*1.7);

      o.connect(g); g.connect(d); d.connect(bus); g.connect(bus);
      o.start(t); o.stop(t+step*1.8);
    }

    function schedule(){
      if (!state.on) return;
      const now=ctx.currentTime;
      while(state.t < now + 0.15){
        const n = Math.round(state.t / step);
        const barPos = Math.floor(n/2) % prog.length;

        if (n % 4 === 0) kick(state.t);
        if (n % 8 === 4) snare(state.t);
        if (n % 2 === 1) hat(state.t);

        if (n % 2 === 0) bass(state.t, prog[barPos]);
        if (n % 4 === 2){
          const ln = leadNotes[barPos] + prog[barPos];
          lead(state.t, ln);
        }
        state.t += step;
      }
      state.timer = setTimeout(schedule, 50);
    }

    return {
      start(){ state.on=true; state.t=ctx.currentTime; schedule(); },
      stop(){ state.on=false; if(state.timer) clearTimeout(state.timer); }
    };
  }

  function setEngine(on){
    ensureAudio();
    if (on && !engine.on){
      engine.on=true;
      const o=audioCtx.createOscillator();
      const g=audioCtx.createGain();
      const f=audioCtx.createBiquadFilter();
      o.type="sawtooth";
      f.type="lowpass";
      f.frequency.value=900;
      g.gain.value=0.0001;
      o.connect(f); f.connect(g); g.connect(sfxGain);
      o.start();
      engine.osc=o; engine.gain=g; engine.filter=f;
    } else if(!on && engine.on){
      engine.on=false;
      try{ engine.osc.stop(); }catch{}
      engine.osc=null; engine.gain=null; engine.filter=null;
    }
  }

  function updateEngine(effectiveSpeed, nitroActive, driftActive, playing){
    if (!engine.on || !engine.osc) return;
    const t=audioCtx.currentTime;
    const base = 90 + effectiveSpeed*0.25;
    const wobble = driftActive ? 18 : 0;
    const targetHz = clamp(base + (nitroActive?55:0) + wobble, 80, 340);
    engine.osc.frequency.setTargetAtTime(targetHz, t, 0.04);
    engine.filter.frequency.setTargetAtTime(700 + (nitroActive?650:350), t, 0.06);
    engine.gain.gain.setTargetAtTime(playing ? 0.055 : 0.0001, t, 0.06);
  }

  function sfx(type){
    if (!sfxToggle.checked) return;
    ensureAudio();
    const t0 = audioCtx.currentTime;

    if (type==="whoosh"){
      const n = audioCtx.createBufferSource();
      const dur=0.18;
      const buffer=audioCtx.createBuffer(1, audioCtx.sampleRate*dur, audioCtx.sampleRate);
      const data=buffer.getChannelData(0);
      for(let i=0;i<data.length;i++){
        data[i]=(Math.random()*2-1)*Math.exp(-i/(data.length/2));
      }
      n.buffer=buffer;

      const bp=audioCtx.createBiquadFilter(); bp.type="bandpass"; bp.frequency.value=1200; bp.Q.value=0.9;
      const g=audioCtx.createGain();
      g.gain.setValueAtTime(0.0001,t0);
      g.gain.exponentialRampToValueAtTime(0.25,t0+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001,t0+dur);
      n.connect(bp); bp.connect(g); g.connect(sfxGain);
      n.start(t0); n.stop(t0+dur);
      return;
    }

    if (type==="coin"){
      const o=audioCtx.createOscillator();
      const g=audioCtx.createGain();
      o.type="square";
      o.frequency.setValueAtTime(980,t0);
      o.frequency.exponentialRampToValueAtTime(1560,t0+0.06);
      g.gain.setValueAtTime(0.0001,t0);
      g.gain.exponentialRampToValueAtTime(0.22,t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001,t0+0.12);
      o.connect(g); g.connect(sfxGain);
      o.start(t0); o.stop(t0+0.13);
      return;
    }

    if (type==="crash"){
      const dur=0.35;
      const buffer=audioCtx.createBuffer(1, audioCtx.sampleRate*dur, audioCtx.sampleRate);
      const data=buffer.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*Math.exp(-i/(data.length/4));
      const src=audioCtx.createBufferSource(); src.buffer=buffer;
      const f=audioCtx.createBiquadFilter(); f.type="lowpass"; f.frequency.value=900;
      const g=audioCtx.createGain();
      g.gain.setValueAtTime(0.0001,t0);
      g.gain.exponentialRampToValueAtTime(0.45,t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001,t0+dur);
      src.connect(f); f.connect(g); g.connect(sfxGain);
      src.start(t0); src.stop(t0+dur);
      return;
    }
  }

  musicToggle.addEventListener("change", () => {
    ensureAudio();
    musicGain.gain.value = musicToggle.checked ? 0.22 : 0.0;
  });
  sfxToggle.addEventListener("change", () => {
    ensureAudio();
    sfxGain.gain.value = sfxToggle.checked ? 0.95 : 0.0;
  });

  // ===== Instagram DM link =====
  function openInstagramDM(username){
    const deep = `instagram://direct/new?username=${encodeURIComponent(username)}`;
    const web1 = `https://ig.me/m/${encodeURIComponent(username)}`;
    const web2 = `https://www.instagram.com/direct/new/?username=${encodeURIComponent(username)}`;

    const a = document.createElement("a");
    a.href = deep;
    a.style.display = "none";
    document.body.appendChild(a);
    a.click();
    a.remove();

    setTimeout(() => {
      const w = window.open(web1, "_blank", "noopener,noreferrer");
      if (!w) window.location.href = web2;
    }, 250);
  }
  feedbackBtn.addEventListener("click", () => openInstagramDM("daily__discipline.01"));

  // ===== Share challenge =====
  async function shareChallenge(){
    const finalScore = profile.bestScore || 0;
    const text = `üèÅ Neon Highway Racer Challenge!\nMy best score: ${finalScore} üî•\nCan you beat me?\nPlay: ${location.href}`;
    try{
      if (navigator.share) await navigator.share({ title:"Neon Highway Racer", text, url: location.href });
      else if (navigator.clipboard){ await navigator.clipboard.writeText(text); alert("Copied! Paste in WhatsApp/Instagram."); }
      else prompt("Copy:", text);
    } catch {}
  }
  shareTopBtn.addEventListener("click", shareChallenge);
  shareHomeBtn.addEventListener("click", shareChallenge);
  goShare.addEventListener("click", shareChallenge);

  // ===== Input (game only) =====
  const keys = new Set();
  window.addEventListener("keydown",(e)=>{
    const target = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
    const typing = (target === "input" || target === "textarea");
    const k=e.key.toLowerCase();

    // only control game when NOT typing and game is active
    if(!typing && screen==="game"){
      keys.add(k);
      if(k===" "){ e.preventDefault(); togglePause(); }
      if(k==="r"){ e.preventDefault(); requestRestart(); }
      if(k==="arrowleft"||k==="a") e.preventDefault();
      if(k==="arrowright"||k==="d") e.preventDefault();
      if(k==="arrowup"||k==="w") e.preventDefault();
    }
  });
  window.addEventListener("keyup",(e)=>keys.delete(e.key.toLowerCase()));

  function holdButton(btn, downFn, upFn){
    const down=(e)=>{ e.preventDefault(); downFn(); };
    const up=(e)=>{ e.preventDefault(); upFn(); };
    btn.addEventListener("pointerdown", down);
    btn.addEventListener("pointerup", up);
    btn.addEventListener("pointercancel", up);
    btn.addEventListener("pointerleave", up);
  }
  holdButton(mLeft,  ()=>keys.add("arrowleft"), ()=>keys.delete("arrowleft"));
  holdButton(mRight, ()=>keys.add("arrowright"),()=>keys.delete("arrowright"));
  holdButton(mNitro, ()=>keys.add("arrowup"),   ()=>keys.delete("arrowup"));
  holdButton(mDrift, ()=>keys.add("shift"),     ()=>keys.delete("shift"));

  // swipe
  let touchStart=null;
  canvas.addEventListener("pointerdown",(e)=>touchStart={x:e.clientX,y:e.clientY});
  canvas.addEventListener("pointerup",(e)=>{
    if(!touchStart) return;
    const dx=e.clientX-touchStart.x;
    const dy=e.clientY-touchStart.y;
    touchStart=null;
    const ax=Math.abs(dx), ay=Math.abs(dy);
    if(Math.max(ax,ay)<18) return;
    if(screen!=="game") return;
    if(ax>ay){
      if(dx>0) steer(1); else steer(-1);
    } else if(dy<0){
      keys.add("arrowup");
      setTimeout(()=>keys.delete("arrowup"),140);
    }
  });

  // ===== Game objects =====
  const player = { x: laneCenter(1), y: H*0.78, w: 52, h: 96, vx:0, targetX:null };

  const traffic=[], coins=[], sparks=[];
  const stars = Array.from({length: 90}, ()=>({ x:Math.random()*W, y:Math.random()*H, s:0.5+Math.random()*1.6 }));

  // ===== State =====
  let screen = "home"; // "home" | "countdown" | "game" | "gameover"
  let paused = false;
  let last = performance.now();

  let modeKey="easy";
  let mode = MODES[modeKey];

  let running=false;
  let score=0, speed=0, roadY=0;
  let runCoins=0;
  let nitro=1.0, nitroActive=false;
  let driftActive=false;
  let lives=2;

  const power = { shield:0, slowmoT:0, magnetT:0, invisibilityT:0 };

  // spawn timers (declared ONCE)
  let spawnTimer=0, coinTimer=0;

  // ===== UI sync =====
  function syncUI(){
    playerNameEl.textContent = profile.name || "Gamer";
    scoreEl.textContent = Math.floor(score);
    bestEl.textContent = profile.bestScore || 0;
    modeEl.textContent = MODES[modeKey].name;
    runCoinsEl.textContent = runCoins;
    bankCoinsEl.textContent = profile.bankCoins || 0;
    livesEl.textContent = lives;
    nitroFill.style.width = Math.round(clamp(nitro,0,1)*100)+"%";
  }

  // ===== Drawing helpers =====
  function roundRect(x,y,w,h,r){
    const rr=Math.min(r,w/2,h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }

  function drawRoad(){
    ctx.fillStyle="#050814";
    ctx.fillRect(0,0,W,H);

    ctx.globalAlpha=0.6;
    for(const st of stars){
      ctx.fillRect(st.x,st.y,st.s,st.s);
      st.y += (Math.max(140,speed)*0.02)*(st.s)*0.03;
      if(st.y>H){ st.y=-5; st.x=Math.random()*W; }
    }
    ctx.globalAlpha=1;

    const grad = ctx.createLinearGradient(road.x,0,road.x+road.w,0);
    grad.addColorStop(0,"rgba(20,240,255,.10)");
    grad.addColorStop(0.5,"rgba(255,255,255,.05)");
    grad.addColorStop(1,"rgba(255,70,220,.10)");
    ctx.fillStyle=grad;
    roundRect(road.x,0,road.w,H,22);
    ctx.fill();

    ctx.strokeStyle="rgba(255,255,255,.16)";
    ctx.lineWidth=2;
    roundRect(road.x,0,road.w,H,22);
    ctx.stroke();

    ctx.save();
    ctx.beginPath();
    ctx.rect(road.x,0,road.w,H);
    ctx.clip();
    ctx.strokeStyle="rgba(255,255,255,.20)";
    ctx.lineWidth=2;
    for(let i=1;i<laneCount;i++){
      const lx = road.x + laneW*i;
      for(let y=-80; y<H+80; y+=60){
        const yy = y + (roadY%60);
        ctx.beginPath();
        ctx.moveTo(lx,yy);
        ctx.lineTo(lx,yy+26);
        ctx.stroke();
      }
    }
    ctx.restore();
  }

  function drawPlayerCar(x,y,w,h){
    ctx.save();

    ctx.shadowBlur = 30;
    ctx.shadowColor = "rgba(124,255,234,.95)";
    const glowGrad = ctx.createRadialGradient(x, y+h*0.25, 10, x, y+h*0.30, 90);
    glowGrad.addColorStop(0, "rgba(124,255,234,.25)");
    glowGrad.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = glowGrad;
    ctx.beginPath();
    ctx.ellipse(x, y+h*0.33, w*0.78, 28, 0, 0, Math.PI*2);
    ctx.fill();

    ctx.shadowBlur = 0;
    const bodyGrad = ctx.createLinearGradient(x-w/2, y-h/2, x+w/2, y+h/2);
    bodyGrad.addColorStop(0,"rgba(40,220,255,.98)");
    bodyGrad.addColorStop(1,"rgba(80,120,255,.98)");
    ctx.fillStyle = bodyGrad;
    roundRect(x-w/2, y-h/2, w, h, 16);
    ctx.fill();

    // hood stripe
    const stripe = ctx.createLinearGradient(x, y-h/2, x, y+h/2);
    stripe.addColorStop(0,"rgba(255,255,255,.20)");
    stripe.addColorStop(0.5,"rgba(255,255,255,.06)");
    stripe.addColorStop(1,"rgba(255,255,255,.16)");
    ctx.fillStyle = stripe;
    roundRect(x-w*0.13, y-h*0.42, w*0.26, h*0.84, 12);
    ctx.fill();

    // windshield
    ctx.fillStyle="rgba(0,0,0,.38)";
    roundRect(x-w*0.30, y-h*0.22, w*0.60, h*0.28, 10);
    ctx.fill();

    // lights
    ctx.fillStyle="rgba(255,255,255,.92)";
    ctx.fillRect(x-w*0.36, y-h*0.45, w*0.18, 6);
    ctx.fillRect(x+w*0.18, y-h*0.45, w*0.18, 6);

    ctx.fillStyle="rgba(255,90,140,.88)";
    ctx.fillRect(x-w*0.36, y+h*0.40, w*0.18, 6);
    ctx.fillRect(x+w*0.18, y+h*0.40, w*0.18, 6);

    ctx.restore();
  }

  function drawEnemyCar(x,y,w,h,seed){
    ctx.save();

    ctx.shadowBlur = 18;
    ctx.shadowColor = "rgba(255,106,223,.45)";
    const glowGrad = ctx.createRadialGradient(x, y+h*0.25, 10, x, y+h*0.30, 80);
    glowGrad.addColorStop(0, "rgba(255,106,223,.16)");
    glowGrad.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = glowGrad;
    ctx.beginPath();
    ctx.ellipse(x, y+h*0.33, w*0.76, 26, 0, 0, Math.PI*2);
    ctx.fill();

    ctx.shadowBlur = 0;
    const bodyGrad = ctx.createLinearGradient(x-w/2, y-h/2, x+w/2, y+h/2);
    bodyGrad.addColorStop(0, `rgba(${Math.floor(170+seed*60)},${Math.floor(60+seed*130)},255,.96)`);
    bodyGrad.addColorStop(1, `rgba(255,${Math.floor(60+seed*140)},${Math.floor(140+seed*90)},.96)`);
    ctx.fillStyle = bodyGrad;
    roundRect(x-w/2, y-h/2, w, h, 16);
    ctx.fill();

    ctx.fillStyle="rgba(0,0,0,.32)";
    roundRect(x-w*0.30, y-h*0.22, w*0.60, h*0.28, 10);
    ctx.fill();

    ctx.restore();
  }

  function drawCoin(c){
    ctx.save();
    const pulse=1 + Math.sin(c.spin)*0.12;
    ctx.shadowBlur=18;
    ctx.shadowColor="rgba(255,210,77,0.95)";
    ctx.fillStyle="rgba(255,210,77,0.92)";
    ctx.beginPath();
    ctx.arc(c.x,c.y,c.r*pulse,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  function makeSparks(x,y,count){
    for(let i=0;i<count;i++){
      sparks.push({
        x: x + (Math.random()*18-9),
        y: y + (Math.random()*18-9),
        vx: (Math.random()*2-1)*520,
        vy: -(120+Math.random()*520),
        life: 0.16+Math.random()*0.22,
        c: Math.random()<0.5 ? "rgba(255,210,77,1)" : "rgba(255,106,223,1)"
      });
    }
  }

  // ===== Spawning =====
  function spawnCar(){
    if(traffic.length >= mode.maxTraffic) return;
    const lane=randInt(0,laneCount-1);
    if(traffic.some(t=>t.targetLane===lane && t.y<170)) return;

    traffic.push({
      x: laneCenter(lane),
      y: -140,
      w: 48, h: 92,
      rel: lerp(mode.trafficRelMin, mode.trafficRelMax, Math.random()),
      seed: Math.random(),
      targetLane: lane,
      laneChangeCooldown: lerp(mode.laneChangeCooldown[0], mode.laneChangeCooldown[1], Math.random()),
    });
  }
  function spawnCoin(){
    if(coins.length >= 12) return;
    const lane=randInt(0,laneCount-1);
    coins.push({ lane, x: laneCenter(lane), y:-60, r:12, spin:Math.random()*10 });
  }

  // ===== Game control =====
  function showHome(){
    screen="home";
    homeOverlay.style.display="grid";
    countdownEl.style.display="none";
    gameoverEl.style.display="none";
    running=false;
    paused=false;

    pauseBtn.disabled = true;
    restartBtn.disabled = true;

    setEngine(false);
    syncUI();
  }

  function hideHome(){
    homeOverlay.style.display="none";
  }

  async function startCountdownThenPlay(){
    // audio unlock on Play click
    ensureAudio();
    try{ await audioCtx.resume?.(); }catch{}

    hideHome();
    gameoverEl.style.display="none";
    screen="countdown";
    countdownEl.style.display="grid";

    paused=false;
    running=false;
    setEngine(false);

    // reset run state BEFORE countdown finishes (so visuals are ready)
    resetRunState();

    const seq = ["3","2","1","GO!"];
    for(let i=0;i<seq.length;i++){
      countNumEl.textContent = seq[i];
      // little pop
      countNumEl.animate(
        [{transform:"scale(0.85)", opacity:0.6},{transform:"scale(1.08)", opacity:1},{transform:"scale(1)", opacity:1}],
        {duration:420, easing:"cubic-bezier(.2,.9,.2,1)"}
      );
      await new Promise(r=>setTimeout(r, 620));
    }

    countdownEl.style.display="none";
    screen="game";
    running=true;
    paused=false;
    setEngine(true);

    pauseBtn.disabled = false;
    restartBtn.disabled = false;
  }

  function resetRunState(){
    score=0; speed=mode.baseSpeed; roadY=0;
    runCoins=0;
    nitro=1.0; nitroActive=false;
    driftActive=false;
    lives=2;

    power.shield=0; power.slowmoT=0; power.magnetT=0; power.invisibilityT=0;

    player.x=laneCenter(1);
    player.y=H*0.78;
    player.vx=0;
    player.targetX=null;

    traffic.length=0;
    coins.length=0;
    sparks.length=0;

    spawnTimer=0;
    coinTimer=0;

    syncUI();
  }

  function togglePause(){
    if(screen!=="game") return;
    paused=!paused;
    last=performance.now();
  }

  function requestRestart(){
    if(screen!=="game") return;
    // restart with countdown (feels better)
    startCountdownThenPlay();
  }

  pauseBtn.addEventListener("click", togglePause);
  restartBtn.addEventListener("click", requestRestart);

  openMenuBtn.addEventListener("click", ()=>{
    // When player presses menu button, go to home overlay (pause run)
    if(screen==="game"){
      paused=true;
    }
    showHome();
  });

  goRestart.addEventListener("click", ()=> startCountdownThenPlay());
  goHome.addEventListener("click", ()=> showHome());

  // ===== Homepage UI =====
  function setMode(key){
    modeKey = key;
    mode = MODES[modeKey];
    modeEl.textContent = mode.name;
    modeBtns.forEach(b=>{
      b.style.borderColor = (b.dataset.mode===key) ? "rgba(124,255,234,.75)" : "rgba(255,255,255,.16)";
    });
  }
  modeBtns.forEach(b=> b.addEventListener("click", ()=> setMode(b.dataset.mode)));
  setMode("easy");

  function saveName(){
    const nm = (nameInput.value || "").trim().slice(0,18);
    profile.name = nm || "Gamer";
    saveProfile(profile);
    syncUI();
  }
  saveNameBtn.addEventListener("click", saveName);

  playBtn.addEventListener("click", async ()=>{
    saveName();
    await startCountdownThenPlay();
  });

  // ===== Steering =====
  function steer(dir){
    const lane = clamp(Math.floor((player.x - road.x)/laneW), 0, laneCount-1);
    const next = clamp(lane+dir, 0, laneCount-1);
    player.targetX = laneCenter(next);
  }

  // ===== Update =====
  function update(dt){
    // ‚Äúidle mode‚Äù background motion
    const inGame = (screen==="game" && running && !paused);

    // speed baseline even on home to make road look alive
    if(!inGame){
      speed = lerp(speed, 220, 0.04);
      roadY += speed*dt;
      if(roadY>60) roadY -= 60;
      // keep player centered in idle
      player.x = lerp(player.x, laneCenter(1), 0.06);
      player.vx *= 0.9;
      return;
    }

    // game
    speed += mode.accel * dt;

    const nitroKey = keys.has("arrowup") || keys.has("w");
    nitroActive = nitroKey && nitro > 0.02;

    if(nitroActive) nitro = Math.max(0, nitro - dt*0.35);
    else nitro = Math.min(1.75, nitro + dt*0.18);

    driftActive = keys.has("shift");
    const steerLeft = keys.has("arrowleft") || keys.has("a");
    const steerRight= keys.has("arrowright") || keys.has("d");

    const nitroBoost = nitroActive ? 170 : 0;
    const effectiveSpeed = speed + nitroBoost;

    updateEngine(effectiveSpeed, nitroActive, driftActive, inGame);

    roadY += effectiveSpeed*dt;
    if(roadY>60) roadY -= 60;

    // steering
    const steerPower = driftActive ? 3400 : 2400;
    if(steerLeft) player.vx -= steerPower*dt;
    if(steerRight)player.vx += steerPower*dt;

    if(player.targetX !== null){
      const dx = player.targetX - player.x;
      player.vx += dx*18*dt;
      if(Math.abs(dx)<3){ player.x=player.targetX; player.targetX=null; player.vx*=0.2; }
    }

    const friction = driftActive ? 0.00135 : 0.0008;
    player.vx *= Math.pow(friction, dt);
    player.x += player.vx*dt;

    const minX = road.x + player.w*0.55;
    const maxX = road.x + road.w - player.w*0.55;
    player.x = clamp(player.x, minX, maxX);

    // spawn
    spawnTimer += dt * mode.spawnRate * (0.85 + effectiveSpeed/600);
    if(spawnTimer>=1){
      spawnTimer=0;
      spawnCar();
      if(modeKey!=="easy" && Math.random()<0.22) spawnCar();
      if(modeKey==="hard" && Math.random()<0.30) spawnCar();
    }

    coinTimer += dt * (0.62 + effectiveSpeed/980);
    if(coinTimer>=1){
      coinTimer=0;
      if(Math.random()<0.92) spawnCoin();
      if(modeKey!=="easy" && Math.random()<0.22) spawnCoin();
    }

    // move traffic + lane change
    for(let i=traffic.length-1;i>=0;i--){
      const t = traffic[i];
      t.y += effectiveSpeed*dt*t.rel;

      t.x += Math.sin((t.y/120)+t.seed*10)*dt*mode.wiggle*0.35;

      t.laneChangeCooldown -= dt;
      if(t.laneChangeCooldown <= 0 && Math.random() < mode.laneChangeRate){
        const dir = Math.random()<0.5 ? -1 : 1;
        const next = clamp(t.targetLane + dir, 0, laneCount-1);
        const safe = !traffic.some(o => o!==t && o.targetLane===next && Math.abs(o.y - t.y) < 120);
        if(safe) t.targetLane = next;
        t.laneChangeCooldown = lerp(mode.laneChangeCooldown[0], mode.laneChangeCooldown[1], Math.random());
      }
      const targetX = laneCenter(t.targetLane);
      t.x += (targetX - t.x) * dt * mode.laneChangeSpeed;

      if(t.y > H+170) traffic.splice(i,1);
    }

    // move coins
    for(let i=coins.length-1;i>=0;i--){
      const c = coins[i];
      c.y += effectiveSpeed*dt*0.90;
      c.spin += dt*8;
      c.x += (laneCenter(c.lane)-c.x)*dt*2.0;
      if(c.y > H+60) coins.splice(i,1);
    }

    // score (kept stable)
    score += dt*(effectiveSpeed*0.040);
    if(nitroActive) score += dt*18;
    if(driftActive && (steerLeft||steerRight)) score += dt*8;

    // close calls
    let closeThisFrame=false;
    for(const t of traffic){
      const d = distRect(player.x, player.y, player.w, player.h, t.x, t.y, t.w, t.h);
      if(d < 10 && d > 0){
        score += dt*42;
        closeThisFrame=true;
        if(Math.random()<0.05){
          const rect = canvas.getBoundingClientRect();
          popEmoji("üò≤", rect.left + rect.width*(player.x/W), rect.top + rect.height*(player.y/H));
        }
      }
    }
    if(closeThisFrame && Math.random()<0.10) sfx("whoosh");

    // collect coins
    for(let i=coins.length-1;i>=0;i--){
      const c=coins[i];
      if(rectHit(player.x, player.y, player.w*0.9, player.h*0.9, c.x, c.y, c.r*2, c.r*2)){
        coins.splice(i,1);
        runCoins += 1;
        score += 12;
        sfx("coin");
      }
    }

    // collision
    for(const t of traffic){
      if(rectHit(player.x, player.y, player.w, player.h, t.x, t.y, t.w, t.h)){
        handleCrash();
        break;
      }
    }

    // sparks update
    for(let i=sparks.length-1;i>=0;i--){
      const s=sparks[i];
      s.vy += 900*dt;
      s.x += s.vx*dt;
      s.y += s.vy*dt;
      s.life -= dt;
      if(s.life<=0) sparks.splice(i,1);
    }

    // best
    const sc = Math.floor(score);
    if(sc > (profile.bestScore || 0)){
      profile.bestScore = sc;
      saveProfile(profile);
    }

    syncUI();
  }

  function handleCrash(){
    lives -= 1;
    makeSparks(player.x, player.y, 40);
    if(lives > 0){
      // small penalty
      score = Math.max(0, score - 140);
      return;
    }
    crash();
  }

  function crash(){
    running=false;
    setEngine(false);
    sfx("crash");

    // bank coins
    profile.bankCoins = (profile.bankCoins || 0) + runCoins;
    runCoins = 0;
    saveProfile(profile);

    // show game over overlay
    screen="gameover";
    paused=true;
    gameoverEl.style.display="grid";
    goScoreEl.textContent = `Score ${Math.floor(score)} ‚Ä¢ Best ${profile.bestScore || 0}`;
    goMetaEl.textContent = `Bank ü™ô ${profile.bankCoins || 0} ‚Ä¢ Mode ${mode.name}`;
    syncUI();
  }

  // ===== Draw =====
  function draw(){
    drawRoad();

    for(const c of coins) drawCoin(c);
    for(const t of traffic) drawEnemyCar(t.x, t.y, t.w, t.h, t.seed);

    // always draw player (even on home) so the canvas feels alive
    drawPlayerCar(player.x, player.y, player.w, player.h);

    // sparks
    for(const s of sparks){
      ctx.globalAlpha = Math.max(0, Math.min(1, s.life/0.35));
      ctx.fillStyle = s.c;
      ctx.fillRect(s.x,s.y,3,3);
    }
    ctx.globalAlpha=1;

    // paused text only during game
    if(paused && screen==="game"){
      ctx.fillStyle="rgba(0,0,0,.32)";
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle="rgba(255,255,255,.92)";
      ctx.font="bold 44px system-ui, sans-serif";
      ctx.textAlign="center";
      ctx.fillText("PAUSED", W/2, H/2);
    }
  }

  // ===== loop =====
  function loop(now){
    const dt = Math.min(0.033, (now-last)/1000);
    last = now;

    update(dt);
    draw();

    requestAnimationFrame(loop);
  }

  // ===== init =====
  function init(){
    // load profile into homepage
    nameInput.value = profile.name || "Gamer";
    syncUI();

    // homepage visible FIRST (fix)
    showHome();

    // start render loop (idle animation only)
    requestAnimationFrame(loop);
  }

  init();
})();
</script>
</body>
</html>
