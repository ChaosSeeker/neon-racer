<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Neon Highway Racer ‚Äî Ultimate</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#050814; --panel:#0b1230; --text:#eaf0ff; --muted:#9fb0e6;
      --a:#7cffea; --p:#ff6adf; --g:#ffd24d; --r:#ff5a84;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family:Rajdhani,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 50% 15%, #1a2a7a 0%, var(--bg) 60%),
        radial-gradient(900px 500px at 10% 90%, rgba(255,106,223,.12), transparent 60%),
        radial-gradient(900px 500px at 90% 85%, rgba(124,255,234,.10), transparent 60%);
      color:var(--text);
      overflow-x:hidden;
    }
    .wrap{width:min(1140px, 95vw); margin:18px auto; display:grid; gap:14px;}

    .hero{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:
        linear-gradient(135deg, rgba(255,106,223,.18), rgba(124,255,234,.12)),
        rgba(11,18,48,.75);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .heroLeft{display:flex; flex-direction:column; gap:6px}
    .brand{
      font-family:Orbitron,system-ui,sans-serif;
      font-weight:900;
      letter-spacing:.8px;
      font-size:18px;
      margin:0;
      text-transform:uppercase;
    }
    .tagline{color:var(--muted); font-size:14px; margin:0}
    .heroRight{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .cta{
      cursor:pointer;
      border-radius:14px;
      padding:12px 14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      color:var(--text);
      font-weight:900;
      font-size:14px;
      transition:.15s transform,.15s background;
      user-select:none;
      font-family:Orbitron,system-ui,sans-serif;
    }
    .cta:hover{background:rgba(255,255,255,.12)}
    .cta:active{transform:translateY(1px)}
    .cta.primary{
      background:linear-gradient(135deg, rgba(124,255,234,.25), rgba(70,200,255,.18));
      border-color: rgba(124,255,234,.35);
    }
    .cta.danger{
      background:linear-gradient(135deg, rgba(255,90,132,.22), rgba(255,210,77,.12));
      border-color: rgba(255,90,132,.28);
    }

    header{
      background:rgba(11,18,48,.82);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px; padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .stats{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      padding:8px 12px; border-radius:999px; font-size:14px;
      display:flex; gap:6px; align-items:center;
      font-weight:700;
    }
    .pill b{font-family:Orbitron,system-ui,sans-serif; font-weight:900}
    .bar{
      width:120px; height:8px; border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > i{display:block; height:100%; width:50%; background:rgba(120,255,220,.85)}
    .btns{display:flex; gap:8px; flex-wrap:wrap}
    button{
      cursor:pointer; color:var(--text);
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      border-radius:12px; padding:10px 12px;
      font-weight:950; font-size:13px;
      transition:.15s transform,.15s background;
      user-select:none;
      font-family:Orbitron,system-ui,sans-serif;
      letter-spacing:.2px;
    }
    button:hover{background:rgba(255,255,255,.12)}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.55; cursor:not-allowed}

    .board{
      background:rgba(11,18,48,.62);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px; padding:12px;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    canvas{
      width:100%; height:auto; aspect-ratio:16/9;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      display:block; touch-action:none;
    }
    .help{
      margin-top:10px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color:var(--muted); font-size:14px;
    }
    .kbd{font-family: ui-monospace,SFMono-Regular,Menlo,monospace}

    .content{
      background:rgba(11,18,48,.55);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px; padding:14px;
      box-shadow:0 12px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      display:grid; gap:10px;
    }
    .grid2{display:grid; grid-template-columns: 1.2fr 1fr; gap:10px;}
    .card{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      border-radius:16px; padding:12px;
    }
    .card h3{
      margin:0 0 8px;
      font-size:14px;
      font-family:Orbitron,system-ui,sans-serif;
      letter-spacing:.4px;
      text-transform:uppercase;
    }
    .card p{margin:0; color:var(--muted); font-size:14px; line-height:1.5}
    .lbList{margin-top:8px; display:grid; gap:6px}
    .lbRow{
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      font-size:14px;
    }
    .lbRow b{font-family:Orbitron,system-ui,sans-serif; font-weight:900}
    @media (max-width:900px){ .grid2{grid-template-columns:1fr} }

    .links{display:flex; gap:10px; flex-wrap:wrap}
    .links a{color:var(--a); text-decoration:none; font-weight:900; font-size:14px}
    .links a:hover{text-decoration:underline}

    .missions{
      margin-top:10px;
      display:grid; gap:8px;
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
    .mCard{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px;
      font-size:14px;
    }
    .mCard b{font-family:Orbitron,system-ui,sans-serif; font-weight:900}
    .mBar{
      margin-top:8px;
      height:8px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .mBar i{display:block; height:100%; width:20%; background:rgba(255,210,77,.9)}
    @media (max-width:900px){ .missions{grid-template-columns:1fr} }

    .streakGrid{
      display:grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap:8px;
      margin-top:10px;
    }
    .dayBox{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px 8px;
      text-align:center;
      font-size:13px;
    }
    .dayBox .d{font-family:Orbitron,system-ui,sans-serif; font-weight:900; opacity:.9}
    .dayBox .v{margin-top:4px; color:var(--muted)}
    .dayBox.claimed{
      background:linear-gradient(135deg, rgba(124,255,234,.18), rgba(255,210,77,.10));
      border-color: rgba(124,255,234,.28);
    }
    .dayBox.next{
      outline:2px solid rgba(255,210,77,.55);
      outline-offset:2px;
    }

    .garageGrid{
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .skin{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:132px;
    }
    .skinTop{display:flex; justify-content:space-between; align-items:center; gap:8px}
    .skinName{font-family:Orbitron,system-ui,sans-serif; font-weight:900; font-size:12px}
    .skinMeta{font-size:11px; color:var(--muted); font-weight:800; text-align:right}
    .swatch{
      height:46px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      position:relative;
      overflow:hidden;
    }
    .swatch::after{
      content:"";
      position:absolute; inset:-20%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.16), transparent 55%);
      transform: rotate(18deg);
    }
    .skinActions{display:flex; gap:8px; flex-wrap:wrap; margin-top:auto}
    .miniBtn{padding:8px 10px; border-radius:12px; font-size:12px;}
    @media (max-width:980px){ .garageGrid{grid-template-columns:1fr 1fr 1fr} }
    @media (max-width:520px){ .garageGrid{grid-template-columns:1fr 1fr} }

    .mobileControls{
      display:none; margin-top:10px; gap:10px; flex-wrap:wrap;
      justify-content:space-between; align-items:center;
      user-select:none;
    }
    .pad{display:flex; gap:10px; align-items:center}
    .big{padding:14px 16px; border-radius:16px; font-size:14px; min-width:92px; text-align:center;}
    @media (max-width:760px){ .mobileControls{display:flex} }

    .overlay{
      position:fixed; inset:0;
      display:none; place-items:center;
      background:rgba(0,0,0,.58);
      backdrop-filter: blur(6px);
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(920px, 94vw);
      background:rgba(11,18,48,.94);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      padding:16px;
      box-shadow:0 24px 70px rgba(0,0,0,.6);
      position:relative;
      overflow:hidden;
    }
    .modal h2{
      margin:0 0 8px;
      font-family:Orbitron,system-ui,sans-serif;
      letter-spacing:.5px;
      text-transform:uppercase;
      font-size:18px;
    }
    .modal p{margin:0 0 12px; color:var(--muted); line-height:1.5; font-size:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .emojiLayer{position:fixed; inset:0; pointer-events:none; z-index:80;}
    .emojiPop{
      position:absolute;
      transform: translate(-50%, -50%) scale(1);
      font-size:44px;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.45));
      will-change: transform, opacity;
    }

    body.playing .wrap{width:100vw; height:100vh; max-width:none; margin:0; gap:0}
    body.playing .hero, body.playing .content{display:none}
    body.playing header{border-radius:0; border-left:0; border-right:0}
    body.playing .board{border-radius:0; border-left:0; border-right:0; height:calc(100vh - 76px)}
    body.playing canvas{aspect-ratio:auto; height:100%; width:100%; border-radius:0}
    @media (max-width:760px){
      body.playing .board{height:calc(100vh - 110px)}
    }

    /* ===== Crate Animation ===== */
    .crateStage{
      display:grid;
      place-items:center;
      padding:22px 10px 8px;
    }
    .crateBox{
      width:min(420px, 86vw);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(700px 250px at 50% 20%, rgba(255,210,77,.20), transparent 60%),
        radial-gradient(700px 250px at 50% 85%, rgba(255,106,223,.18), transparent 60%),
        rgba(0,0,0,.22);
      box-shadow: 0 20px 70px rgba(0,0,0,.55);
      padding:16px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .crateBox::before{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 90deg, rgba(255,210,77,.35), rgba(124,255,234,.25), rgba(255,106,223,.25), rgba(255,210,77,.35));
      filter: blur(10px);
      animation: spin 1.7s linear infinite;
      opacity:.55;
    }
    .crateBox > *{position:relative}
    @keyframes spin{ to{ transform: rotate(360deg);} }

    .jackpot{
      font-family:Orbitron,system-ui,sans-serif;
      font-weight:900;
      letter-spacing:.8px;
      margin:8px 0 6px;
      font-size:18px;
      text-transform:uppercase;
    }
    .sparkleLine{color:rgba(255,255,255,.75); font-weight:800; margin:0 0 14px}
    .revealCard{
      margin:12px auto 8px;
      width:min(320px, 80vw);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      padding:12px;
      display:none;
      transform: translateY(10px) scale(.98);
      opacity:0;
      animation: popin .55s ease forwards;
    }
    @keyframes popin{
      to{ opacity:1; transform: translateY(0) scale(1); }
    }
    .revealSwatch{
      height:56px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      margin-top:10px;
      position:relative;
      overflow:hidden;
    }
    .burst{
      position:absolute;
      left:50%; top:50%;
      width:8px; height:8px;
      border-radius:999px;
      background:rgba(255,255,255,.85);
      box-shadow:
        0 -120px 0 rgba(255,210,77,.85),
        90px -90px 0 rgba(124,255,234,.75),
        120px 0 0 rgba(255,106,223,.75),
        90px 90px 0 rgba(255,210,77,.75),
        0 120px 0 rgba(124,255,234,.75),
        -90px 90px 0 rgba(255,106,223,.70),
        -120px 0 0 rgba(255,210,77,.75),
        -90px -90px 0 rgba(124,255,234,.70);
      transform: translate(-50%,-50%) scale(.1);
      opacity:0;
      animation: burst 0.7s ease forwards;
      display:none;
    }
    @keyframes burst{
      40%{opacity:1}
      to{transform: translate(-50%,-50%) scale(1.15); opacity:0}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="hero">
      <div class="heroLeft">
        <h1 class="brand">NEON HIGHWAY RACER</h1>
        <p class="tagline">2 Lives ‚Ä¢ Revive ‚Ä¢ Bonus Levels ‚Ä¢ Buff Pickups ‚Ä¢ Garage Rarities ‚Ä¢ Daily Crate ‚Ä¢ Weekly & All-Time Leaderboards</p>
      </div>
      <div class="heroRight">
        <button class="cta primary" id="homePlay">PLAY</button>
        <button class="cta" id="homeOpenShop">SHOP</button>
        <button class="cta" id="homeOpenGarage">GARAGE</button>
        <button class="cta danger" id="homeOpenBoards">LEADERBOARDS</button>
      </div>
    </div>

    <header>
      <div class="stats">
        <div class="pill">Player: <b id="playerName">Gamer</b></div>
        <div class="pill">Score: <b id="score">0</b></div>
        <div class="pill">Best: <b id="best">0</b></div>
        <div class="pill">Lives: <b id="lives">2</b></div>
        <div class="pill">Mode: <b id="mode">Easy</b></div>
        <div class="pill" title="Nitro">
          Nitro:
          <span class="bar"><i id="nitroFill"></i></span>
        </div>
        <div class="pill">Run ü™ô: <b id="runCoins">0</b></div>
        <div class="pill">Bank ü™ô: <b id="bankCoins">0</b></div>
      </div>

      <div class="btns">
        <button id="pauseBtn" title="Pause/Resume (Space)">PAUSE</button>
        <button id="restartBtn" title="Restart (R)">RESTART</button>
        <button id="feedbackBtn" title="Send feedback via Instagram DM">FEEDBACK</button>
      </div>
    </header>

    <div class="board">
      <canvas id="game" width="960" height="540"></canvas>

      <div class="help">
        <div>
          Controls: <span class="kbd">‚Üê ‚Üí</span>/<span class="kbd">A D</span> steer ‚Ä¢
          <span class="kbd">‚Üë</span>/<span class="kbd">W</span> nitro ‚Ä¢
          <span class="kbd">Shift</span> drift ‚Ä¢
          <span class="kbd">Space</span> pause ‚Ä¢ <span class="kbd">R</span> restart
        </div>
        <div>Mobile: buttons below (or swipe left/right; swipe up = nitro)</div>
      </div>

      <div class="mobileControls">
        <div class="pad">
          <button class="big" id="mLeft">‚óÄ Left</button>
          <button class="big" id="mRight">Right ‚ñ∂</button>
        </div>
        <div class="pad">
          <button class="big" id="mDrift">‚ö° Drift</button>
          <button class="big" id="mNitro">üöÄ Nitro</button>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="grid2">
        <div class="card">
          <h3>Player</h3>
          <p style="margin-bottom:10px">Set your name (saved on this browser) and claim daily rewards.</p>
          <div class="row">
            <input id="nameInput" maxlength="18" placeholder="e.g., Gamer" autocomplete="off" inputmode="text"
              style="flex:1; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.22); color:var(--text); font-weight:800;" />
            <button id="saveNameBtn">SAVE</button>
            <button id="resetNameBtn">RESET</button>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="claimBtn">CLAIM DAILY BONUS</button>
            <span class="pill">Next: <b id="bonusText">‚Äî</b></span>
            <label class="pill" style="cursor:pointer"><input id="musicToggle" type="checkbox" checked style="accent-color:#6ff;cursor:pointer" /> Music</label>
            <label class="pill" style="cursor:pointer"><input id="sfxToggle" type="checkbox" checked style="accent-color:#6ff;cursor:pointer" /> SFX</label>
          </div>

          <div class="card" style="margin-top:10px">
            <h3>7-Day Streak Calendar</h3>
            <p>Claim once per day for 7 days. Rewards increase each day.</p>
            <div class="streakGrid" id="streakGrid"></div>
          </div>
        </div>

        <div class="card">
          <h3>Difficulty</h3>
          <p style="margin-bottom:10px">Choose a mode before you play.</p>
          <div class="row" id="modeRow"></div>

          <div class="card" style="margin-top:10px">
            <h3>How to Play</h3>
            <p>
              Dodge cars, avoid lane obstacles, grab coins & buffs. You have <b>2 lives</b> each run.
              Bonus Level is <b>12 seconds</b> and starts at <b>500 points</b> (then +1000 after bonus ends).
              üéÅ Gift car gives 500‚Äì600 coins.
            </p>
          </div>

          <div class="card" style="margin-top:10px">
            <h3>Contact</h3>
            <p>Tap FEEDBACK to message <b>@daily__discipline.01</b> via Instagram DM.</p>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Daily Missions (3)</h3>
        <p>Complete missions to earn extra coins. Missions reset daily.</p>
        <div class="missions" id="missions"></div>
      </div>

      <div class="grid2">
        <div class="card">
          <h3>Leaderboards</h3>
          <p id="lbStatus">Loading‚Ä¶</p>
          <div class="grid2" style="margin-top:10px">
            <div class="card">
              <h3>Weekly Top 10</h3>
              <div class="lbList" id="lbWeekly"></div>
              <p class="small" style="margin-top:8px;color:var(--muted)">
                Weekly resets automatically (new week bucket).
              </p>
            </div>
            <div class="card">
              <h3>All-Time Top 10</h3>
              <div class="lbList" id="lbAllTime"></div>
            </div>
          </div>
        </div>

        <div class="card" id="shopCard">
          <h3>Shop</h3>
          <p>Buy buffs before a run. Applies to the next run.</p>
          <div class="row" style="margin-top:10px">
            <button id="openShopBtn">OPEN SHOP</button>
            <span class="pill">Bank ü™ô: <b id="menuBank">0</b></span>
          </div>
        </div>
      </div>

      <div class="card" id="garageCard">
        <h3>Garage</h3>
        <p>Buy skins with coins (legendary = 5000). Daily crate gives a random skin (no legendary).</p>
        <div class="row" style="margin-top:10px">
          <button id="crateBtn">OPEN DAILY CRATE</button>
          <span class="pill">Crate: <b id="crateStatus">‚Äî</b></span>
        </div>
        <div class="garageGrid" id="garageGrid"></div>
        <p style="margin-top:10px;color:var(--muted)">
          Duplicate crate skin = coins instead.
        </p>
      </div>

      <div class="card">
        <h3>Policy Pages</h3>
        <div class="links">
          <a href="#privacy">Privacy</a>
          <a href="#terms">Terms</a>
        </div>
      </div>

      <div class="card" id="privacy">
        <h3>Privacy Policy</h3>
        <p>
          This game stores your player name, best score, coins, skins, and mission progress in your browser (localStorage).
          If online leaderboards are enabled, your name + best score (and weekly score) are sent to the leaderboard database.
        </p>
      </div>

      <div class="card" id="terms">
        <h3>Terms</h3>
        <p>This is a browser game for entertainment. Scores may vary across devices/browsers.</p>
      </div>
    </div>

  </div>

  <div class="overlay" id="shopModal">
    <div class="modal">
      <h2>Shop</h2>
      <p>Buy buffs for the next run. Bank coins are deducted instantly.</p>
      <div class="row">
        <button id="shopClose">CLOSE</button>
      </div>
      <div style="margin-top:12px; display:grid; gap:10px; grid-template-columns: repeat(5, minmax(0,1fr));" id="shopGrid"></div>
      <p style="margin-top:10px; color:var(--muted)">
        Shield blocks 1 crash ‚Ä¢ Magnet 7s ‚Ä¢ Slow-mo slows obstacles 5√ó ‚Ä¢ Invisibility phases ‚Ä¢ Extra life adds +1 (max +2)
      </p>
    </div>
  </div>

  <div class="overlay" id="gameOverModal">
    <div class="modal">
      <h2>Game Over</h2>
      <p id="gameOverText">Your run ended.</p>
      <div class="row" style="margin-top:10px">
        <button id="reviveBtn">REVIVE (100 ü™ô)</button>
        <button id="shareBtn">SHARE</button>
        <button id="backHomeBtn">BACK TO HOME</button>
      </div>
    </div>
  </div>

  <!-- Crate Animation Modal -->
  <div class="overlay" id="crateModal">
    <div class="modal">
      <h2>Daily Crate</h2>
      <p id="crateLine">Spinning‚Ä¶</p>
      <div class="crateStage">
        <div class="crateBox">
          <div class="jackpot" id="crateTitle">üé∞ JACKPOT SPIN</div>
          <p class="sparkleLine" id="crateSub">Good luck, racer‚Ä¶</p>
          <div class="burst" id="crateBurst"></div>

          <div class="revealCard" id="crateReveal">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
              <div style="font-family:Orbitron,system-ui,sans-serif;font-weight:900" id="revealName">‚Äî</div>
              <div style="font-weight:900;color:var(--muted)" id="revealRarity">‚Äî</div>
            </div>
            <div class="revealSwatch" id="revealSwatch"></div>
            <div style="margin-top:10px;color:var(--muted);font-weight:900" id="revealMsg">‚Äî</div>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="crateCloseBtn">CLOSE</button>
      </div>
    </div>
  </div>

  <div class="emojiLayer" id="emojiLayer"></div>

<script>
(() => {
  // =========================
  // SUPABASE CONFIG
  // =========================
  const SUPABASE_URL = "https://dnyibstgahnjbkjokuxs.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_1PLhDg4aoFucc0-7qWH0KA_unYKueat";

  const SB = {
    enabled: () => Boolean(SUPABASE_URL && SUPABASE_ANON_KEY),
    headers: () => ({
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json",
      "Prefer": "return=representation"
    }),
    async upsertAllTime(name, score){
      if (!this.enabled()) return;
      const body = [{ name, score, updated_at: new Date().toISOString() }];
      await fetch(`${SUPABASE_URL}/rest/v1/leaderboard?on_conflict=name`, {
        method: "POST",
        headers: { ...this.headers(), "Prefer": "resolution=merge-duplicates,return=minimal" },
        body: JSON.stringify(body)
      });
    },
    async top10AllTime(){
      if (!this.enabled()) return null;
      const res = await fetch(`${SUPABASE_URL}/rest/v1/leaderboard?select=name,score&order=score.desc&limit=10`, { headers: this.headers() });
      if (!res.ok) throw new Error("alltime_fetch_failed");
      return await res.json();
    },
    async upsertWeekly(weekStartISO, name, score){
      if (!this.enabled()) return;
      const body = [{ week_start: weekStartISO, name, score, updated_at: new Date().toISOString() }];
      await fetch(`${SUPABASE_URL}/rest/v1/leaderboard_weekly?on_conflict=week_start,name`, {
        method: "POST",
        headers: { ...this.headers(), "Prefer": "resolution=merge-duplicates,return=minimal" },
        body: JSON.stringify(body)
      });
    },
    async top10Weekly(weekStartISO){
      if (!this.enabled()) return null;
      const q = encodeURIComponent(`week_start=eq.${weekStartISO}`);
      const res = await fetch(`${SUPABASE_URL}/rest/v1/leaderboard_weekly?select=name,score&${q}&order=score.desc&limit=10`, { headers: this.headers() });
      if (!res.ok) throw new Error("weekly_fetch_failed");
      return await res.json();
    }
  };

  // ===== DOM =====
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;

  const playerNameEl = document.getElementById("playerName");
  const scoreEl = document.getElementById("score");
  const bestEl  = document.getElementById("best");
  const livesEl = document.getElementById("lives");
  const modeEl  = document.getElementById("mode");
  const nitroFill = document.getElementById("nitroFill");
  const runCoinsEl = document.getElementById("runCoins");
  const bankCoinsEl = document.getElementById("bankCoins");
  const pauseBtn = document.getElementById("pauseBtn");
  const restartBtn = document.getElementById("restartBtn");
  const feedbackBtn = document.getElementById("feedbackBtn");

  const homePlay = document.getElementById("homePlay");
  const homeOpenShop = document.getElementById("homeOpenShop");
  const homeOpenGarage = document.getElementById("homeOpenGarage");
  const homeOpenBoards = document.getElementById("homeOpenBoards");

  const nameInput = document.getElementById("nameInput");
  const saveNameBtn = document.getElementById("saveNameBtn");
  const resetNameBtn = document.getElementById("resetNameBtn");

  const claimBtn = document.getElementById("claimBtn");
  const bonusText = document.getElementById("bonusText");
  const streakGrid = document.getElementById("streakGrid");

  const missionsEl = document.getElementById("missions");

  const lbStatusEl = document.getElementById("lbStatus");
  const lbAllTimeEl = document.getElementById("lbAllTime");
  const lbWeeklyEl = document.getElementById("lbWeekly");

  const shopModal = document.getElementById("shopModal");
  const shopClose = document.getElementById("shopClose");
  const shopGrid  = document.getElementById("shopGrid");
  const openShopBtn = document.getElementById("openShopBtn");
  const menuBank = document.getElementById("menuBank");

  const garageGrid = document.getElementById("garageGrid");
  const crateBtn = document.getElementById("crateBtn");
  const crateStatus = document.getElementById("crateStatus");

  const gameOverModal = document.getElementById("gameOverModal");
  const gameOverText = document.getElementById("gameOverText");
  const reviveBtn = document.getElementById("reviveBtn");
  const shareBtn = document.getElementById("shareBtn");
  const backHomeBtn = document.getElementById("backHomeBtn");

  const musicToggle = document.getElementById("musicToggle");
  const sfxToggle = document.getElementById("sfxToggle");

  const crateModal = document.getElementById("crateModal");
  const crateCloseBtn = document.getElementById("crateCloseBtn");
  const crateLine = document.getElementById("crateLine");
  const crateTitle = document.getElementById("crateTitle");
  const crateSub = document.getElementById("crateSub");
  const crateBurst = document.getElementById("crateBurst");
  const crateReveal = document.getElementById("crateReveal");
  const revealName = document.getElementById("revealName");
  const revealRarity = document.getElementById("revealRarity");
  const revealSwatch = document.getElementById("revealSwatch");
  const revealMsg = document.getElementById("revealMsg");

  const emojiLayer = document.getElementById("emojiLayer");

  const mLeft = document.getElementById("mLeft");
  const mRight = document.getElementById("mRight");
  const mNitro = document.getElementById("mNitro");
  const mDrift = document.getElementById("mDrift");

  // ===== helpers =====
  const clamp = (v,a,b)=>Math.max(a, Math.min(b, v));
  const randInt = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const lerp = (a,b,t)=> a + (b-a)*t;

  function todayISO(){
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }
  function weekStartISO(d=new Date()){
    const x = new Date(d);
    x.setHours(0,0,0,0);
    const day = x.getDay();
    const diff = (day === 0) ? 6 : (day - 1);
    x.setDate(x.getDate() - diff);
    return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,"0")}-${String(x.getDate()).padStart(2,"0")}`;
  }
  function rectHit(ax,ay,aw,ah, bx,by,bw,bh){
    const aL = ax-aw/2, aR = ax+aw/2, aT = ay-ah/2, aB = ay+ah/2;
    const bL = bx-bw/2, bR = bx+bw/2, bT = by-bh/2, bB = by+bh/2;
    return (aL < bR && aR > bL && aT < bB && aB > bT);
  }
  function distRect(ax,ay,aw,ah, bx,by,bw,bh){
    const aL = ax-aw/2, aR = ax+aw/2, aT = ay-ah/2, aB = ay+ah/2;
    const bL = bx-bw/2, bR = bx+bw/2, bT = by-bh/2, bB = by+bh/2;
    const dx = Math.max(bL - aR, aL - bR, 0);
    const dy = Math.max(bT - aB, aT - bB, 0);
    return Math.hypot(dx, dy);
  }

  // ===== Difficulty =====
  const MODES = {
    easy:   { name:"Easy",   baseSpeed: 220, accel: 9.0, spawnRate: 0.85, maxTraffic: 7,  wiggle: 26,
              trafficRelMin:0.62, trafficRelMax:1.02, laneChangeRate: 0.055, laneChangeSpeed: 3.4, laneChangeCooldown:[1.2, 2.2] },
    medium: { name:"Medium", baseSpeed: 285, accel: 12.0,spawnRate: 1.10, maxTraffic: 11, wiggle: 54,
              trafficRelMin:0.66, trafficRelMax:1.18, laneChangeRate: 0.105, laneChangeSpeed: 5.6, laneChangeCooldown:[0.75, 1.45] },
    hard:   { name:"Hard",   baseSpeed: 340, accel: 15.2,spawnRate: 1.40, maxTraffic: 15, wiggle: 78,
              trafficRelMin:0.70, trafficRelMax:1.28, laneChangeRate: 0.165, laneChangeSpeed: 7.4, laneChangeCooldown:[0.50, 1.10] },
  };

  // ===== Road/Lanes =====
  const road = { x: W*0.18, w: W*0.64, y: 0, h: H };
  const laneCount = 3;
  const laneW = road.w / laneCount;
  const laneCenter = (lane)=> road.x + laneW*(lane + 0.5);
  const WALL_MARGIN = 18;

  // ===== Profile =====
  const PROFILE_KEY = "neon_racer_profile_v6";
  function loadProfile(){
    try{ return JSON.parse(localStorage.getItem(PROFILE_KEY) || "null"); } catch { return null; }
  }
  function saveProfile(p){ localStorage.setItem(PROFILE_KEY, JSON.stringify(p)); }

  // Rarity palette (also used for underglow)
  const RARITY = {
    common:   { name:"Common",   glow:"rgba(124,255,234,.55)", chip:"rgba(124,255,234,.22)" },
    rare:     { name:"Rare",     glow:"rgba(70,200,255,.60)",  chip:"rgba(70,200,255,.22)" },
    epic:     { name:"Epic",     glow:"rgba(255,106,223,.62)", chip:"rgba(255,106,223,.22)" },
    legendary:{ name:"Legendary",glow:"rgba(255,210,77,.68)",  chip:"rgba(255,210,77,.22)" },
  };

  // ‚úÖ more skins + legendary price = 5000
  const SKINS = [
    { id:"stock",    name:"Stock Neon",  cost:0,    rarity:"common",   grad:["#46c8ff","#7cffea"] },

    { id:"midnight", name:"Midnight",    cost:600,  rarity:"common",   grad:["#2b2f52","#6a7cff"] },
    { id:"storm",    name:"Storm Runner",cost:650,  rarity:"common",   grad:["#3a465e","#46c8ff"] },
    { id:"ember",    name:"Ember",       cost:700,  rarity:"common",   grad:["#ff7a3a","#ffd24d"] },
    { id:"aqua",     name:"Aqua Blade",  cost:800,  rarity:"common",   grad:["#7cffea","#2f6cff"] },

    { id:"inferno",  name:"Inferno",     cost:900,  rarity:"rare",     grad:["#ff5a84","#ffd24d"] },
    { id:"toxic",    name:"Toxic Lime",  cost:1050, rarity:"rare",     grad:["#a6ff4d","#7cffea"] },
    { id:"ice",      name:"Ice Pulse",   cost:1200, rarity:"rare",     grad:["#c7f2ff","#46c8ff"] },
    { id:"violet",   name:"Violet Viper",cost:1350, rarity:"rare",     grad:["#b06cff","#ff6adf"] },

    { id:"royal",    name:"Royal Pulse", cost:1700, rarity:"epic",     grad:["#7a5cff","#46c8ff"] },
    { id:"sakura",   name:"Sakura Rush", cost:1900, rarity:"epic",     grad:["#ff6adf","#7cffea"] },
    { id:"neonburn", name:"Neon Burn",   cost:2200, rarity:"epic",     grad:["#ff5a84","#46c8ff"] },
    { id:"holo",     name:"Holo Shift",  cost:2600, rarity:"epic",     grad:["#7cffea","#ff6adf"] },

    { id:"carbon",   name:"Carbon",      cost:5000, rarity:"legendary",grad:["#2a2f3a","#8899aa"] },
    { id:"aurum",    name:"Aurum",       cost:5000, rarity:"legendary",grad:["#ffd24d","#ff5a84"] },
  ];

  let profile = loadProfile() || {
    name: "Gamer",
    bestScore: 0,
    bankCoins: 0,
    streakDaysClaimed: 0,
    lastBonusDate: null,
    missionsDate: null,
    missions: [],
    ownedSkins: ["stock"],
    selectedSkin: "stock",
    lastCrateDate: null,
  };

  function dailyBonusForDay(n){ return 40 + n*10; }
  function bonusPreview(){
    if (profile.streakDaysClaimed >= 7) return "Completed";
    const day = profile.streakDaysClaimed + 1;
    return `+${dailyBonusForDay(day)} (Day ${day}/7)`;
  }
  function claimDailyBonus(){
    const t = todayISO();
    if (profile.lastBonusDate === t) return { ok:false, msg:"Already claimed today." };
    if (profile.streakDaysClaimed >= 7){
      profile.lastBonusDate = t;
      saveProfile(profile);
      return { ok:false, msg:"7-day bonus completed." };
    }
    const day = profile.streakDaysClaimed + 1;
    const amount = dailyBonusForDay(day);
    profile.bankCoins += amount;
    profile.streakDaysClaimed += 1;
    profile.lastBonusDate = t;
    saveProfile(profile);
    return { ok:true, msg:`+${amount} coins (Day ${day}/7)` };
  }

  function updateHeaderUI(){
    playerNameEl.textContent = profile.name || "Gamer";
    bestEl.textContent = profile.bestScore || 0;
    bankCoinsEl.textContent = profile.bankCoins || 0;
    menuBank.textContent = profile.bankCoins || 0;
    bonusText.textContent = bonusPreview();
  }

  function renderStreak(){
    streakGrid.innerHTML = "";
    const claimed = clamp(profile.streakDaysClaimed, 0, 7);
    for(let i=1;i<=7;i++){
      const div = document.createElement("div");
      div.className = "dayBox" + (i<=claimed ? " claimed" : "") + (i===claimed+1 && claimed<7 ? " next":"");
      div.innerHTML = `<div class="d">Day ${i}</div><div class="v">+${dailyBonusForDay(i)}ü™ô</div>`;
      streakGrid.appendChild(div);
    }
  }

  // ===== Missions =====
  function newMission(){
    const types = ["passCars","collectCoins","closeCalls"];
    const type = types[randInt(0, types.length-1)];
    if (type === "passCars"){
      const target = [10, 15, 20, 25][randInt(0,3)];
      const reward = Math.round(target * 1.1);
      return { type, target, progress:0, reward, claimed:false };
    }
    if (type === "collectCoins"){
      const target = [20, 25, 30, 40][randInt(0,3)];
      const reward = Math.round(target * 0.9);
      return { type, target, progress:0, reward, claimed:false };
    }
    const target = [4, 6, 8][randInt(0,2)];
    const reward = target * 8;
    return { type, target, progress:0, reward, claimed:false };
  }
  function ensureDailyMissions(){
    const t = todayISO();
    if (profile.missionsDate === t && Array.isArray(profile.missions) && profile.missions.length === 3) return;
    const ms = [];
    while (ms.length < 3){
      const m = newMission();
      if (!ms.some(x => x.type === m.type)) ms.push(m);
      else if (Math.random() < 0.35) ms.push(m);
    }
    profile.missionsDate = t;
    profile.missions = ms.slice(0,3);
    saveProfile(profile);
  }
  function missionTitle(m){
    if (m.type === "passCars") return `Pass ${m.target} cars`;
    if (m.type === "collectCoins") return `Collect ${m.target} coins`;
    return `Close calls ${m.target} times`;
  }
  function renderMissions(){
    missionsEl.innerHTML = "";
    for (let i=0;i<profile.missions.length;i++){
      const m = profile.missions[i];
      const pct = Math.round(clamp((m.progress / m.target), 0, 1) * 100);
      const div = document.createElement("div");
      div.className = "mCard";
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <div><b>${missionTitle(m)}</b><div style="color:var(--muted)">${m.progress}/${m.target}</div></div>
          <div style="text-align:right">
            <div><b>+${m.reward} ü™ô</b></div>
            <button data-claim="${i}" class="miniBtn" style="margin-top:6px" ${m.claimed || m.progress < m.target ? "disabled" : ""}>
              ${m.claimed ? "CLAIMED" : (m.progress < m.target ? "IN PROGRESS" : "CLAIM")}
            </button>
          </div>
        </div>
        <div class="mBar"><i style="width:${pct}%"></i></div>
      `;
      missionsEl.appendChild(div);
    }

    missionsEl.querySelectorAll("button[data-claim]").forEach(btn => {
      btn.addEventListener("click", () => {
        const idx = Number(btn.getAttribute("data-claim"));
        const m = profile.missions[idx];
        if (!m || m.claimed || m.progress < m.target) return;
        m.claimed = true;
        profile.bankCoins += m.reward;
        saveProfile(profile);
        updateHeaderUI();
        renderMissions();
        renderGarage();
        renderShop();
      });
    });
  }

  // ===== Feedback DM =====
  function openInstagramDM(username){
    const deep = `instagram://direct/new?username=${encodeURIComponent(username)}`;
    const web1 = `https://ig.me/m/${encodeURIComponent(username)}`;
    const web2 = `https://www.instagram.com/direct/new/?username=${encodeURIComponent(username)}`;
    const a = document.createElement("a");
    a.href = deep; a.style.display = "none";
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(() => {
      const w = window.open(web1, "_blank", "noopener,noreferrer");
      if (!w) window.location.href = web2;
    }, 250);
  }
  feedbackBtn.addEventListener("click", () => openInstagramDM("daily__discipline.01"));

  // ===== Audio (unchanged) =====
  let audioCtx=null, master=null, musicGain=null, song=null;
  function ensureAudio(){
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    master = audioCtx.createGain(); master.gain.value = 0.40;
    master.connect(audioCtx.destination);
    musicGain = audioCtx.createGain(); musicGain.gain.value = musicToggle.checked ? 0.25 : 0.0;
    musicGain.connect(master);
    song = createEnergeticSong(audioCtx, musicGain);
    song.start();
  }
  function createEnergeticSong(ctx, out){
    const tempo = 136;
    const beat = 60/tempo;
    const step = beat/2;
    const state = { t: ctx.currentTime, timer:null, on:true };
    const bus = ctx.createGain(); bus.gain.value = 0.95;
    const comp = ctx.createDynamicsCompressor();
    comp.threshold.value=-18; comp.knee.value=20; comp.ratio.value=6;
    comp.attack.value=0.005; comp.release.value=0.1;
    const lp = ctx.createBiquadFilter();
    lp.type="lowpass"; lp.frequency.value=1500;
    bus.connect(comp); comp.connect(lp); lp.connect(out);

    const base = 220;
    const scale = [0,2,3,5,7,10];
    const prog = [0,0,-2,-2,-5,-5,-2,-2];
    const freq = (semi)=> base * Math.pow(2, semi/12);

    function kick(t){
      const o=ctx.createOscillator(); const g=ctx.createGain();
      o.type="sine";
      o.frequency.setValueAtTime(155,t);
      o.frequency.exponentialRampToValueAtTime(50,t+0.09);
      g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(0.75,t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001,t+0.12);
      o.connect(g); g.connect(bus);
      o.start(t); o.stop(t+0.14);
    }
    function snare(t){
      const dur=0.09;
      const buffer=ctx.createBuffer(1, ctx.sampleRate*dur, ctx.sampleRate);
      const data=buffer.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*Math.exp(-i/(data.length/3));
      const src=ctx.createBufferSource(); src.buffer=buffer;
      const bp=ctx.createBiquadFilter(); bp.type="bandpass"; bp.frequency.value=1800; bp.Q.value=0.9;
      const g=ctx.createGain();
      g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(0.35,t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
      src.connect(bp); bp.connect(g); g.connect(bus);
      src.start(t); src.stop(t+dur);
    }
    function hat(t){
      const dur=0.03;
      const buffer=ctx.createBuffer(1, ctx.sampleRate*dur, ctx.sampleRate);
      const data=buffer.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*Math.exp(-i/(data.length/2));
      const src=ctx.createBufferSource(); src.buffer=buffer;
      const hp=ctx.createBiquadFilter(); hp.type="highpass"; hp.frequency.value=6500;
      const g=ctx.createGain();
      g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(0.16,t+0.005);
      g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
      src.connect(hp); hp.connect(g); g.connect(bus);
      src.start(t); src.stop(t+dur);
    }
    function bass(t, semi){
      const o=ctx.createOscillator(); const g=ctx.createGain();
      const f=ctx.createBiquadFilter();
      o.type="square";
      o.frequency.setValueAtTime(freq(semi-12),t);
      f.type="lowpass"; f.frequency.value=300;
      g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(0.22,t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001,t+step*1.8);
      o.connect(f); f.connect(g); g.connect(bus);
      o.start(t); o.stop(t+step*2);
    }
    function lead(t, semi){
      const o=ctx.createOscillator(); const g=ctx.createGain();
      o.type="sawtooth";
      o.frequency.setValueAtTime(freq(semi+12),t);
      g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(0.10,t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001,t+step*1.6);
      o.connect(g); g.connect(bus);
      o.start(t); o.stop(t+step*1.7);
    }
    function schedule(){
      if (!state.on) return;
      const now=ctx.currentTime;
      while(state.t < now + 0.14){
        const n = Math.round(state.t / step);
        const barPos = Math.floor(n/2) % prog.length;
        if (n % 4 === 0) kick(state.t);
        if (n % 8 === 4) snare(state.t);
        if (n % 2 === 1) hat(state.t);
        if (n % 2 === 0) bass(state.t, prog[barPos]);
        if (n % 4 === 2){
          const idx=(barPos+2)%scale.length;
          lead(state.t, scale[idx] + prog[barPos]);
        }
        state.t += step;
      }
      state.timer = setTimeout(schedule, 50);
    }
    return { start(){ state.on=true; state.t=ctx.currentTime; schedule(); },
             stop(){ state.on=false; if(state.timer) clearTimeout(state.timer); } };
  }
  function sfx(type){
    if (!sfxToggle.checked) return;
    ensureAudio();
    const t0 = audioCtx.currentTime;
    const g = audioCtx.createGain(); g.connect(master);
    if (type==="coin"){
      const o=audioCtx.createOscillator();
      o.type="square";
      o.frequency.setValueAtTime(980,t0);
      o.frequency.exponentialRampToValueAtTime(1560,t0+0.06);
      g.gain.setValueAtTime(0.0001,t0);
      g.gain.exponentialRampToValueAtTime(0.22,t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001,t0+0.12);
      o.connect(g); o.start(t0); o.stop(t0+0.13);
      return;
    }
    if (type==="pickup"){
      const o=audioCtx.createOscillator();
      o.type="triangle";
      o.frequency.setValueAtTime(540,t0);
      o.frequency.exponentialRampToValueAtTime(860,t0+0.08);
      g.gain.setValueAtTime(0.0001,t0);
      g.gain.exponentialRampToValueAtTime(0.20,t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001,t0+0.16);
      o.connect(g); o.start(t0); o.stop(t0+0.17);
      return;
    }
    if (type==="crash"){
      const dur=0.35;
      const buffer=audioCtx.createBuffer(1, audioCtx.sampleRate*dur, audioCtx.sampleRate);
      const data=buffer.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*Math.exp(-i/(data.length/4));
      const src=audioCtx.createBufferSource(); src.buffer=buffer;
      const f=audioCtx.createBiquadFilter(); f.type="lowpass"; f.frequency.value=1000;
      g.gain.setValueAtTime(0.0001,t0);
      g.gain.exponentialRampToValueAtTime(0.45,t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001,t0+dur);
      src.connect(f); f.connect(g);
      src.start(t0); src.stop(t0+dur);
      return;
    }
  }
  musicToggle.addEventListener("change", () => {
    ensureAudio();
    musicGain.gain.value = musicToggle.checked ? 0.25 : 0.0;
  });
  window.addEventListener("pointerdown", () => { ensureAudio(); audioCtx.resume?.(); }, { once:false });

  // ===== Emoji =====
  function popEmoji(emoji, x, y, duration=650){
    const el=document.createElement("div");
    el.className="emojiPop";
    el.textContent=emoji;
    el.style.left=x+"px"; el.style.top=y+"px";
    el.style.opacity="0";
    emojiLayer.appendChild(el);
    const start=performance.now();
    function anim(now){
      const t=(now-start)/duration;
      if(t>=1){ el.remove(); return; }
      const ease=t<0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2;
      const scale=0.75 + 0.95*ease;
      const floatY=-22*ease;
      el.style.opacity=String(1 - t*0.85);
      el.style.transform=`translate(-50%,-50%) translateY(${floatY}px) scale(${scale})`;
      requestAnimationFrame(anim);
    }
    requestAnimationFrame(anim);
  }

  // ===== Input (don‚Äôt steal keys when typing) =====
  const keys = new Set();
  window.addEventListener("keydown",(e)=>{
    const active = document.activeElement;
    const typing = active && active.tagName === "INPUT";
    if(typing) return;

    const k=e.key.toLowerCase();
    keys.add(k);
    if(k===" "){ e.preventDefault(); togglePause(); }
    if(k==="r"){ e.preventDefault(); if(running) resetAndCountdown(); }
    if(k==="arrowleft"||k==="a") e.preventDefault();
    if(k==="arrowright"||k==="d") e.preventDefault();
    if(k==="arrowup"||k==="w") e.preventDefault();
  });
  window.addEventListener("keyup",(e)=>keys.delete(e.key.toLowerCase()));

  function holdButton(btn, downFn, upFn){
    const down=(e)=>{ e.preventDefault(); downFn(); };
    const up=(e)=>{ e.preventDefault(); upFn(); };
    btn.addEventListener("pointerdown", down);
    btn.addEventListener("pointerup", up);
    btn.addEventListener("pointercancel", up);
    btn.addEventListener("pointerleave", up);
  }
  holdButton(mLeft,  ()=>keys.add("arrowleft"), ()=>keys.delete("arrowleft"));
  holdButton(mRight, ()=>keys.add("arrowright"),()=>keys.delete("arrowright"));
  holdButton(mNitro, ()=>keys.add("arrowup"),   ()=>keys.delete("arrowup"));
  holdButton(mDrift, ()=>keys.add("shift"),     ()=>keys.delete("shift"));

  let touchStart=null;
  canvas.addEventListener("pointerdown",(e)=>touchStart={x:e.clientX,y:e.clientY});
  canvas.addEventListener("pointerup",(e)=>{
    if(!touchStart) return;
    const dx=e.clientX-touchStart.x;
    const dy=e.clientY-touchStart.y;
    touchStart=null;
    const ax=Math.abs(dx), ay=Math.abs(dy);
    if(Math.max(ax,ay)<18) return;
    if(ax>ay){
      if(dx>0) steer(1); else steer(-1);
    } else if(dy<0){
      keys.add("arrowup");
      setTimeout(()=>keys.delete("arrowup"),140);
    }
  });

  // ===== Mode selection UI =====
  let modeKey="easy";
  let mode = MODES[modeKey];
  function renderModeButtons(){
    const row = document.getElementById("modeRow");
    row.innerHTML = "";
    for(const k of ["easy","medium","hard"]){
      const b = document.createElement("button");
      b.textContent = k.toUpperCase();
      b.style.borderColor = (k===modeKey) ? "rgba(124,255,234,.45)" : "rgba(255,255,255,.16)";
      b.addEventListener("click", ()=>{
        modeKey = k;
        mode = MODES[modeKey];
        modeEl.textContent = mode.name;
        renderModeButtons();
      });
      row.appendChild(b);
    }
  }

  // ===== Garage (rarity + daily crate) =====
  function canOpenCrate(){
    const t = todayISO();
    return profile.lastCrateDate !== t;
  }
  function crateLabel(){
    return canOpenCrate() ? "AVAILABLE" : "CLAIMED TODAY";
  }

  function rarityWeight(r){
    // crate is more generous but still: no legendary
    if(r==="epic") return 18;
    if(r==="rare") return 34;
    return 48; // common
  }

  // ‚úÖ crate cannot roll legendary
  function rollCrateSkin(){
    const pool = SKINS.filter(s=>s.id!=="stock" && s.rarity!=="legendary");
    const total = pool.reduce((sum,s)=> sum + rarityWeight(s.rarity), 0);
    let r = Math.random()*total;
    for(const s of pool){
      r -= rarityWeight(s.rarity);
      if(r<=0) return s;
    }
    return pool[pool.length-1];
  }

  function renderGarage(){
    crateStatus.textContent = crateLabel();

    garageGrid.innerHTML = "";
    for(const s of SKINS){
      const owned = profile.ownedSkins.includes(s.id);
      const selected = profile.selectedSkin === s.id;
      const r = RARITY[s.rarity] || RARITY.common;

      const div = document.createElement("div");
      div.className = "skin";

      const sw = document.createElement("div");
      sw.className = "swatch";
      sw.style.background = `linear-gradient(135deg, ${s.grad[0]}, ${s.grad[1]})`;

      div.innerHTML = `
        <div class="skinTop">
          <div class="skinName">${s.name}</div>
          <div class="skinMeta">
            <div style="display:inline-block;padding:4px 8px;border-radius:999px;background:${r.chip};border:1px solid rgba(255,255,255,.10)">
              ${r.name}
            </div>
            <div style="margin-top:6px">${s.cost===0 ? "FREE" : (s.cost+" ü™ô")}</div>
          </div>
        </div>
      `;
      div.appendChild(sw);

      const actions = document.createElement("div");
      actions.className = "skinActions";

      const btn = document.createElement("button");
      btn.className = "miniBtn";

      if(selected){
        btn.textContent = "SELECTED";
        btn.disabled = true;
      } else if(owned){
        btn.textContent = "SELECT";
        btn.addEventListener("click", ()=>{
          profile.selectedSkin = s.id;
          saveProfile(profile);
          renderGarage();
        });
      } else {
        btn.textContent = "BUY";
        btn.addEventListener("click", ()=>{
          if(profile.bankCoins < s.cost) return alert("Not enough coins.");
          profile.bankCoins -= s.cost;
          profile.ownedSkins.push(s.id);
          profile.selectedSkin = s.id;
          saveProfile(profile);
          updateHeaderUI();
          renderGarage();
          renderShop();
        });
      }
      actions.appendChild(btn);
      div.appendChild(actions);
      garageGrid.appendChild(div);
    }
  }

  function openCrateModal(){
    crateModal.style.display="grid";
    crateReveal.style.display="none";
    crateBurst.style.display="none";
    crateLine.textContent="Spinning‚Ä¶";
    crateTitle.textContent="üé∞ JACKPOT SPIN";
    crateSub.textContent="Good luck, racer‚Ä¶";
  }
  function closeCrateModal(){ crateModal.style.display="none"; }
  crateCloseBtn.addEventListener("click", closeCrateModal);
  crateModal.addEventListener("click",(e)=>{ if(e.target===crateModal) closeCrateModal(); });

  function crateJackpotReveal({ skin, msg, rarityName }){
    crateLine.textContent="REVEAL!";
    crateTitle.textContent="üí• YOU HIT THE JACKPOT!";
    crateSub.textContent="Neon gods smiled on you.";
    crateBurst.style.display="block";
    crateBurst.style.animation="none";
    // restart animation
    void crateBurst.offsetWidth;
    crateBurst.style.animation="burst 0.7s ease forwards";

    revealName.textContent = skin ? skin.name : "‚Äî";
    revealRarity.textContent = rarityName || "‚Äî";
    revealSwatch.style.background = skin ? `linear-gradient(135deg, ${skin.grad[0]}, ${skin.grad[1]})` : "rgba(255,255,255,.08)";
    revealMsg.textContent = msg || "‚Äî";
    crateReveal.style.display="block";
  }

  crateBtn.addEventListener("click", async ()=>{
    if(!canOpenCrate()) return alert("Crate already claimed today.");

    // show jackpot animation
    openCrateModal();
    profile.lastCrateDate = todayISO();
    saveProfile(profile);
    renderGarage();

    // suspense spin
    const spinMs = 1300 + Math.random()*800;
    await new Promise(r => setTimeout(r, spinMs));

    const skin = rollCrateSkin();

    if(profile.ownedSkins.includes(skin.id)){
      const coins = randInt(220, 360);
      profile.bankCoins += coins;
      saveProfile(profile);
      updateHeaderUI();
      renderGarage();
      renderShop();
      crateJackpotReveal({
        skin,
        rarityName:(RARITY[skin.rarity]||RARITY.common).name,
        msg:`Duplicate! Converted into +${coins} ü™ô`,
      });
      return;
    }

    profile.ownedSkins.push(skin.id);
    profile.selectedSkin = skin.id;
    saveProfile(profile);
    renderGarage();
    crateJackpotReveal({
      skin,
      rarityName:(RARITY[skin.rarity]||RARITY.common).name,
      msg:`New skin unlocked! Equipped automatically.`,
    });
  });

  // ===== Shop =====
  const cart = { shield:0, slowmo:0, magnet:0, invis:0, life:0 };

  function priceMultiplier(){
    const d = clamp(profile.streakDaysClaimed, 0, 7);
    return 1 + d*0.06;
  }
  function getPrices(){
    const mult = priceMultiplier();
    return {
      shield: Math.round(20*mult),
      slowmo: Math.round(25*mult),
      magnet: Math.round(30*mult),
      invis:  Math.round(35*mult),
      life:   Math.round(70*mult),
    };
  }
  function renderShop(){
    shopGrid.innerHTML = "";
    const pr = getPrices();
    const items = [
      { id:"shield", name:"üõ° Shield", desc:"Blocks 1 crash (stack 2).", cost:pr.shield, max:2 },
      { id:"magnet", name:"üß≤ Magnet", desc:"Pull coins 7s (stack 3).", cost:pr.magnet, max:3 },
      { id:"slowmo", name:"‚è± Slow-Mo", desc:"Slows obstacles 5√ó (stack 3).", cost:pr.slowmo, max:3 },
      { id:"invis",  name:"üëª Invisibility", desc:"Phase 6s (stack 3).", cost:pr.invis, max:3 },
      { id:"life",   name:"‚ù§Ô∏è Extra Life", desc:"+1 life next run (max +2).", cost:pr.life, max:2 },
    ];

    for(const it of items){
      const owned = cart[it.id];
      const div = document.createElement("div");
      div.style.border = "1px solid rgba(255,255,255,.12)";
      div.style.background = "rgba(0,0,0,.18)";
      div.style.borderRadius = "16px";
      div.style.padding = "12px";
      div.style.display = "flex";
      div.style.flexDirection = "column";
      div.style.gap = "8px";
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
          <div style="font-family:Orbitron,system-ui,sans-serif;font-weight:900;font-size:12px">${it.name}</div>
          <div style="font-size:12px;color:var(--muted)">${owned}/${it.max}</div>
        </div>
        <div style="color:var(--muted);font-size:13px;line-height:1.35">${it.desc}</div>
        <div style="margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div style="font-size:12px;color:var(--muted)">Cost: <b style="color:var(--text)">${it.cost}</b> ü™ô</div>
          <button class="miniBtn">BUY</button>
        </div>
      `;
      const buyBtn = div.querySelector("button");
      buyBtn.disabled = (owned >= it.max) || (profile.bankCoins < it.cost);
      buyBtn.addEventListener("click", ()=>{
        if(profile.bankCoins < it.cost) return;
        if(cart[it.id] >= it.max) return;
        profile.bankCoins -= it.cost;
        cart[it.id] += 1;
        saveProfile(profile);
        updateHeaderUI();
        renderShop();
        sfx("pickup");
      });
      shopGrid.appendChild(div);
    }
  }

  // ===== Leaderboards =====
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }
  function renderLB(el, list){
    el.innerHTML = "";
    (list||[]).forEach((r, i)=>{
      const row = document.createElement("div");
      row.className="lbRow";
      row.innerHTML = `<span>#${i+1} <b>${escapeHtml(r.name)}</b></span><span><b>${r.score}</b></span>`;
      el.appendChild(row);
    });
    if(!list || list.length===0){
      const row = document.createElement("div");
      row.className="lbRow";
      row.innerHTML = `<span style="color:var(--muted)">No scores yet</span><span></span>`;
      el.appendChild(row);
    }
  }
  async function syncLeaderboards(){
    if(!SB.enabled()){
      lbStatusEl.textContent = "Leaderboards not configured (missing Supabase keys).";
      renderLB(lbWeeklyEl, []);
      renderLB(lbAllTimeEl, []);
      return;
    }
    try{
      lbStatusEl.textContent = "Loading live leaderboards‚Ä¶";
      const ws = weekStartISO();
      const [weekly, allTime] = await Promise.all([
        SB.top10Weekly(ws).catch(()=>null),
        SB.top10AllTime().catch(()=>null),
      ]);
      lbStatusEl.textContent = `Live leaderboards (Week starts ${ws})`;
      renderLB(lbWeeklyEl, weekly || []);
      renderLB(lbAllTimeEl, allTime || []);
    } catch {
      lbStatusEl.textContent = "Couldn‚Äôt load leaderboards right now.";
    }
  }

  // ===== Game state =====
  const player = { x: laneCenter(1), y: H*0.78, w: 52, h: 92, vx:0, targetX:null };
  const traffic=[], coins=[], pickups=[], hazards=[];
  const stars = Array.from({length: 90}, ()=>({ x:Math.random()*W, y:Math.random()*H, s:0.5+Math.random()*1.6 }));

  let running=false, paused=false, last=performance.now();
  let score=0, speed=0, roadY=0;
  let runCoins=0;
  let nitro=1.0, nitroActive=false;
  let driftActive=false;
  let runLives=2;
  let invulnT=0;

  // Countdown
  let countdownActive=false;
  let countdownT=0;
  let countdownVal=3; // 3,2,1,GO

  // Bonus rules:
  // - duration 12s
  // - first at 500
  // - next is (score at end of bonus + 1000)
  const BONUS_FIRST = 500;
  const BONUS_LEN = 12;

  let bonusActive=false, bonusT=0, nextBonusAt=BONUS_FIRST;

  const pending = { shield:0, slowmoT:0, magnetT:0, invisT:0, nitro:0, coinMultT:0, coinMult:1 };
  const power   = { shield:0, slowmoT:0, magnetT:0, invisT:0, coinMultT:0, coinMult:1 };

  let savedPower = null;

  let passedCarsThisRun=0, closeCallsThisRun=0;

  const roadClampMin = () => road.x + WALL_MARGIN + player.w*0.55;
  const roadClampMax = () => road.x + road.w - WALL_MARGIN - player.w*0.55;

  function steer(dir){
    const lane = clamp(Math.floor((player.x - road.x)/laneW), 0, laneCount-1);
    const next = clamp(lane+dir, 0, laneCount-1);
    player.targetX = laneCenter(next);
  }

  let spawnTimer=0, coinTimer=0, pickupTimer=0, hazardTimer=0;

  function difficultyFactor(){
    // increases with score -> harder (spawns + lane change)
    const s = Math.floor(score);
    return clamp(1 + (s/700)*0.28, 1, 2.2);
  }

  function spawnCar(){
    if(bonusActive) return;
    if(traffic.length >= mode.maxTraffic) return;

    const isGift = Math.random() < 0.030; // slightly rarer now (harder)
    const lane=randInt(0,laneCount-1);
    if(traffic.some(t=>t.targetLane===lane && t.y<170)) return;

    traffic.push({
      kind: isGift ? "gift" : "car",
      x: laneCenter(lane),
      y: -130,
      w: 50, h: 92,
      rel: lerp(mode.trafficRelMin, mode.trafficRelMax, Math.random()),
      seed: Math.random(),
      targetLane: lane,
      laneChangeCooldown: lerp(mode.laneChangeCooldown[0], mode.laneChangeCooldown[1], Math.random()),
      countedPass: false
    });
  }

  function spawnHazard(){
    if(bonusActive) return;
    if(hazards.length >= 4) return;
    const lane = randInt(0,laneCount-1);
    const kind = Math.random() < 0.55 ? "stone" : "stop";
    // avoid stacking near top
    if(hazards.some(h=>h.lane===lane && h.y<220)) return;

    hazards.push({
      kind,
      lane,
      x: laneCenter(lane),
      y: -90,
      w: kind==="stone" ? 54 : 44,
      h: kind==="stone" ? 38 : 58
    });
  }

  function spawnCoin(extra=false){
    if(coins.length >= (extra ? 18 : 12)) return; // reduced a bit (harder)
    const lane=randInt(0,laneCount-1);
    const value = (Math.random()<0.08) ? 10 : (Math.random()<0.18 ? 5 : 1);
    coins.push({ lane, x: laneCenter(lane), y:-60, r:12, spin:Math.random()*10, value });
  }

  function spawnPickup(extra=false){
    if(pickups.length >= (extra ? 6 : 5)) return;
    const lane=randInt(0,laneCount-1);
    const roll = Math.random();
    let type="shield";
    if(roll < 0.18) type="shield";
    else if(roll < 0.34) type="magnet";
    else if(roll < 0.48) type="slowmo";
    else if(roll < 0.62) type="invis";
    else if(roll < 0.75) type="nitro";
    else type = (Math.random()<0.55) ? "coinx5" : "coinx10";
    pickups.push({ type, lane, x: laneCenter(lane), y:-70, w: 34, h: 34, spin:Math.random()*10 });
  }

  function applyCartToRun(){
    power.shield += cart.shield;
    power.slowmoT += cart.slowmo * 6.0;
    power.magnetT += cart.magnet * 7.0;
    power.invisT  += cart.invis  * 6.0;

    runLives = 2 + cart.life;
    runLives = clamp(runLives, 2, 4);

    cart.shield = cart.slowmo = cart.magnet = cart.invis = cart.life = 0;
    renderShop();
  }

  function syncUI(){
    scoreEl.textContent = Math.floor(score);
    bestEl.textContent = profile.bestScore || 0;
    modeEl.textContent = mode.name;
    runCoinsEl.textContent = runCoins;
    bankCoinsEl.textContent = profile.bankCoins;
    livesEl.textContent = runLives;
    nitroFill.style.width = Math.round(clamp(nitro,0,1)*100)+"%";
  }

  function togglePause(){
    if(!running || countdownActive) return;
    paused = !paused;
    last = performance.now();
  }
  pauseBtn.addEventListener("click", togglePause);
  restartBtn.addEventListener("click", ()=>{ if(running){ resetAndCountdown(); } });

  function startBonus(){
    bonusActive = true;
    bonusT = BONUS_LEN;

    savedPower = { ...power };
    // NO BUFFS ACTIVE in bonus
    power.shield = 0; power.slowmoT = 0; power.magnetT = 0; power.invisT = 0; power.coinMultT = 0; power.coinMult = 1;

    traffic.length = 0;
    hazards.length = 0;
    spawnTimer = coinTimer = pickupTimer = hazardTimer = 0;
    pending.shield=0; pending.slowmoT=0; pending.magnetT=0; pending.invisT=0; pending.nitro=0; pending.coinMultT=0; pending.coinMult=1;

    popEmoji("‚ú®", window.innerWidth/2, 120);
  }

  function endBonus(){
    bonusActive = false;

    if(savedPower){
      power.shield = savedPower.shield || 0;
      power.slowmoT = savedPower.slowmoT || 0;
      power.magnetT = savedPower.magnetT || 0;
      power.invisT  = savedPower.invisT  || 0;
      power.coinMultT = savedPower.coinMultT || 0;
      power.coinMult  = savedPower.coinMult  || 1;
      savedPower = null;
    }

    // activate pending AFTER bonus ends
    power.shield += pending.shield;
    power.slowmoT += pending.slowmoT;
    power.magnetT = Math.max(power.magnetT, pending.magnetT);
    power.invisT  += pending.invisT;
    nitro = clamp(nitro + pending.nitro, 0, 1.75);
    if(pending.coinMultT > 0){
      power.coinMultT = Math.max(power.coinMultT, pending.coinMultT);
      power.coinMult = Math.max(power.coinMult, pending.coinMult);
    }

    nextBonusAt = Math.floor(score) + 1000;
    popEmoji("üèÅ", window.innerWidth/2, 140);
  }

  // ‚úÖ FIXED SHIELD LOGIC:
  // - If shield>0 and collision happens => shield breaks, obstacle removed, no life lost
  function breakShield(){
    if(power.shield <= 0) return false;
    power.shield -= 1;
    invulnT = Math.max(invulnT, 1.1); // brief safety after break
    sfx("pickup");
    popEmoji("üõ°", window.innerWidth*0.5, window.innerHeight*0.22);
    return true;
  }

  function loseLife(){
    // invuln means you can't lose another life yet
    if(invulnT > 0) return;

    runLives -= 1;
    invulnT = 2.0;
    sfx("crash");

    if(runLives <= 0) gameOver();
    else popEmoji("üí•", window.innerWidth*0.5, window.innerHeight*0.22);
  }

  function canRevive(){ return profile.bankCoins >= 100; }
  function revive(){
    if(!canRevive()) return;
    profile.bankCoins -= 100;
    saveProfile(profile);
    updateHeaderUI();
    runLives = 1;
    invulnT = 2.0;
    running = true;
    paused = false;
    gameOverModal.style.display = "none";
    document.body.classList.add("playing");
    // continue with no countdown on revive
    countdownActive = false;
  }

  async function gameOver(){
    running=false;
    profile.bankCoins += runCoins;
    runCoins = 0;
    saveProfile(profile);

    try{
      const nm = profile.name || "Gamer";
      if (SB.enabled() && nm && nm !== "Gamer"){
        await SB.upsertAllTime(nm, profile.bestScore);
        await SB.upsertWeekly(weekStartISO(), nm, profile.bestScore);
      }
    } catch {}

    updateHeaderUI();
    await syncLeaderboards();

    reviveBtn.disabled = !canRevive();
    gameOverText.textContent = `Best: ${profile.bestScore} ‚Ä¢ Bank: ${profile.bankCoins} ü™ô`;
    gameOverModal.style.display = "grid";
    document.body.classList.remove("playing");
  }

  reviveBtn.addEventListener("click", revive);
  backHomeBtn.addEventListener("click", ()=>{
    gameOverModal.style.display="none";
    document.body.classList.remove("playing");
  });

  shareBtn.addEventListener("click", async ()=>{
    const ws = weekStartISO();
    const text = `I scored ${profile.bestScore} in Neon Highway Racer! üèéÔ∏èüî•\nWeek: ${ws}\nPlay: ${location.href}`;
    try{
      if (navigator.share) await navigator.share({ title:"Neon Highway Racer", text, url: location.href });
      else if (navigator.clipboard){ await navigator.clipboard.writeText(text); alert("Copied! Share it anywhere."); }
      else prompt("Copy:", text);
    } catch {}
  });

  // ===== Drawing =====
  function roundRect(x,y,w,h,r){
    const rr=Math.min(r,w/2,h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }

  function skinObj(){
    return SKINS.find(s=>s.id===profile.selectedSkin) || SKINS[0];
  }

  function drawCar(x,y,w,h,isPlayer,seed,kind, tNow){
    ctx.save();

    const grad = ctx.createLinearGradient(x-w/2, y-h/2, x+w/2, y+h/2);

    if(kind==="gift"){
      grad.addColorStop(0,"rgba(255,210,77,.98)");
      grad.addColorStop(1,"rgba(255,90,140,.96)");
    } else if(isPlayer){
      const s = skinObj();
      grad.addColorStop(0, s.grad[0]);
      grad.addColorStop(1, s.grad[1]);
    } else {
      grad.addColorStop(0, `rgba(${Math.floor(120+seed*120)},${Math.floor(70+seed*90)},${Math.floor(160+seed*80)},.98)`);
      grad.addColorStop(1, `rgba(${Math.floor(200+seed*55)},${Math.floor(80+seed*120)},${Math.floor(120+seed*90)},.98)`);
    }

    if(isPlayer){
      const s = skinObj();
      const r = RARITY[s.rarity] || RARITY.common;
      const pulse = 0.55 + 0.45*Math.sin(tNow*3.4);
      ctx.shadowBlur = 18 + pulse*10;
      ctx.shadowColor = r.glow;
    } else {
      ctx.shadowBlur = 12;
      ctx.shadowColor = "rgba(255,106,223,.22)";
    }

    ctx.fillStyle = grad;
    roundRect(x-w/2, y-h/2, w, h, 14);
    ctx.fill();

    // windshield (solid)
    ctx.shadowBlur = 0;
    ctx.fillStyle="rgba(12,14,20,.92)";
    roundRect(x-w*0.30, y-h*0.26, w*0.60, h*0.30, 10);
    ctx.fill();

    // subtle highlight
    ctx.fillStyle="rgba(255,255,255,.08)";
    roundRect(x-w*0.26, y-h*0.22, w*0.52, h*0.22, 10);
    ctx.fill();

    // lights
    ctx.fillStyle = "rgba(255,255,255,.85)";
    ctx.fillRect(x-w*0.36, y-h*0.45, w*0.18, 7);
    ctx.fillRect(x+w*0.18, y-h*0.45, w*0.18, 7);

    ctx.fillStyle = "rgba(255,90,140,.85)";
    ctx.fillRect(x-w*0.36, y+h*0.40, w*0.18, 7);
    ctx.fillRect(x+w*0.18, y+h*0.40, w*0.18, 7);

    if(kind==="gift"){
      ctx.fillStyle="rgba(0,0,0,.22)";
      roundRect(x-w*0.20, y-h*0.04, w*0.40, h*0.22, 10);
      ctx.fill();
      ctx.fillStyle="rgba(255,255,255,.92)";
      ctx.font="900 18px system-ui, sans-serif";
      ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText("üéÅ", x, y+h*0.03);
    }

    ctx.restore();
  }

  function drawCoin(c){
    ctx.save();
    c.spin += 0.08;
    const pulse=1 + Math.sin(c.spin)*0.12;
    ctx.shadowBlur=16;
    ctx.shadowColor="rgba(255,210,77,0.95)";
    ctx.fillStyle="rgba(255,210,77,0.92)";
    ctx.beginPath(); ctx.arc(c.x,c.y,c.r*pulse,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;
    ctx.fillStyle="rgba(0,0,0,.25)";
    ctx.beginPath(); ctx.arc(c.x,c.y,c.r*0.55,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="rgba(255,255,255,.95)";
    ctx.font="900 12px Rajdhani, sans-serif";
    ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillText(c.value===1 ? "ü™ô" : `x${c.value}`, c.x, c.y+0.5);
    ctx.restore();
  }

  function drawPickup(p){
    ctx.save();
    p.spin += 0.08;
    const s = 1 + Math.sin(p.spin)*0.08;
    ctx.translate(p.x, p.y);
    ctx.scale(s, s);
    ctx.shadowBlur = 16;
    ctx.shadowColor = "rgba(124,255,234,.55)";
    ctx.fillStyle = "rgba(0,0,0,.28)";
    roundRect(-p.w/2, -p.h/2, p.w, p.h, 10); ctx.fill();
    ctx.shadowBlur = 0;
    ctx.fillStyle = "rgba(255,255,255,.92)";
    ctx.font = "900 16px Rajdhani, sans-serif";
    ctx.textAlign="center"; ctx.textBaseline="middle";
    const map = { shield:"üõ°", magnet:"üß≤", slowmo:"‚è±", invis:"üëª", nitro:"üöÄ", coinx5:"x5", coinx10:"x10" };
    ctx.fillText(map[p.type] || "‚≠ê", 0, 1);
    ctx.restore();
  }

  function drawHazard(h){
    ctx.save();
    ctx.translate(h.x, h.y);
    if(h.kind==="stone"){
      ctx.shadowBlur=18;
      ctx.shadowColor="rgba(255,210,77,.25)";
      ctx.fillStyle="rgba(80,90,110,.95)";
      roundRect(-h.w/2, -h.h/2, h.w, h.h, 10); ctx.fill();
      ctx.shadowBlur=0;
      ctx.fillStyle="rgba(0,0,0,.25)";
      roundRect(-h.w*0.35, -h.h*0.12, h.w*0.7, h.h*0.24, 10); ctx.fill();
      ctx.fillStyle="rgba(255,255,255,.85)";
      ctx.font="900 16px system-ui,sans-serif";
      ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText("ü™®", 0, 1);
    } else {
      // stop sign
      ctx.shadowBlur=18;
      ctx.shadowColor="rgba(255,90,132,.28)";
      ctx.fillStyle="rgba(255,90,132,.92)";
      const s = h.w*0.58;
      ctx.beginPath();
      for(let i=0;i<8;i++){
        const a = (Math.PI*2)*(i/8) + Math.PI/8;
        const rr = s;
        ctx.lineTo(Math.cos(a)*rr, Math.sin(a)*rr);
      }
      ctx.closePath(); ctx.fill();
      ctx.shadowBlur=0;
      ctx.fillStyle="rgba(255,255,255,.92)";
      ctx.font="900 12px Orbitron, sans-serif";
      ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText("STOP", 0, 0);
      // pole
      ctx.fillStyle="rgba(220,220,230,.85)";
      roundRect(-4, s*0.9, 8, h.h*0.6, 6); ctx.fill();
    }
    ctx.restore();
  }

  function drawRoad(){
    ctx.fillStyle="#050814";
    ctx.fillRect(0,0,W,H);

    ctx.globalAlpha=0.6;
    for(const st of stars){
      ctx.fillRect(st.x,st.y,st.s,st.s);
      st.y += (speed*0.02)*(st.s)*0.03;
      if(st.y>H){ st.y=-5; st.x=Math.random()*W; }
    }
    ctx.globalAlpha=1;

    const grad = ctx.createLinearGradient(road.x,0,road.x+road.w,0);
    grad.addColorStop(0,"rgba(20,240,255,.10)");
    grad.addColorStop(0.5,"rgba(255,255,255,.05)");
    grad.addColorStop(1,"rgba(255,70,220,.10)");
    ctx.fillStyle=grad;
    roundRect(road.x,0,road.w,H,22); ctx.fill();

    ctx.strokeStyle="rgba(255,255,255,.16)";
    ctx.lineWidth=2;
    roundRect(road.x,0,road.w,H,22); ctx.stroke();

    ctx.save();
    ctx.globalAlpha = 0.30;
    ctx.fillStyle = "rgba(255,90,132,1)";
    ctx.fillRect(road.x,0,WALL_MARGIN,H);
    ctx.fillRect(road.x+road.w-WALL_MARGIN,0,WALL_MARGIN,H);
    ctx.restore();

    ctx.save();
    ctx.beginPath(); ctx.rect(road.x,0,road.w,H); ctx.clip();
    ctx.strokeStyle="rgba(255,255,255,.20)";
    ctx.lineWidth=2;
    for(let i=1;i<laneCount;i++){
      const lx = road.x + laneW*i;
      for(let y=-80; y<H+80; y+=60){
        const yy = y + (roadY%60);
        ctx.beginPath(); ctx.moveTo(lx,yy); ctx.lineTo(lx,yy+26); ctx.stroke();
      }
    }
    ctx.restore();

    if(bonusActive){
      ctx.save();
      ctx.globalAlpha = 0.10;
      ctx.fillStyle = "rgba(255,210,77,1)";
      ctx.fillRect(0,0,W,H);
      ctx.globalAlpha = 1;
      ctx.fillStyle="rgba(255,255,255,.95)";
      ctx.font="900 24px Orbitron, sans-serif";
      ctx.textAlign="center";
      ctx.fillText(`BONUS ‚Ä¢ ${Math.ceil(bonusT)}s`, W/2, 44);
      ctx.fillStyle="rgba(255,255,255,.75)";
      ctx.font="800 12px Orbitron, sans-serif";
      ctx.fillText(`No buffs active during bonus`, W/2, 66);
      ctx.restore();
    }
  }

  function resetBase(){
    score=0; speed=mode.baseSpeed; roadY=0;
    runCoins=0; nitro=1.0; nitroActive=false; driftActive=false;
    invulnT=0;

    bonusActive=false; bonusT=0;
    nextBonusAt=BONUS_FIRST;
    savedPower=null;

    power.shield=0; power.slowmoT=0; power.magnetT=0; power.invisT=0; power.coinMultT=0; power.coinMult=1;

    player.x=laneCenter(1); player.vx=0; player.targetX=null;

    traffic.length=0; coins.length=0; pickups.length=0; hazards.length=0;

    passedCarsThisRun=0; closeCallsThisRun=0;

    applyCartToRun();

    running=true; paused=false; last=performance.now();
    syncUI();
  }

  function startCountdown(){
    countdownActive=true;
    countdownVal=3;
    countdownT=1.0;
  }

  function resetAndCountdown(){
    resetBase();
    startCountdown();
  }

  function updateMissionsProgress(){
    for (const m of profile.missions){
      if (m.type === "passCars") m.progress = Math.max(m.progress, passedCarsThisRun);
      if (m.type === "collectCoins") m.progress = Math.max(m.progress, runCoins);
      if (m.type === "closeCalls") m.progress = Math.max(m.progress, closeCallsThisRun);
    }
    saveProfile(profile);
  }

  function update(dt){
    const df = difficultyFactor();

    // speed ramp + cap (harder over time but controlled)
    const SPEED_CAP = mode.baseSpeed + 310;
    speed = Math.min(speed + (mode.accel*df) * dt, SPEED_CAP);

    const nitroKey = keys.has("arrowup") || keys.has("w");
    nitroActive = nitroKey && nitro > 0.02 && running && !paused;
    if(nitroActive) nitro = Math.max(0, nitro - dt*0.34);
    else nitro = Math.min(1.65, nitro + dt*0.17);

    driftActive = keys.has("shift");
    const steerLeft = keys.has("arrowleft") || keys.has("a");
    const steerRight= keys.has("arrowright") || keys.has("d");

    const nitroBoost = nitroActive ? 160 : 0;
    const playerSpeed = speed + nitroBoost;

    const obstacleFactor = (power.slowmoT > 0) ? 0.20 : 1.0;

    roadY += playerSpeed*dt;
    if(roadY>60) roadY -= 60;

    const steerPower = driftActive ? 3400 : 2400;
    if(steerLeft) player.vx -= steerPower*dt;
    if(steerRight)player.vx += steerPower*dt;

    if(player.targetX !== null){
      const dx = player.targetX - player.x;
      player.vx += dx*18*dt;
      if(Math.abs(dx)<3){ player.x=player.targetX; player.targetX=null; player.vx*=0.2; }
    }

    const friction = driftActive ? 0.00135 : 0.0008;
    player.vx *= Math.pow(friction, dt);
    player.x += player.vx*dt;

    const minX = roadClampMin();
    const maxX = roadClampMax();
    player.x = clamp(player.x, minX, maxX);

    // wall punish
    const leftWallX = road.x + WALL_MARGIN;
    const rightWallX = road.x + road.w - WALL_MARGIN;
    const playerLeft = player.x - player.w*0.5;
    const playerRight= player.x + player.w*0.5;
    if(playerLeft <= leftWallX + 1 || playerRight >= rightWallX - 1){
      if(power.invisT <= 0){
        // shield can break from wall too
        if(!breakShield()) loseLife();
      }
      player.x = clamp(player.x, minX+2, maxX-2);
      player.vx *= -0.25;
    }

    // spawns
    if(!bonusActive){
      spawnTimer += dt * mode.spawnRate * df * (0.95 + playerSpeed/720);
      if(spawnTimer>=1){
        spawnTimer=0;
        spawnCar();
        if(df>1.25 && Math.random()<0.22) spawnCar();
        if(df>1.75 && Math.random()<0.30) spawnCar();
      }

      hazardTimer += dt * (0.28 * df);
      if(hazardTimer >= 1){
        hazardTimer = 0;
        if(Math.random() < 0.85) spawnHazard();
      }
    }

    coinTimer += dt * (0.72 + playerSpeed/1100) * (bonusActive ? 1.25 : 1.0);
    if(coinTimer>=1){
      coinTimer=0;
      spawnCoin(bonusActive);
      if(Math.random()<0.35) spawnCoin(bonusActive);
    }

    pickupTimer += dt * (bonusActive ? 1.0 : 0.42);
    if(pickupTimer>=1){
      pickupTimer=0;
      if(Math.random() < (bonusActive ? 0.55 : 0.18)) spawnPickup(bonusActive);
    }

    // bonus trigger
    if(!bonusActive && score >= nextBonusAt){
      startBonus();
    }
    if(bonusActive){
      bonusT -= dt;
      if(bonusT <= 0) endBonus();
    }

    // move traffic with stronger lane changes as score rises
    const laneChangeBoost = 1 + (df-1)*0.85;
    for(let i=traffic.length-1;i>=0;i--){
      const t = traffic[i];
      t.y += playerSpeed*dt*t.rel*obstacleFactor;

      if(!t.countedPass && t.y > player.y + player.h*0.6){
        t.countedPass = true;
        passedCarsThisRun += 1;
      }

      t.x += Math.sin((t.y/120)+t.seed*10)*dt*mode.wiggle*0.35;

      t.laneChangeCooldown -= dt;
      const laneChangeChance = mode.laneChangeRate * laneChangeBoost;
      if(t.laneChangeCooldown <= 0 && Math.random() < laneChangeChance){
        const dir = Math.random()<0.5 ? -1 : 1;
        const next = clamp(t.targetLane + dir, 0, laneCount-1);
        const safe = !traffic.some(o => o!==t && o.targetLane===next && Math.abs(o.y - t.y) < 118);
        const safeHaz = !hazards.some(h => h.lane===next && Math.abs(h.y - t.y) < 120);
        if(safe && safeHaz) t.targetLane = next;
        t.laneChangeCooldown = lerp(mode.laneChangeCooldown[0], mode.laneChangeCooldown[1], Math.random());
      }

      const targetX = laneCenter(t.targetLane);
      t.x += (targetX - t.x) * dt * (mode.laneChangeSpeed * laneChangeBoost);
      t.x = clamp(t.x, road.x + WALL_MARGIN + t.w*0.55, road.x + road.w - WALL_MARGIN - t.w*0.55);

      if(t.y > H+160) traffic.splice(i,1);
    }

    // hazards
    for(let i=hazards.length-1;i>=0;i--){
      const h = hazards[i];
      h.y += playerSpeed*dt*0.82*obstacleFactor;
      if(h.y > H+120) hazards.splice(i,1);
    }

    // coins
    for(let i=coins.length-1;i>=0;i--){
      const c = coins[i];
      c.y += playerSpeed*dt*0.90*obstacleFactor;

      if(power.magnetT > 0){
        const dx = player.x - c.x;
        const dy = player.y - c.y;
        c.x += dx*dt*7.2;
        c.y += dy*dt*7.2;
      } else {
        c.x += (laneCenter(c.lane)-c.x)*dt*2.0;
      }
      if(c.y > H+60) coins.splice(i,1);
    }

    // pickups
    for(let i=pickups.length-1;i>=0;i--){
      const p = pickups[i];
      p.y += playerSpeed*dt*0.85*obstacleFactor;

      if(power.magnetT > 0){
        p.x += (player.x - p.x)*dt*3.0;
        p.y += (player.y - p.y)*dt*3.0;
      }
      if(p.y > H+80) pickups.splice(i,1);
    }

    // ‚úÖ SLOWER scoring speed (harder)
    score += dt*(42 + playerSpeed*0.014);
    if(nitroActive) score += dt*6;
    if(driftActive && (steerLeft||steerRight)) score += dt*2.8;

    // close calls
    if(power.invisT <= 0){
      for(const t of traffic){
        if(t.kind==="gift") continue;
        const d = distRect(player.x, player.y, player.w, player.h, t.x, t.y, t.w, t.h);
        if(d < 10 && d > 0){
          score += dt*12;
          if(Math.random()<0.03) popEmoji("üò≤", window.innerWidth*0.5, window.innerHeight*0.18);
          if(Math.random()<0.16) closeCallsThisRun += 1;
        }
      }
    }

    // collect coins
    for(let i=coins.length-1;i>=0;i--){
      const c=coins[i];
      if(rectHit(player.x, player.y, player.w*0.9, player.h*0.9, c.x, c.y, c.r*2, c.r*2)){
        coins.splice(i,1);
        const multActive = (power.coinMultT > 0) ? power.coinMult : 1;
        const gained = c.value * multActive;
        runCoins += gained;
        score += 4 + gained; // reduced
        sfx("coin");
      }
    }

    // collect pickups
    for(let i=pickups.length-1;i>=0;i--){
      const p=pickups[i];
      if(rectHit(player.x, player.y, player.w*0.9, player.h*0.9, p.x, p.y, p.w, p.h)){
        pickups.splice(i,1);
        sfx("pickup");

        const applyTo = bonusActive ? pending : power;

        if(p.type==="shield") applyTo.shield = (applyTo.shield||0) + 1;
        else if(p.type==="magnet") applyTo.magnetT = Math.max((applyTo.magnetT||0), 7.0);
        else if(p.type==="slowmo") applyTo.slowmoT = (applyTo.slowmoT||0) + 6.0;
        else if(p.type==="invis") applyTo.invisT  = (applyTo.invisT||0) + 6.0;
        else if(p.type==="nitro"){
          if(bonusActive) pending.nitro += 0.32;
          else nitro = clamp(nitro + 0.32, 0, 1.65);
        }
        else if(p.type==="coinx5"){
          if(bonusActive){ pending.coinMult= Math.max(pending.coinMult,5); pending.coinMultT = Math.max(pending.coinMultT, 10); }
          else { power.coinMult= Math.max(power.coinMult,5); power.coinMultT = Math.max(power.coinMultT, 10); }
        }
        else if(p.type==="coinx10"){
          if(bonusActive){ pending.coinMult= Math.max(pending.coinMult,10); pending.coinMultT = Math.max(pending.coinMultT, 8); }
          else { power.coinMult= Math.max(power.coinMult,10); power.coinMultT = Math.max(power.coinMultT, 8); }
        }
        popEmoji("‚ö°", window.innerWidth*0.5, window.innerHeight*0.18);
      }
    }

    // invuln tick
    if(invulnT > 0) invulnT = Math.max(0, invulnT - dt);

    // ===== collisions =====
    // traffic
    for(let i=traffic.length-1;i>=0;i--){
      const t = traffic[i];

      if(t.kind==="gift" && rectHit(player.x, player.y, player.w, player.h, t.x, t.y, t.w, t.h)){
        traffic.splice(i,1);
        const gift = randInt(500,600);
        profile.bankCoins += gift;
        saveProfile(profile);
        updateHeaderUI();
        popEmoji("üéÅ", window.innerWidth*0.5, window.innerHeight*0.22);
        popEmoji(`+${gift}ü™ô`, window.innerWidth*0.5, window.innerHeight*0.28);
        continue;
      }

      if(rectHit(player.x, player.y, player.w, player.h, t.x, t.y, t.w, t.h)){
        if(power.invisT > 0){
          // phase
        } else {
          // ‚úÖ shield consumes first and removes obstacle
          if(breakShield()){
            traffic.splice(i,1);
          } else {
            loseLife();
          }
        }
        break;
      }
    }

    // hazards collision
    for(let i=hazards.length-1;i>=0;i--){
      const h = hazards[i];
      if(rectHit(player.x, player.y, player.w, player.h, h.x, h.y, h.w, h.h)){
        if(power.invisT > 0){
          // phase through
        } else {
          if(breakShield()){
            hazards.splice(i,1);
          } else {
            loseLife();
          }
        }
        break;
      }
    }

    // timers
    power.slowmoT = Math.max(0, power.slowmoT - dt);
    power.magnetT = Math.max(0, power.magnetT - dt);
    power.invisT  = Math.max(0, power.invisT  - dt);
    power.coinMultT = Math.max(0, power.coinMultT - dt);
    if(power.coinMultT <= 0) power.coinMult = 1;

    updateMissionsProgress();

    const sc = Math.floor(score);
    if(sc > (profile.bestScore || 0)){
      profile.bestScore = sc;
      saveProfile(profile);
    }

    syncUI();
  }

  function draw(){
    const tNow = performance.now()/1000;

    drawRoad();

    for(const c of coins) drawCoin(c);
    for(const p of pickups) drawPickup(p);
    for(const h of hazards) drawHazard(h);
    for(const t of traffic) drawCar(t.x, t.y, t.w, t.h, false, t.seed, t.kind, tNow);
    drawCar(player.x, player.y, player.w, player.h, true, 0.3, "player", tNow);

    if(power.shield > 0){
      ctx.save();
      ctx.globalAlpha=0.70;
      ctx.strokeStyle="rgba(124,255,234,.95)";
      ctx.lineWidth=3;
      ctx.beginPath();
      ctx.arc(player.x, player.y, 62, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();
    }

    // Countdown overlay
    if(countdownActive){
      ctx.save();
      ctx.fillStyle="rgba(0,0,0,.40)";
      ctx.fillRect(0,0,W,H);

      ctx.textAlign="center";
      ctx.textBaseline="middle";

      const big = countdownVal >= 1 ? String(countdownVal) : "LET'S GO!";
      ctx.fillStyle="rgba(255,255,255,.95)";
      ctx.font = countdownVal >= 1 ? "900 92px Orbitron, sans-serif" : "900 62px Orbitron, sans-serif";
      ctx.fillText(big, W/2, H/2);

      ctx.fillStyle="rgba(255,255,255,.72)";
      ctx.font="800 16px Orbitron, sans-serif";
      ctx.fillText("Stay sharp. Dodge lane obstacles.", W/2, H/2 + 74);
      ctx.restore();
    }

    if(paused && running && !countdownActive){
      ctx.fillStyle="rgba(0,0,0,.45)";
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle="rgba(255,255,255,.92)";
      ctx.font="900 44px Orbitron, sans-serif";
      ctx.textAlign="center";
      ctx.fillText("PAUSED", W/2, H/2);
    }
  }

  function loop(now){
    const dt = Math.min(0.033, (now-last)/1000);
    last = now;

    if(running && !paused){
      if(countdownActive){
        countdownT -= dt;
        if(countdownT <= 0){
          countdownVal -= 1;
          if(countdownVal <= 0){
            countdownActive = false;
            popEmoji("üèéÔ∏è", window.innerWidth*0.5, window.innerHeight*0.18);
          } else {
            countdownT = 1.0;
          }
        }
      } else {
        update(dt);
      }
    }

    draw();
    requestAnimationFrame(loop);
  }

  // ===== UI events =====
  saveNameBtn.addEventListener("click", ()=>{
    const nm = (nameInput.value || "").trim().slice(0,18);
    if(!nm) return;
    profile.name = nm;
    saveProfile(profile);
    updateHeaderUI();
    syncLeaderboards();
  });
  resetNameBtn.addEventListener("click", ()=>{
    profile.name = "Gamer";
    saveProfile(profile);
    nameInput.value = "Gamer";
    updateHeaderUI();
    syncLeaderboards();
  });

  claimBtn.addEventListener("click", ()=>{
    const r = claimDailyBonus();
    alert(r.msg);
    updateHeaderUI();
    renderStreak();
    renderShop();
    renderGarage();
  });

  function openShop(){ shopModal.style.display="grid"; renderShop(); }
  function closeShop(){ shopModal.style.display="none"; }
  openShopBtn.addEventListener("click", openShop);
  homeOpenShop.addEventListener("click", openShop);
  shopClose.addEventListener("click", closeShop);
  shopModal.addEventListener("click", (e)=>{ if(e.target===shopModal) closeShop(); });

  homeOpenGarage.addEventListener("click", ()=>{
    document.getElementById("garageCard").scrollIntoView({ behavior:"smooth", block:"start" });
  });
  homeOpenBoards.addEventListener("click", ()=>{
    lbAllTimeEl.scrollIntoView({ behavior:"smooth", block:"start" });
  });

  function startGame(){
    document.body.classList.add("playing");
    resetAndCountdown();
  }
  homePlay.addEventListener("click", startGame);

  // ===== init =====
  ensureDailyMissions();
  updateHeaderUI();
  renderStreak();
  renderMissions();
  renderModeButtons();
  renderShop();
  renderGarage();
  syncLeaderboards();

  nameInput.value = profile.name || "Gamer";
  modeEl.textContent = mode.name;

  requestAnimationFrame(loop);

})();
</script>
</body>
</html>
