<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Neon Highway Racer</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#060814; --panel:#0b1230;
      --text:#eaf0ff; --muted:#9fb0e6;
      --a:#7cffea; --p:#ff6adf; --g:#ffd24d; --r:#ff4b5c;
      --common:#9fb0e6; --rare:#7cffea; --epic:#ff6adf; --legend:#ffd24d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 700px at 50% 15%, #1a2a7a 0%, var(--bg) 60%);
      color:var(--text);
      overflow:hidden;
    }

    .app{height:100%; display:flex; flex-direction:column;}
    .topbar{
      padding:12px 14px;
      background:rgba(11,18,48,.78);
      border-bottom:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; flex-direction:column; gap:2px;}
    .brand h1{
      margin:0;
      font-family:"Orbitron", system-ui, sans-serif;
      font-weight:900;
      letter-spacing:.8px;
      font-size:16px;
      line-height:1.15;
    }
    .brand .sub{font-size:12px; color:var(--muted)}
    .actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    button{
      cursor:pointer;
      color:var(--text);
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      font-size:13px;
      transition:.15s transform,.15s background;
      user-select:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
    }
    button:hover{background:rgba(255,255,255,.12)}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.55; cursor:not-allowed}

    .home{
      flex:1;
      overflow:auto;
      padding:14px;
      display:grid;
      gap:12px;
      align-content:start;
    }
    .hero{
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(135deg, rgba(124,255,234,.12), rgba(255,106,223,.10));
      border-radius:18px;
      padding:14px;
      box-shadow:0 18px 60px rgba(0,0,0,.35);
    }
    .heroRow{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .heroTitle{
      font-family:"Orbitron", system-ui, sans-serif;
      font-weight:900;
      font-size:18px;
      margin:0;
      letter-spacing:1px;
    }
    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .chip{
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
      display:inline-flex; gap:6px; align-items:center;
    }
    .chip b{color:var(--text)}
    .rar.common{color:var(--common)}
    .rar.rare{color:var(--rare)}
    .rar.epic{color:var(--epic)}
    .rar.legendary{color:var(--legend)}

    .grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:12px;
    }
    .card{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(11,18,48,.55);
      border-radius:18px;
      padding:12px;
      backdrop-filter: blur(10px);
      box-shadow:0 12px 40px rgba(0,0,0,.25);
    }
    .card h3{
      margin:0 0 8px;
      font-family:"Orbitron", system-ui, sans-serif;
      font-weight:800;
      font-size:14px;
      letter-spacing:.4px;
    }
    .muted{color:var(--muted); font-size:13px; line-height:1.5; margin:0}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .inp{
      width:min(320px, 100%);
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      font-weight:800;
    }
    .inp:focus{border-color:rgba(124,255,234,.7)}
    .lbList{display:grid; gap:8px; margin-top:10px;}
    .lbRow{
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      font-size:13px;
    }
    .lbRow b{font-weight:950}
    .small{font-size:12px; color:var(--muted)}
    .shopGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    .item{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:126px;
    }
    .item .top{display:flex; justify-content:space-between; gap:8px; align-items:center;}
    .item .name{font-weight:950}
    .qty{
      display:inline-flex;
      min-width:26px;
      justify-content:center;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      font-size:12px;
      font-weight:950;
      white-space:nowrap;
    }
    .swatch{display:flex; gap:8px; align-items:center;}
    .dot{
      width:14px; height:14px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:#fff;
      box-shadow:0 8px 18px rgba(0,0,0,.25);
    }
    .skinBar{
      height:14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 10px 22px rgba(0,0,0,.25);
      flex:1;
      min-width:80px;
    }
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    @media (max-width:520px){ .shopGrid{grid-template-columns:1fr} }

    .gameScreen{position:fixed; inset:0; display:none; background:#050814;}
    .gameWrap{position:absolute; inset:0; display:flex; flex-direction:column;}

    .hud{
      position:absolute;
      top: max(10px, env(safe-area-inset-top));
      left: max(10px, env(safe-area-inset-left));
      right: max(10px, env(safe-area-inset-right));
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      z-index:10;
      pointer-events:none;
    }
    .hudLeft, .hudRight{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .pill{
      pointer-events:none;
      background:rgba(11,18,48,.68);
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      display:inline-flex; gap:6px; align-items:center;
      backdrop-filter: blur(10px);
    }
    .pill b{font-weight:950}
    .menuBtn{
      pointer-events:auto;
      width:40px; height:40px;
      display:grid; place-items:center;
      border-radius:12px;
      background:rgba(11,18,48,.75);
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      font-weight:950;
    }

    #game{
      flex:1;
      width:100%;
      height:100%;
      display:block;
      touch-action:none;
      background:#050814;
    }

    /* Premium joystick (mobile) */
    .joystickWrap{
      position:absolute;
      left: max(12px, env(safe-area-inset-left));
      bottom: max(12px, env(safe-area-inset-bottom));
      z-index:12;
      width:150px; height:150px;
      pointer-events:auto;
      display:none;
      user-select:none;
      touch-action:none;
    }
    .joyBase{
      width:150px; height:150px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:radial-gradient(circle at 35% 30%, rgba(124,255,234,.18), rgba(255,106,223,.10) 55%, rgba(0,0,0,.25) 100%);
      box-shadow:0 18px 55px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }
    .joyBase:after{
      content:"";
      position:absolute; inset:10px;
      border-radius:999px;
      border:1px dashed rgba(255,255,255,.16);
      opacity:.65;
    }
    .joyStick{
      width:64px; height:64px;
      border-radius:999px;
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      border:1px solid rgba(255,255,255,.22);
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), rgba(124,255,234,.22) 50%, rgba(0,0,0,.25));
      box-shadow:0 16px 45px rgba(0,0,0,.55);
    }
    .joyHint{
      position:absolute;
      left:0; right:0;
      top:-28px;
      text-align:left;
      font-size:12px;
      color:rgba(255,255,255,.78);
      text-shadow:0 10px 30px rgba(0,0,0,.5);
      font-weight:900;
      letter-spacing:.2px;
      pointer-events:none;
    }
    .joyHint b{color:var(--a)}
    @media (max-width:760px){
      .joystickWrap{display:block}
    }

    .overlay{
      position:absolute; inset:0;
      display:none;
      place-items:center;
      padding:16px;
      background:rgba(0,0,0,.60);
      backdrop-filter: blur(8px);
      z-index:30;
    }
    .modal{
      width:min(920px, 94vw);
      max-height: min(88vh, 900px);
      overflow:auto;
      background:rgba(11,18,48,.92);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      padding:14px;
      box-shadow:0 24px 70px rgba(0,0,0,.6);
    }
    .modal h2{
      margin:0 0 6px;
      font-family:"Orbitron", system-ui, sans-serif;
      font-weight:900;
      letter-spacing:.8px;
      font-size:16px;
    }
    .modal .split{display:grid; grid-template-columns: 1.2fr 1fr; gap:12px;}
    @media (max-width:900px){ .modal .split{grid-template-columns:1fr} }

    .toast{
      position:fixed;
      left:50%;
      bottom: max(16px, env(safe-area-inset-bottom));
      transform:translateX(-50%);
      background:rgba(11,18,48,.85);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;
      border-radius:14px;
      color:var(--text);
      font-size:13px;
      z-index:99;
      display:none;
      backdrop-filter: blur(10px);
      box-shadow:0 12px 40px rgba(0,0,0,.35);
      max-width:min(92vw, 520px);
      text-align:center;
    }
    .toastTop{
      position:fixed;
      left:50%;
      top: max(16px, env(safe-area-inset-top));
      transform:translateX(-50%);
      background:linear-gradient(135deg, rgba(124,255,234,.22), rgba(255,106,223,.18));
      border:1px solid rgba(255,255,255,.18);
      padding:10px 14px;
      border-radius:999px;
      color:var(--text);
      font-size:13px;
      z-index:100;
      display:none;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 50px rgba(0,0,0,.45);
      max-width:min(92vw, 520px);
      text-align:center;
      font-weight:950;
      letter-spacing:.2px;
    }
  </style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <h1>NEON HIGHWAY RACER</h1>
      <div class="sub">Tap Play to go fullscreen</div>
    </div>
    <div class="actions">
      <span class="chip">Player: <b id="playerName">Gamer</b></span>
      <span class="chip">Rank <b id="rankChip">Rookie</b></span>
      <span class="chip">Bank ü™ô <b id="bankCoins">0</b></span>
      <span class="chip">Best <b id="bestScore">0</b></span>
      <button id="audioBtn">üîä Audio</button>
      <button id="playFromTop">‚ñ∂ Play</button>
    </div>
  </div>

  <!-- HOME -->
  <div class="home" id="home">
    <div class="hero">
      <div class="heroRow">
        <div>
          <p class="heroTitle">Race. Dodge. Collect. Flex your rank.</p>
          <p class="muted">Start easy, get hooked, then chase the leaderboard. Combo multipliers + ghost racing makes it competitive.</p>
        </div>
        <div class="row">
          <button id="playBtn">‚ñ∂ Play Fullscreen</button>
          <button id="howBtn">üìò How to Play</button>
          <button id="feedbackBtn">üí¨ Feedback</button>
        </div>
      </div>
      <div class="chips">
        <span class="chip">Lives per run: <b>2</b></span>
        <span class="chip">Revive: <b>100 coins</b></span>
        <span class="chip">Combo: <b>Near-miss + drift</b> ‚Üí multiplier</span>
        <span class="chip">Bonus Round: <b>12s</b> @ 500 then +1000</span>
      </div>
    </div>

    <div class="card">
      <h3>Player name</h3>
      <p class="muted">Your name is stored on this device.</p>
      <div class="row" style="margin-top:10px">
        <input class="inp" id="nameInput" maxlength="18" placeholder="Enter name (default: Gamer)" />
        <button id="saveName">Save</button>
        <button id="claimBonus">Daily Reward</button>
      </div>
      <p class="small" id="bonusInfo" style="margin-top:8px"></p>
    </div>

    <div class="card">
      <h3>Daily Crate</h3>
      <p class="muted">Open once per day. Drops coins, buffs, or skins (Common/Rare/Epic only ‚Äî no Legendary).</p>
      <div class="row" style="margin-top:10px">
        <button id="crateBtn">üéÅ Open Daily Crate</button>
        <span class="chip">Status: <b id="crateStatus">Ready</b></span>
      </div>
      <p class="small" id="crateInfo" style="margin-top:8px"></p>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Daily Tasks</h3>
        <p class="muted">3 random missions each day. Complete and claim coins.</p>
        <div id="missions" style="margin-top:10px; display:grid; gap:10px;"></div>
      </div>

      <div class="card">
        <h3>Leaderboard (Top 10)</h3>
        <p class="muted" id="lbStatus">Loading‚Ä¶</p>
        <div class="lbList" id="lbList"></div>
      </div>
    </div>

    <div class="card">
      <h3>Shop (buy before you play)</h3>
      <p class="muted">Buffs also spawn on lanes. Shop buffs stack into your next run.</p>
      <div class="shopGrid" id="shop"></div>
    </div>

    <div class="card">
      <h3>Skins</h3>
      <p class="muted">Cosmetics only. Buy once, use forever.</p>
      <div class="shopGrid" id="skins"></div>
    </div>

    <div class="card" id="how">
      <h3>How to Play</h3>
      <p class="muted">
        Desktop: A/D or ‚Üê/‚Üí steer, ‚Üë nitro, Shift drift, Space pause. <br/>
        Mobile: Use the joystick (left/right to steer, up to nitro, hard left/right = drift bonus). <br/>
        Avoid obstacles, collect coins and buffs. Bonus round spawns only coins & buffs (no obstacles).
      </p>
    </div>

    <div class="card">
      <h3>Contact / Feedback</h3>
      <p class="muted">Tap ‚ÄúFeedback‚Äù to message <b>@daily__discipline.01</b> via Instagram DM.</p>
    </div>

    <div class="card">
      <h3>Privacy / Terms</h3>
      <p class="muted">
        We store player name, best score, coins, missions, crate state, skins, and ghost data in your browser (localStorage).
        Leaderboard stores your name + best score online (if enabled).
      </p>
      <p class="small" style="margin-top:10px">
        Optional audio files: <b>/assets/bgm.mp3</b>, <b>/assets/sfx_coin.mp3</b>, <b>/assets/sfx_pickup.mp3</b>,
        <b>/assets/sfx_crash.mp3</b>, <b>/assets/sfx_bonus.mp3</b>
      </p>
    </div>
  </div>

  <!-- GAME -->
  <div class="gameScreen" id="gameScreen" aria-hidden="true">
    <div class="gameWrap">
      <div class="hud">
        <div class="hudLeft">
          <div class="pill">Score <b id="hudScore">0</b></div>
          <div class="pill">Best <b id="hudBest">0</b></div>
          <div class="pill">Run ü™ô <b id="hudRunCoins">0</b></div>
          <div class="pill">Lives <b id="hudLives">2</b></div>
          <div class="pill">Rank <b id="hudRank">Rookie</b></div>
          <div class="pill" id="hudCombo" style="display:none">üî• Combo <b id="hudComboV">x1</b></div>
          <div class="pill" id="hudBonus" style="display:none">BONUS <b id="hudBonusT">12.0</b>s</div>
          <div class="pill" id="hudGhost" style="display:none">üëª Ghost <b>ON</b></div>
        </div>
        <div class="hudRight">
          <button class="menuBtn" id="menuBtn" title="Menu">‚ò∞</button>
        </div>
      </div>

      <canvas id="game"></canvas>

      <!-- Joystick -->
      <div class="joystickWrap" id="joystickWrap">
        <div class="joyHint">Joystick: <b>up = nitro</b> ‚Ä¢ hard left/right = drift</div>
        <div class="joyBase" id="joyBase">
          <div class="joyStick" id="joyStick"></div>
        </div>
      </div>

      <div class="overlay" id="overlay">
        <div class="modal">
          <h2>Menu</h2>
          <p class="muted" style="margin-top:0">Resume, restart, shop, tasks, leaderboard, fullscreen, share, feedback.</p>

          <div class="split">
            <div class="card" style="background:rgba(0,0,0,.18)">
              <h3>Quick</h3>
              <div class="row">
                <button id="resumeBtn">‚ñ∂ Resume</button>
                <button id="restartBtn">üîÅ Restart</button>
                <button id="exitBtn">üè† Home</button>
              </div>
              <div class="row" style="margin-top:10px">
                <button id="fsBtn">‚õ∂ Fullscreen</button>
                <button id="shareBtn">üì§ Share</button>
                <button id="fbBtn2">üí¨ Feedback</button>
              </div>

              <div class="row" style="margin-top:12px">
                <span class="chip">Player: <b id="menuPlayer">Gamer</b></span>
                <span class="chip">Rank <b id="menuRank">Rookie</b></span>
                <span class="chip">Bank ü™ô <b id="menuBank">0</b></span>
                <span class="chip">Best <b id="menuBest">0</b></span>
              </div>

              <div class="card" style="margin-top:12px; background:rgba(11,18,48,.55)">
                <h3>Revive</h3>
                <p class="muted">If you lose all lives, you can revive once per run for <b>100 coins</b>.</p>
                <button id="reviveBtn" disabled>‚ù§Ô∏è Revive (100)</button>
                <p class="small" id="reviveHint" style="margin-top:8px"></p>
              </div>
            </div>

            <div>
              <div class="card" style="background:rgba(0,0,0,.18)">
                <h3>Leaderboard</h3>
                <p class="muted" id="lbStatus2">Loading‚Ä¶</p>
                <div class="lbList" id="lbList2"></div>
              </div>

              <div class="card" style="margin-top:12px; background:rgba(0,0,0,.18)">
                <h3>Shop (next run)</h3>
                <p class="muted">Buy buffs before restarting or exiting to home.</p>
                <div class="shopGrid" id="shop2"></div>
              </div>

              <div class="card" style="margin-top:12px; background:rgba(0,0,0,.18)">
                <h3>Skins</h3>
                <p class="muted">Cosmetics only.</p>
                <div class="shopGrid" id="skins2"></div>
              </div>

              <div class="card" style="margin-top:12px; background:rgba(0,0,0,.18)">
                <h3>Daily Crate</h3>
                <p class="muted">No Legendary drops.</p>
                <div class="row" style="margin-top:10px">
                  <button id="crateBtn2">üéÅ Open</button>
                  <span class="chip">Status: <b id="crateStatus2">Ready</b></span>
                </div>
                <p class="small" id="crateInfo2" style="margin-top:8px"></p>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top:12px; background:rgba(0,0,0,.18)">
            <h3>Daily Tasks</h3>
            <div id="missions2" style="margin-top:10px; display:grid; gap:10px;"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="toastTop" id="toastTop"></div>
<div class="toast" id="toast"></div>

<script>
(() => {
  // =========================
  // SUPABASE CONFIG (yours)
  // =========================
  const SUPABASE_URL = "https://dnyibstgahnjbkjo.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_1PLhDg4aoFucc0-7qWH0KA_unYKueat";

  const SB = {
    enabled: () => Boolean(SUPABASE_URL && SUPABASE_ANON_KEY),
    headers: () => ({
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    }),
    async rpcUpsert(name, score){
      if (!this.enabled()) return;
      await fetch(`${SUPABASE_URL}/rest/v1/rpc/upsert_leaderboard`,{
        method:"POST",
        headers:this.headers(),
        body: JSON.stringify({ p_name:name, p_score:score })
      });
    },
    async top10(){
      if (!this.enabled()) return null;
      const res = await fetch(`${SUPABASE_URL}/rest/v1/leaderboard?select=name,score&order=score.desc&limit=10`,{
        headers:this.headers()
      });
      if(!res.ok) throw new Error("lb_fetch");
      return await res.json();
    }
  };

  // =========================
  // DOM
  // =========================
  const home = document.getElementById("home");
  const gameScreen = document.getElementById("gameScreen");
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d", { alpha:false });

  const playerNameEl = document.getElementById("playerName");
  const bankCoinsEl = document.getElementById("bankCoins");
  const bestScoreEl = document.getElementById("bestScore");
  const rankChipEl = document.getElementById("rankChip");

  const audioBtn = document.getElementById("audioBtn");

  const nameInput = document.getElementById("nameInput");
  const saveNameBtn = document.getElementById("saveName");
  const claimBonusBtn = document.getElementById("claimBonus");
  const bonusInfo = document.getElementById("bonusInfo");

  const crateBtn = document.getElementById("crateBtn");
  const crateBtn2 = document.getElementById("crateBtn2");
  const crateStatus = document.getElementById("crateStatus");
  const crateStatus2 = document.getElementById("crateStatus2");
  const crateInfo = document.getElementById("crateInfo");
  const crateInfo2 = document.getElementById("crateInfo2");

  const playBtn = document.getElementById("playBtn");
  const playFromTop = document.getElementById("playFromTop");
  const howBtn = document.getElementById("howBtn");

  const feedbackBtn = document.getElementById("feedbackBtn");
  const fbBtn2 = document.getElementById("fbBtn2");

  const missionsEl = document.getElementById("missions");
  const missions2El = document.getElementById("missions2");

  const lbStatusEl = document.getElementById("lbStatus");
  const lbListEl = document.getElementById("lbList");
  const lbStatus2El = document.getElementById("lbStatus2");
  const lbList2El = document.getElementById("lbList2");

  const shopEl = document.getElementById("shop");
  const shop2El = document.getElementById("shop2");

  const skinsEl = document.getElementById("skins");
  const skins2El = document.getElementById("skins2");

  const hudScore = document.getElementById("hudScore");
  const hudBest = document.getElementById("hudBest");
  const hudRunCoins = document.getElementById("hudRunCoins");
  const hudLives = document.getElementById("hudLives");
  const hudRank = document.getElementById("hudRank");
  const hudBonus = document.getElementById("hudBonus");
  const hudBonusT = document.getElementById("hudBonusT");
  const hudCombo = document.getElementById("hudCombo");
  const hudComboV = document.getElementById("hudComboV");
  const hudGhost = document.getElementById("hudGhost");

  const menuBtn = document.getElementById("menuBtn");
  const overlay = document.getElementById("overlay");
  const resumeBtn = document.getElementById("resumeBtn");
  const restartBtn = document.getElementById("restartBtn");
  const exitBtn = document.getElementById("exitBtn");
  const shareBtn = document.getElementById("shareBtn");
  const fsBtn = document.getElementById("fsBtn");

  const reviveBtn = document.getElementById("reviveBtn");
  const reviveHint = document.getElementById("reviveHint");

  const menuPlayer = document.getElementById("menuPlayer");
  const menuBank = document.getElementById("menuBank");
  const menuBest = document.getElementById("menuBest");
  const menuRank = document.getElementById("menuRank");

  const joystickWrap = document.getElementById("joystickWrap");
  const joyBase = document.getElementById("joyBase");
  const joyStick = document.getElementById("joyStick");

  const toastEl = document.getElementById("toast");
  const toastTopEl = document.getElementById("toastTop");

  // =========================
  // UTIL
  // =========================
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const lerp=(a,b,t)=>a+(b-a)*t;
  const rand=(a,b)=>a+Math.random()*(b-a);
  const randi=(a,b)=>Math.floor(rand(a,b+1));

  function toast(msg, ms=1500){
    toastEl.textContent = msg;
    toastEl.style.display="block";
    clearTimeout(toastEl._t);
    toastEl._t=setTimeout(()=>toastEl.style.display="none", ms);
  }
  function toastTop(msg, ms=1600){
    toastTopEl.textContent = msg;
    toastTopEl.style.display="block";
    clearTimeout(toastTopEl._t);
    toastTopEl._t=setTimeout(()=>toastTopEl.style.display="none", ms);
  }

  function todayISO(){
    const d=new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  function openInstagramDM(username){
    const deep=`instagram://direct/new?username=${encodeURIComponent(username)}`;
    const web1=`https://ig.me/m/${encodeURIComponent(username)}`;
    const web2=`https://www.instagram.com/direct/new/?username=${encodeURIComponent(username)}`;

    const a=document.createElement("a");
    a.href=deep; a.style.display="none";
    document.body.appendChild(a); a.click(); a.remove();

    setTimeout(()=>{
      const w=window.open(web1,"_blank","noopener,noreferrer");
      if(!w) location.href=web2;
    },250);
  }

  let inputFocus=false;
  function wireInputFocus(el){
    el.addEventListener("focus", ()=>inputFocus=true);
    el.addEventListener("blur", ()=>inputFocus=false);
  }
  wireInputFocus(nameInput);

  // =========================
  // AUDIO (optional assets/*)
  // =========================
  const SETTINGS_KEY = "neon_racer_settings_v2";
  let settings = (() => {
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY) || "null"); } catch { return null; }
  })() || { musicOn:true, sfxOn:true, musicVol:0.55, sfxVol:0.85 };

  function saveSettings(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }

  let audioReady = false;
  const audio = {
    bgm: new Audio("assets/bgm.mp3"),
    sfx: {
      coin:  new Audio("assets/sfx_coin.mp3"),
      pickup:new Audio("assets/sfx_pickup.mp3"),
      crash: new Audio("assets/sfx_crash.mp3"),
      bonus: new Audio("assets/sfx_bonus.mp3"),
      crate: new Audio("assets/sfx_bonus.mp3"),
    }
  };

  function applyAudioSettings(){
    audio.bgm.loop = true;
    audio.bgm.volume = settings.musicOn ? settings.musicVol : 0;
    for(const k in audio.sfx){
      audio.sfx[k].volume = settings.sfxOn ? settings.sfxVol : 0;
    }
  }

  async function initAudioFromGesture(){
    if(audioReady) return;
    audioReady = true;
    applyAudioSettings();
    try{
      audio.bgm.muted = true;
      await audio.bgm.play();
      audio.bgm.pause();
      audio.bgm.currentTime = 0;
      audio.bgm.muted = false;
    }catch{}
  }

  function playBgm(){
    if(!settings.musicOn) return;
    applyAudioSettings();
    audio.bgm.play().catch(()=>{});
  }
  function pauseBgm(){ audio.bgm.pause(); }
  function sfx(name){
    if(!settings.sfxOn) return;
    const a = audio.sfx[name];
    if(!a) return;
    try{ a.currentTime = 0; a.play().catch(()=>{}); }catch{}
  }

  function syncAudioBtn(){
    audioBtn.textContent = (settings.musicOn || settings.sfxOn) ? "üîä Audio" : "üîá Muted";
  }
  syncAudioBtn();

  audioBtn.addEventListener("click", async ()=>{
    await initAudioFromGesture();
    const next = !(settings.musicOn || settings.sfxOn);
    settings.musicOn = next;
    settings.sfxOn = next;
    saveSettings();
    applyAudioSettings();
    if(running && !paused && next) playBgm(); else pauseBgm();
    syncAudioBtn();
    toast(next ? "Audio ON" : "Muted");
  });

  // =========================
  // PROFILE
  // =========================
  const PROFILE_KEY="neon_racer_profile_v3";
  function loadProfile(){
    try{ return JSON.parse(localStorage.getItem(PROFILE_KEY)||"null"); }catch{ return null; }
  }
  function saveProfile(){ localStorage.setItem(PROFILE_KEY, JSON.stringify(profile)); }

  let _saveCooldown = 0;
  function saveProfileThrottled(dt){
    _saveCooldown -= dt;
    if(_saveCooldown <= 0){
      _saveCooldown = 0.55;
      saveProfile();
    }
  }

  let profile = loadProfile() || {
    name:"Gamer",
    bestScore:0,
    bankCoins:0,
    streakDaysClaimed:0,
    lastBonusDate:null,
    missionsDate:null,
    missions:[],
    ownedSkins:["common_500_c0_d0"],
    skin:"common_500_c0_d0",
    lastCrateDate:null,
    ghost:null
  };

  profile.ownedSkins ||= ["common_500_c0_d0"];
  profile.skin ||= "common_500_c0_d0";
  profile.lastCrateDate ||= null;
  profile.ghost ||= null;

  function dailyBonusForDay(n){ return 40 + n*10; }
  function bonusPreview(){
    if(profile.streakDaysClaimed>=7) return "Daily reward: Completed ‚úÖ";
    const d=profile.streakDaysClaimed+1;
    return `Daily reward: +${dailyBonusForDay(d)} coins (Day ${d}/7)`;
  }
  function claimDailyBonus(){
    const t=todayISO();
    if(profile.lastBonusDate===t) return {ok:false,msg:"Already claimed today."};
    if(profile.streakDaysClaimed>=7){
      profile.lastBonusDate=t; saveProfile();
      return {ok:false,msg:"7-day reward completed."};
    }
    const day=profile.streakDaysClaimed+1;
    const amt=dailyBonusForDay(day);
    profile.bankCoins += amt;
    profile.streakDaysClaimed += 1;
    profile.lastBonusDate = t;
    saveProfile();
    return {ok:true,msg:`+${amt} coins claimed! (Day ${day}/7)`};
  }

  // =========================
  // RANKS (competitive identity)
  // =========================
  const RANKS = [
    { name:"Rookie", min:0 },
    { name:"Street Racer", min:500 },
    { name:"Neon Pro", min:1500 },
    { name:"Highway Phantom", min:3000 },
    { name:"Neon Legend", min:6000 },
  ];
  function rankFor(score){
    let r = RANKS[0].name;
    for(const x of RANKS){
      if(score >= x.min) r = x.name;
    }
    return r;
  }

  // =========================
  // MISSIONS
  // =========================
  function newMission(){
    const types=["passCars","collectCoins","closeCalls"];
    const type=types[randi(0,types.length-1)];
    if(type==="passCars"){
      const target=[10,15,20,25][randi(0,3)];
      return {type,target,progress:0,reward:Math.round(target*1.1),claimed:false};
    }
    if(type==="collectCoins"){
      const target=[20,25,30,40][randi(0,3)];
      return {type,target,progress:0,reward:Math.round(target*0.9),claimed:false};
    }
    const target=[4,6,8][randi(0,2)];
    return {type,target,progress:0,reward:target*8,claimed:false};
  }
  function ensureDailyMissions(){
    const t=todayISO();
    if(profile.missionsDate===t && Array.isArray(profile.missions) && profile.missions.length===3) return;
    const ms=[];
    while(ms.length<3){
      const m=newMission();
      if(!ms.some(x=>x.type===m.type)) ms.push(m);
      else if(Math.random()<0.35) ms.push(m);
    }
    profile.missionsDate=t;
    profile.missions=ms.slice(0,3);
    saveProfile();
  }
  function missionTitle(m){
    if(m.type==="passCars") return `Pass ${m.target} cars`;
    if(m.type==="collectCoins") return `Collect ${m.target} coins`;
    return `Close calls ${m.target} times`;
  }
  function renderMissions(where){
    where.innerHTML="";
    profile.missions.forEach((m,idx)=>{
      const pct=Math.round(clamp(m.progress/m.target,0,1)*100);
      const div=document.createElement("div");
      div.className="lbRow";
      div.innerHTML=`
        <div>
          <b>${escapeHtml(missionTitle(m))}</b>
          <div class="small">${m.progress}/${m.target}</div>
          <div style="height:8px;border-radius:999px;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.10);overflow:hidden;margin-top:8px">
            <i style="display:block;height:100%;width:${pct}%;background:rgba(255,210,77,.9)"></i>
          </div>
        </div>
        <div style="text-align:right">
          <div><b>+${m.reward} ü™ô</b></div>
          <button data-claim="${idx}" style="margin-top:8px" ${m.claimed || m.progress<m.target ? "disabled":""}>
            ${m.claimed ? "Claimed" : (m.progress<m.target ? "In progress" : "Claim")}
          </button>
        </div>
      `;
      where.appendChild(div);
    });

    where.querySelectorAll("button[data-claim]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const idx=Number(btn.getAttribute("data-claim"));
        const m=profile.missions[idx];
        if(!m || m.claimed || m.progress<m.target) return;
        m.claimed=true;
        profile.bankCoins += m.reward;
        saveProfile();
        syncHomeUI();
        renderMissions(missionsEl);
        renderMissions(missions2El);
        toast(`+${m.reward} coins claimed!`);
      });
    });
  }

  // =========================
  // SHOP (buffs) ‚Äî exact prices
  // =========================
  const cart = { shield:0, magnet:0, slowmo:0, nitro:0, invisibility:0, extraLife:0 };
  const SHOP = [
    { key:"shield",       name:"üõ° Shield",        desc:"Blocks 1 crash. (Run)", base: 40,  max:2 },
    { key:"nitro",        name:"üöÄ Nitro+",        desc:"Start with extra nitro.", base: 30,  max:3 },
    { key:"slowmo",       name:"‚è± Slow-Motion",   desc:"Obstacles 5√ó slower.", base: 40,  max:3 },
    { key:"invisibility", name:"üëª Invisibility",  desc:"Phase through cars.", base: 60,  max:2 },
    { key:"extraLife",    name:"‚ù§Ô∏è Extra Life",   desc:"Adds +1 life this run.", base: 100, max:2 },
    { key:"magnet",       name:"üß≤ Magnet",        desc:"Pulls ALL coins to you (7s).", base: 70, max:3 },
  ];
  function priceFor(itemKey){
    const it=SHOP.find(x=>x.key===itemKey);
    return Math.round(it?.base || 50);
  }
  function renderShop(where){
    where.innerHTML="";
    SHOP.forEach(it=>{
      const qty=cart[it.key]||0;
      const cost=priceFor(it.key);
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML=`
        <div class="top">
          <div class="name">${escapeHtml(it.name)}</div>
          <span class="qty">${qty}</span>
        </div>
        <div class="small">${escapeHtml(it.desc)}</div>
        <div class="row" style="margin-top:auto;justify-content:space-between">
          <button data-buy="${it.key}">Buy</button>
          <span class="small">Cost: <b>${cost}</b> ü™ô</span>
        </div>
      `;
      where.appendChild(div);
    });

    where.querySelectorAll("button[data-buy]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const k=btn.getAttribute("data-buy");
        const it=SHOP.find(x=>x.key===k);
        if(!it) return;
        const cost=priceFor(k);
        if(profile.bankCoins < cost) return toast("Not enough coins.");
        if((cart[k]||0) >= it.max) return toast("Max for this item reached.");
        profile.bankCoins -= cost;
        cart[k] = (cart[k]||0)+1;
        saveProfile();
        syncHomeUI();
        renderShop(shopEl);
        renderShop(shop2El);
        toast(`Bought ${it.name}`);
      });
    });
  }

  // =========================
  // SKINS (show colors only)
  // =========================
  const RARITY_ORDER = { common:0, rare:1, epic:2, legendary:3 };

  const SKINS = [
    { rarity:"common", cost:500,  hex:["#4df6ff","#ff5cd6"], key:"common_500_c0_d0" },
    { rarity:"common", cost:600,  hex:["#33ff99","#6f7bff"], key:"common_600_c1_d1" },
    { rarity:"common", cost:700,  hex:["#ffd24d","#ff6adf"], key:"common_700_c2_d2" },
    { rarity:"common", cost:800,  hex:["#6fd6ff","#ff7fb0"], key:"common_800_c3_d3" },
    { rarity:"common", cost:900,  hex:["#b6ff4d","#6f7bff"], key:"common_900_c4_d4" },

    { rarity:"rare", cost:1200, hex:["#00fff0","#ff2bd6"], key:"rare_1200_c5_d5" },
    { rarity:"rare", cost:1400, hex:["#ffd24d","#3aa0ff"], key:"rare_1400_c6_d6" },
    { rarity:"rare", cost:1600, hex:["#00d6c7","#ff38d1"], key:"rare_1600_c7_d7" },
    { rarity:"rare", cost:1750, hex:["#33ff99","#8f4dff"], key:"rare_1750_c8_d8" },
    { rarity:"rare", cost:1900, hex:["#ff6b6b","#a8f0ff"], key:"rare_1900_c9_d9" },

    { rarity:"epic", cost:2500, hex:["#b84dff","#4df6ff"], key:"epic_2500_c10_d10" },
    { rarity:"epic", cost:2800, hex:["#ff2e4d","#ffd24d"], key:"epic_2800_c11_d11" },
    { rarity:"epic", cost:3200, hex:["#33ffdd","#ff5cd6"], key:"epic_3200_c12_d12" },
    { rarity:"epic", cost:3500, hex:["#ff8a2b","#8f4dff"], key:"epic_3500_c13_d13" },
    { rarity:"epic", cost:3900, hex:["#bff6ff","#ff2bd6"], key:"epic_3900_c14_d14" },

    { rarity:"legendary", cost:5000, hex:["#ffd24d","#6b2bff"], key:"legendary_5000_c15_d15" },
    { rarity:"legendary", cost:5000, hex:["#4df6ff","#ff2e4d"], key:"legendary_5000_c16_d16" },
    { rarity:"legendary", cost:5000, hex:["#33ff99","#ff5cd6"], key:"legendary_5000_c17_d17" },
    { rarity:"legendary", cost:5000, hex:["#111111","#ffd24d"], key:"legendary_5000_c18_d18" },
  ];

  if(!SKINS.some(s => s.key === profile.skin)){
    profile.skin = SKINS[0].key;
    if(!profile.ownedSkins.includes(profile.skin)) profile.ownedSkins.push(profile.skin);
    saveProfile();
  }
  function getSkin(){ return SKINS.find(s=>s.key===profile.skin) || SKINS[0]; }

  function renderSkins(where){
    where.innerHTML="";
    const list = [...SKINS].sort((a,b)=>{
      const ra = RARITY_ORDER[a.rarity] ?? 9;
      const rb = RARITY_ORDER[b.rarity] ?? 9;
      if(ra !== rb) return ra - rb;
      return a.cost - b.cost;
    });

    list.forEach(s=>{
      const owned = profile.ownedSkins.includes(s.key);
      const selected = profile.skin === s.key;

      const div=document.createElement("div");
      div.className="item";
      div.innerHTML=`
        <div class="top">
          <div class="swatch" style="flex:1">
            <span class="chip rar ${s.rarity}">${s.rarity.toUpperCase()}</span>
            <span class="dot" style="background:${s.hex[0]}"></span>
            <span class="dot" style="background:${s.hex[1]}"></span>
            <span class="skinBar" style="background:linear-gradient(135deg, ${s.hex[0]}, ${s.hex[1]});"></span>
          </div>
          <span class="qty">${owned ? "OWNED" : (s.cost+" ü™ô")}</span>
        </div>
        <div class="row" style="margin-top:auto;justify-content:space-between">
          <button data-skin="${s.key}">${owned ? (selected ? "Selected" : "Select") : "Buy"}</button>
          <span class="small">${selected ? "Using ‚úÖ" : (owned ? "Tap Select" : "")}</span>
        </div>
      `;
      where.appendChild(div);
    });

    where.querySelectorAll("button[data-skin]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const k=btn.getAttribute("data-skin");
        const s=SKINS.find(x=>x.key===k);
        if(!s) return;

        const owned = profile.ownedSkins.includes(k);
        if(!owned){
          if(profile.bankCoins < s.cost) return toast("Not enough coins.");
          profile.bankCoins -= s.cost;
          profile.ownedSkins.push(k);
          toast("Skin unlocked!");
        }
        profile.skin = k;
        saveProfile();
        syncHomeUI();
        renderSkins(skinsEl);
        renderSkins(skins2El);
      });
    });
  }

  // =========================
  // DAILY CRATE (no legendary)
  // =========================
  function crateReady(){ return profile.lastCrateDate !== todayISO(); }
  function syncCrateUI(){
    const ready = crateReady();
    const st = ready ? "Ready" : "Claimed";
    crateStatus.textContent = st;
    crateStatus2.textContent = st;
    crateBtn.disabled = !ready;
    crateBtn2.disabled = !ready;
    crateInfo.textContent = ready ? "Tap to open your daily crate!" : "Come back tomorrow for another crate.";
    crateInfo2.textContent = crateInfo.textContent;
  }
  function pickWeighted(items){
    const total = items.reduce((s,x)=>s + x.w, 0);
    let r = Math.random() * total;
    for(const it of items){
      r -= it.w;
      if(r <= 0) return it;
    }
    return items[items.length-1];
  }
  function grantBuffToCart(key, amt=1){
    if(!(key in cart)) return false;
    cart[key] = clamp((cart[key]||0) + amt, 0, 99);
    return true;
  }
  function openDailyCrate(){
    if(!crateReady()) return toast("Already claimed today.");

    const drop = pickWeighted([
      { type:"coins", w: 45 },
      { type:"buff",  w: 40 },
      { type:"skin",  w: 15 },
    ]);

    let msg = "";
    if(drop.type === "coins"){
      const amt = [120,150,180,220,260][randi(0,4)];
      profile.bankCoins += amt;
      msg = `Daily Crate: +${amt} coins ü™ô`;
    }

    if(drop.type === "buff"){
      const buffDrop = pickWeighted([
        { key:"shield",       w: 18 },
        { key:"nitro",        w: 18 },
        { key:"slowmo",       w: 16 },
        { key:"magnet",       w: 16 },
        { key:"invisibility", w: 12 },
        { key:"extraLife",    w: 6  },
        { key:"coinsSmall",   w: 14 },
      ]);

      if(buffDrop.key === "coinsSmall"){
        const amt = [60,80,100,120][randi(0,3)];
        profile.bankCoins += amt;
        msg = `Daily Crate: +${amt} coins ü™ô`;
      }else{
        grantBuffToCart(buffDrop.key, 1);
        const name = SHOP.find(x=>x.key===buffDrop.key)?.name || buffDrop.key;
        msg = `Daily Crate: +1 ${name} (next run)`;
      }
    }

    if(drop.type === "skin"){
      const eligible = SKINS.filter(s => s.rarity !== "legendary");
      const rarityPick = pickWeighted([
        { rarity:"common", w: 70 },
        { rarity:"rare",   w: 24 },
        { rarity:"epic",   w: 6  },
      ]);
      const pool = eligible.filter(s => s.rarity === rarityPick.rarity);
      const s = pool[randi(0, pool.length-1)];
      const already = profile.ownedSkins.includes(s.key);

      if(already){
        const comp = s.rarity==="common" ? 220 : (s.rarity==="rare" ? 450 : 800);
        profile.bankCoins += comp;
        msg = `Daily Crate: Duplicate skin ‚Üí +${comp} coins ü™ô`;
      }else{
        profile.ownedSkins.push(s.key);
        msg = `Daily Crate: Skin unlocked! (${s.rarity.toUpperCase()})`;
      }
    }

    profile.lastCrateDate = todayISO();
    saveProfile();
    syncHomeUI();
    renderShop(shopEl); renderShop(shop2El);
    renderSkins(skinsEl); renderSkins(skins2El);
    syncCrateUI();
    sfx("crate");
    toast(msg, 2200);
  }

  // =========================
  // LEADERBOARD (fallback)
  // =========================
  function renderLeaderboard(where, list){
    where.innerHTML="";
    list.forEach((x,i)=>{
      const row=document.createElement("div");
      row.className="lbRow";
      row.innerHTML=`<span>#${i+1} <b>${escapeHtml(x.name)}</b></span><span><b>${x.score}</b></span>`;
      where.appendChild(row);
    });
  }
  function showLeaderboardComingSoon(){
    lbStatusEl.textContent = "Leaderboard coming soon";
    lbStatus2El.textContent = "Leaderboard coming soon";
    lbListEl.innerHTML = "";
    lbList2El.innerHTML = "";
  }
  async function syncLeaderboard(){
    if(!SB.enabled()){
      showLeaderboardComingSoon();
      return;
    }
    try{
      lbStatusEl.textContent = "Loading‚Ä¶";
      lbStatus2El.textContent = "Loading‚Ä¶";
      const top = await SB.top10();
      const list = Array.isArray(top) ? top : [];
      if(!list.length){
        showLeaderboardComingSoon();
        return;
      }
      lbStatusEl.textContent = "Live leaderboard:";
      lbStatus2El.textContent = "Live leaderboard:";
      renderLeaderboard(lbListEl, list);
      renderLeaderboard(lbList2El, list);
    }catch{
      showLeaderboardComingSoon();
    }
  }
  async function submitScoreOnline(){
    try{
      if(SB.enabled()){
        await SB.rpcUpsert(profile.name || "Gamer", profile.bestScore || 0);
      }
    }catch{}
  }

  // =========================
  // HOME UI SYNC
  // =========================
  function syncHomeUI(){
    playerNameEl.textContent = profile.name || "Gamer";
    bankCoinsEl.textContent = profile.bankCoins || 0;
    bestScoreEl.textContent = profile.bestScore || 0;
    bonusInfo.textContent = bonusPreview();
    const r = rankFor(profile.bestScore||0);
    rankChipEl.textContent = r;

    menuPlayer.textContent = profile.name || "Gamer";
    menuBank.textContent = profile.bankCoins || 0;
    menuBest.textContent = profile.bestScore || 0;
    menuRank.textContent = r;
    hudRank.textContent = r;
  }

  // =========================
  // GAME CORE (addictive + insane)
  // =========================
  let dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
  let vw=1, vh=1;

  function resizeCanvas(){
    dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    const rect = canvas.getBoundingClientRect();
    vw = Math.max(1, rect.width);
    vh = Math.max(1, rect.height);
    canvas.width = Math.floor(vw * dpr);
    canvas.height = Math.floor(vh * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  const ro = new ResizeObserver(()=>resizeCanvas());
  ro.observe(canvas);

  // Keyboard input (desktop)
  const keys = new Set();
  window.addEventListener("keydown",(e)=>{
    if(inputFocus) return;
    const k=e.key.toLowerCase();
    keys.add(k);
    if(k===" "){ e.preventDefault(); togglePause(); }
    if(k==="r"){ e.preventDefault(); restartRun(); }
    if(["arrowleft","arrowright","arrowup","a","d","w","shift"].includes(k)) e.preventDefault();
  });
  window.addEventListener("keyup",(e)=>keys.delete(e.key.toLowerCase()));

  // Joystick state (mobile)
  const joy = { active:false, x:0, y:0, id:null, baseRect:null };
  function setStickPos(nx, ny){
    // nx,ny in [-1..1]
    joy.x = clamp(nx, -1, 1);
    joy.y = clamp(ny, -1, 1);

    const r = 52; // stick travel radius in px
    const px = joy.x * r;
    const py = joy.y * r;
    joyStick.style.transform = `translate(-50%,-50%) translate(${px}px, ${py}px)`;
  }
  function resetStick(){
    joy.active=false; joy.id=null;
    setStickPos(0,0);
  }
  joyBase.addEventListener("pointerdown", (e)=>{
    joy.active=true;
    joy.id=e.pointerId;
    joy.baseRect = joyBase.getBoundingClientRect();
    joyBase.setPointerCapture(joy.id);
    handleJoyMove(e);
  });
  joyBase.addEventListener("pointermove", (e)=>{
    if(!joy.active || e.pointerId!==joy.id) return;
    handleJoyMove(e);
  });
  joyBase.addEventListener("pointerup", (e)=>{
    if(e.pointerId!==joy.id) return;
    resetStick();
  });
  joyBase.addEventListener("pointercancel", (e)=>{
    if(e.pointerId!==joy.id) return;
    resetStick();
  });

  function handleJoyMove(e){
    const r = joy.baseRect || joyBase.getBoundingClientRect();
    const cx = r.left + r.width/2;
    const cy = r.top + r.height/2;
    const dx = e.clientX - cx;
    const dy = e.clientY - cy;

    const max = (r.width*0.5) - 18;
    const dist = Math.hypot(dx,dy);
    const nd = dist > 0 ? Math.min(1, dist/max) : 0;
    const nx = dist>0 ? (dx/dist)*nd : 0;
    const ny = dist>0 ? (dy/dist)*nd : 0;

    setStickPos(nx, ny);
  }

  // Road/lane geometry
  const laneCount=3;
  function laneW(){ return vw * 0.56 / laneCount; }
  function roadX(){ return vw * 0.22; }
  function roadW(){ return vw * 0.56; }
  function laneCenter(l){ return roadX() + laneW()*(l+0.5); }

  // Easy start + smooth ramp
  const DIFF = {
    baseSpeed: 150,
    accel: 3.8,
    spawnBase: 0.62,
    spawnRamp: 0.00095,
    laneChangeRate: 0.055,
    laneChangeSpeed: 3.1,
  };

  // Entities
  const player = { x:0, y:0, w:0, h:0, vx:0, lane:1 };
  const traffic=[], coins=[], pickups=[];
  const PICK_TYPES = ["shield","magnet","slowmo","nitro","invisibility"];

  // State
  let running=false, paused=false;
  let score=0, runCoins=0, lives=2, reviveUsed=false;
  let speed=DIFF.baseSpeed;
  let nitro=1.0, nitroActive=false;

  let buffShield=0, buffMagnet=0, buffSlowmo=0, buffInvisibility=0;
  let invulnT=0;

  // Bonus
  let inBonus=false, bonusT=0, nextBonusAt=500;
  let bonusCollected = { coins:0, shield:0, magnet:0, slowmo:0, nitro:0, invisibility:0 };
  let buffBackup=null;

  // Missions
  let passedCars=0, closeCalls=0;

  // Spawners
  let spawnT=0, coinT=0, pickT=0;
  let roadScroll=0;

  // Praise flags
  let praised1000=false;
  let praised50cars=false;

  // COMBO (addictive)
  let combo=0;
  let comboTimer=0;
  let lastNearMissId=-1;

  function comboMult(){
    // Smooth ladder; feels strong but not broken
    if(combo >= 18) return 3.0;
    if(combo >= 12) return 2.4;
    if(combo >= 8)  return 1.9;
    if(combo >= 5)  return 1.5;
    if(combo >= 3)  return 1.25;
    return 1.0;
  }
  function addCombo(n=1){
    combo = Math.min(25, combo + n);
    comboTimer = 4.0;
  }
  function decayCombo(dt){
    if(combo<=0) return;
    comboTimer -= dt;
    if(comboTimer <= 0){
      combo = 0;
      comboTimer = 0;
    }
  }

  // GHOST MODE (race your best run)
  // Stores x positions over time for best run
  let ghostPlay=null; // { xs:[], dt:0.08, t:0 }
  let ghostRec=null;  // { xs:[], dt:0.08, acc:0 }
  function startGhostPlayback(){
    if(profile.ghost && Array.isArray(profile.ghost.xs) && profile.ghost.xs.length>20){
      ghostPlay = { xs: profile.ghost.xs.slice(0), dt: profile.ghost.dt || 0.08, t:0 };
      hudGhost.style.display="inline-flex";
    }else{
      ghostPlay = null;
      hudGhost.style.display="none";
    }
  }
  function startGhostRecording(){
    ghostRec = { xs:[], dt:0.08, acc:0 };
  }
  function recordGhost(dt){
    if(!ghostRec) return;
    ghostRec.acc += dt;
    while(ghostRec.acc >= ghostRec.dt){
      ghostRec.acc -= ghostRec.dt;
      ghostRec.xs.push(player.x);
      // cap length (about 3 minutes)
      if(ghostRec.xs.length > 2400) ghostRec.xs.shift();
    }
  }
  function commitGhostIfBest(){
    const sc = Math.floor(score);
    if(!ghostRec) return;
    if(sc >= (profile.bestScore||0) && ghostRec.xs.length>30){
      profile.ghost = { xs: ghostRec.xs.slice(0), dt: ghostRec.dt };
      saveProfile();
    }
  }

  // Drawing helpers
  function rectHit(ax,ay,aw,ah, bx,by,bw,bh){
    const aL=ax-aw/2, aR=ax+aw/2, aT=ay-ah/2, aB=ay+ah/2;
    const bL=bx-bw/2, bR=bx+bw/2, bT=by-bh/2, bB=by+bh/2;
    return (aL<bR && aR>bL && aT<bB && aB>bT);
  }
  function distRect(ax,ay,aw,ah, bx,by,bw,bh){
    const aL=ax-aw/2, aR=ax+aw/2, aT=ay-ah/2, aB=ay+ah/2;
    const bL=bx-bw/2, bR=bx+bw/2, bT=by-bh/2, bB=by+bh/2;
    const dx=Math.max(bL-aR, aL-bR, 0);
    const dy=Math.max(bT-aB, aT-bB, 0);
    return Math.hypot(dx,dy);
  }
  function enforceRoadBarrier(){
    const innerMargin = Math.max(10, laneW()*0.18);
    const minX = roadX()+innerMargin;
    const maxX = roadX()+roadW()-innerMargin;
    player.x = clamp(player.x, minX, maxX);
  }

  function layoutPlayer(){
    player.w = clamp(vw*0.065, 36, 54);
    player.h = player.w * 1.75;
    player.y = vh*0.78;
    player.lane = 1;
    player.x = laneCenter(player.lane);
    player.vx = 0;
  }

  function resetRunState(){
    score=0; runCoins=0; passedCars=0; closeCalls=0;

    lives = 2 + (cart.extraLife||0);
    reviveUsed=false;

    speed=DIFF.baseSpeed;
    roadScroll=0;

    nitro = clamp(1.0 + (cart.nitro||0)*0.25, 0, 1.8);

    buffShield = (cart.shield||0);
    buffMagnet = (cart.magnet||0) * 7;
    buffSlowmo = (cart.slowmo||0) * 5;
    buffInvisibility  = (cart.invisibility||0)  * 6;

    invulnT = 0;

    for(const k in cart) cart[k]=0;
    renderShop(shopEl); renderShop(shop2El);

    traffic.length=0; coins.length=0; pickups.length=0;

    inBonus=false; bonusT=0;
    bonusCollected = { coins:0, shield:0, magnet:0, slowmo:0, nitro:0, invisibility:0 };
    buffBackup=null;
    nextBonusAt = 500;

    praised1000=false; praised50cars=false;

    combo=0; comboTimer=0; lastNearMissId=-1;

    startGhostPlayback();
    startGhostRecording();

    // reset joystick
    resetStick();
  }

  function requestFS(){
    const el = gameScreen;
    if(document.fullscreenElement) return;
    const fn = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
    try{ fn?.call(el); }catch{}
  }

  let countdown=null;
  function cinematicCountdown(onDone){ countdown = { t:0, phase:0, done:false, onDone }; }

  function startRun(){
    home.style.display="none";
    gameScreen.style.display="block";
    gameScreen.setAttribute("aria-hidden","false");

    requestFS();
    initAudioFromGesture().then(()=>playBgm());

    // Fix top-left flash by measuring first
    requestAnimationFrame(() => {
      resizeCanvas();
      layoutPlayer();
      resetRunState();
      running=true;
      paused=false;
      cinematicCountdown(()=>{});
      syncHUD();
    });
  }

  function exitToHome(){
    running=false; paused=false;
    overlay.style.display="none";
    gameScreen.style.display="none";
    gameScreen.setAttribute("aria-hidden","true");
    home.style.display="grid";
    pauseBgm();
    syncHomeUI();
    syncLeaderboard();
  }

  function openMenu(){
    paused=true;
    overlay.style.display="grid";
    pauseBgm();

    reviveBtn.disabled = true;
    reviveHint.textContent = "";

    syncHomeUI();
    renderMissions(missions2El);
    syncLeaderboard();
    renderShop(shop2El);
    renderSkins(skins2El);
    syncCrateUI();
  }
  function closeMenu(){
    if(!running) return;
    overlay.style.display="none";
    paused=false;
    playBgm();
  }
  function togglePause(){
    if(!running) return;
    if(paused) closeMenu(); else openMenu();
  }

  // Spawning
  function spawnTraffic(){
    const lane=randi(0,laneCount-1);
    const w=clamp(vw*0.06, 34, 50);
    const h=w*1.75;

    if(traffic.some(o=>o.lane===lane && o.y < vh*0.20)) return;

    traffic.push({
      id: (Math.random()*1e9)|0,
      lane,
      x: laneCenter(lane),
      targetLane: lane,
      y: -h,
      w, h,
      rel: rand(0.86, 1.02),
      cd: rand(1.0, 1.9),
      passed:false
    });
  }

  function spawnCoin(){
    const lane=randi(0,laneCount-1);
    const val = Math.random()<0.07 ? 10 : (Math.random()<0.18 ? 5 : 1);
    coins.push({
      lane,
      x: laneCenter(lane),
      y: -30,
      r: clamp(vw*0.012, 8, 12),
      val
    });
  }

  function spawnPickup(){
    const lane=randi(0,laneCount-1);
    const type = PICK_TYPES[randi(0,PICK_TYPES.length-1)];
    pickups.push({
      lane,
      type,
      x: laneCenter(lane),
      y: -40,
      r: clamp(vw*0.014, 9, 14)
    });
  }

  // Drawing
  function roundRect(x,y,w,h,r){
    const rr=Math.min(r,w/2,h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }

  // Dynamic color shift with progress (visually insane)
  function roadTint(score){
    const t = clamp(score/4000, 0, 1);
    // blue -> purple -> pink
    const a = lerp(0.10, 0.22, t);
    const b = lerp(0.10, 0.16, t);
    const c = lerp(0.14, 0.10, t);
    return { a,b,c };
  }

  function drawRoad(){
    ctx.fillStyle="#050814";
    ctx.fillRect(0,0,vw,vh);

    const tint = roadTint(score);
    ctx.fillStyle=`rgba(255,106,223,${0.08 + tint.b})`;
    ctx.fillRect(0,0, roadX(), vh);
    ctx.fillRect(roadX()+roadW(),0, vw-(roadX()+roadW()), vh);

    const grad=ctx.createLinearGradient(roadX(),0,roadX()+roadW(),0);
    grad.addColorStop(0,`rgba(20,240,255,${0.08 + tint.a})`);
    grad.addColorStop(0.5,`rgba(255,255,255,${0.04 + tint.c})`);
    grad.addColorStop(1,`rgba(255,70,220,${0.08 + tint.b})`);
    ctx.fillStyle=grad;
    roundRect(roadX(), 0, roadW(), vh, 22);
    ctx.fill();

    ctx.strokeStyle="rgba(255,255,255,.14)";
    ctx.lineWidth=2;
    roundRect(roadX(), 0, roadW(), vh, 22);
    ctx.stroke();

    ctx.save();
    ctx.beginPath();
    ctx.rect(roadX(),0,roadW(),vh);
    ctx.clip();
    ctx.strokeStyle="rgba(255,255,255,.20)";
    ctx.lineWidth=2;
    const lw=laneW();
    for(let i=1;i<laneCount;i++){
      const lx=roadX()+lw*i;
      for(let y=-80; y<vh+80; y+=60){
        const yy = y + (roadScroll%60);
        ctx.beginPath();
        ctx.moveTo(lx,yy);
        ctx.lineTo(lx,yy+26);
        ctx.stroke();
      }
    }
    ctx.restore();
  }

  // Neon trail (skin-colored)
  const trail = []; // {x,y,life}
  function addTrailPoint(){
    // fewer points if slow
    trail.push({ x: player.x, y: player.y + player.h*0.15, life: 1 });
    if(trail.length > 36) trail.shift();
  }
  function drawTrail(skin){
    if(trail.length < 3) return;
    ctx.save();
    ctx.globalAlpha = 1;

    for(let i=trail.length-1;i>=1;i--){
      const a = trail[i];
      const b = trail[i-1];
      const t = i/(trail.length-1);
      const alpha = 0.14 + (1-t)*0.22;
      ctx.strokeStyle = `rgba(124,255,234,${alpha})`;
      ctx.lineWidth = 10*(1-t);
      ctx.beginPath();
      ctx.moveTo(a.x,a.y);
      ctx.lineTo(b.x,b.y);
      ctx.stroke();

      // colorized overlay
      const col = (t<0.5) ? skin.hex[0] : skin.hex[1];
      ctx.strokeStyle = hexToRgba(col, alpha*0.9);
      ctx.lineWidth = 6*(1-t);
      ctx.beginPath();
      ctx.moveTo(a.x,a.y);
      ctx.lineTo(b.x,b.y);
      ctx.stroke();
    }

    ctx.restore();
  }

  function hexToRgba(hex, a){
    const h = hex.replace("#","");
    const r = parseInt(h.slice(0,2),16);
    const g = parseInt(h.slice(2,4),16);
    const b = parseInt(h.slice(4,6),16);
    return `rgba(${r},${g},${b},${a})`;
  }

  function drawCar(x,y,w,h,isPlayer,glowColor, skinHex, extraAlpha=1){
    ctx.save();
    ctx.globalAlpha = extraAlpha;

    // shadow
    ctx.fillStyle="rgba(0,0,0,.35)";
    ctx.beginPath();
    ctx.ellipse(x, y+h*0.12, w*0.52, h*0.10, 0, 0, Math.PI*2);
    ctx.fill();

    // underglow
    ctx.shadowBlur = isPlayer ? 26 : 18;
    ctx.shadowColor = glowColor;

    const bodyX=x-w/2, bodyY=y-h/2;
    const bodyGrad=ctx.createLinearGradient(bodyX, bodyY, bodyX+w, bodyY+h);

    const colors = (isPlayer && skinHex && skinHex.length>=2)
      ? skinHex
      : (isPlayer ? ["#4df6ff","#ff5cd6"] : ["#ff5cd6","#6f7bff"]);

    bodyGrad.addColorStop(0, colors[0]);
    bodyGrad.addColorStop(1, colors[1]);

    ctx.fillStyle=bodyGrad;
    roundRect(bodyX, bodyY, w, h, w*0.30);
    ctx.fill();

    ctx.shadowBlur=0;
    ctx.fillStyle="rgba(0,0,0,.42)";
    roundRect(x-w*0.28, y-h*0.18, w*0.56, h*0.30, w*0.20);
    ctx.fill();

    ctx.fillStyle="rgba(255,255,255,.10)";
    roundRect(x-w*0.20, y-h*0.36, w*0.40, h*0.20, w*0.18);
    ctx.fill();

    ctx.fillStyle="rgba(0,0,0,.78)";
    roundRect(x-w*0.55, y-h*0.28, w*0.22, h*0.24, 8); ctx.fill();
    roundRect(x+w*0.33, y-h*0.28, w*0.22, h*0.24, 8); ctx.fill();
    roundRect(x-w*0.55, y+h*0.04, w*0.22, h*0.24, 8); ctx.fill();
    roundRect(x+w*0.33, y+h*0.04, w*0.22, h*0.24, 8); ctx.fill();

    ctx.fillStyle="rgba(255,255,255,.92)";
    ctx.fillRect(x-w*0.34, y-h*0.44, w*0.18, 6);
    ctx.fillRect(x+w*0.16, y-h*0.44, w*0.18, 6);

    ctx.fillStyle="rgba(255,75,92,.88)";
    ctx.fillRect(x-w*0.34, y+h*0.40, w*0.18, 6);
    ctx.fillRect(x+w*0.16, y+h*0.40, w*0.18, 6);

    if(buffInvisibility>0 && isPlayer && !inBonus){
      ctx.globalAlpha = extraAlpha*0.35;
      ctx.strokeStyle="rgba(124,255,234,.95)";
      ctx.lineWidth=2;
      roundRect(bodyX-2, bodyY-2, w+4, h+4, w*0.30);
      ctx.stroke();
      ctx.globalAlpha = extraAlpha;
    }

    if(invulnT>0 && isPlayer){
      ctx.globalAlpha = extraAlpha*0.55;
      ctx.strokeStyle="rgba(255,210,77,.95)";
      ctx.lineWidth=2;
      roundRect(bodyX-4, bodyY-4, w+8, h+8, w*0.30);
      ctx.stroke();
      ctx.globalAlpha = extraAlpha;
    }

    ctx.restore();
  }

  function drawCoin(c){
    ctx.save();
    ctx.shadowBlur=18;
    ctx.shadowColor="rgba(255,210,77,0.95)";
    ctx.fillStyle="rgba(255,210,77,.92)";
    ctx.beginPath();
    ctx.arc(c.x,c.y,c.r,0,Math.PI*2);
    ctx.fill();
    ctx.shadowBlur=0;
    ctx.fillStyle="rgba(0,0,0,.25)";
    ctx.beginPath();
    ctx.arc(c.x,c.y,c.r*0.55,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle="rgba(255,255,255,.95)";
    ctx.font="900 11px system-ui, sans-serif";
    ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillText(String(c.val)+"x", c.x, c.y+0.5);
    ctx.restore();
  }

  function drawPickup(p){
    ctx.save();
    ctx.shadowBlur=18;
    ctx.shadowColor="rgba(124,255,234,.85)";
    ctx.fillStyle="rgba(124,255,234,.18)";
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r*1.25,0,Math.PI*2);
    ctx.fill();

    ctx.shadowBlur=0;
    ctx.fillStyle="rgba(0,0,0,.35)";
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();

    ctx.fillStyle="rgba(255,255,255,.95)";
    ctx.font="900 14px system-ui, sans-serif";
    ctx.textAlign="center"; ctx.textBaseline="middle";
    const map={shield:"üõ°",magnet:"üß≤",slowmo:"‚è±",nitro:"üöÄ",invisibility:"üëª"};
    ctx.fillText(map[p.type]||"‚≠ê", p.x, p.y+0.5);
    ctx.restore();
  }

  function applyPickup(type){
    if(inBonus){
      bonusCollected[type] = (bonusCollected[type]||0) + 1;
      return;
    }
    if(type==="shield") buffShield = Math.min(2, buffShield+1);
    if(type==="magnet") buffMagnet = Math.min(21, buffMagnet+7);
    if(type==="slowmo") buffSlowmo = Math.min(15, buffSlowmo+5);
    if(type==="nitro") nitro = Math.min(1.8, nitro+0.35);
    if(type==="invisibility") buffInvisibility = Math.min(12, buffInvisibility+6);
  }

  function startBonus(){
    inBonus=true;
    bonusT=12.0;
    hudBonus.style.display="inline-flex";
    sfx("bonus");

    buffBackup = { shield:buffShield, magnet:buffMagnet, slowmo:buffSlowmo, invisibility:buffInvisibility };
    buffShield=0; buffMagnet=0; buffSlowmo=0; buffInvisibility=0;
    traffic.length=0;
  }
  function endBonus(){
    inBonus=false;
    hudBonus.style.display="none";

    profile.bankCoins += bonusCollected.coins;
    saveProfile();
    syncHomeUI();

    for(const t of PICK_TYPES){
      const count = bonusCollected[t]||0;
      for(let i=0;i<count;i++) applyPickup(t);
    }
    bonusCollected = { coins:0, shield:0, magnet:0, slowmo:0, nitro:0, invisibility:0 };

    if(buffBackup){
      buffShield = Math.max(buffShield, buffBackup.shield);
      buffMagnet = Math.max(buffMagnet, buffBackup.magnet);
      buffSlowmo = Math.max(buffSlowmo, buffBackup.slowmo);
      buffInvisibility = Math.max(buffInvisibility, buffBackup.invisibility);
      buffBackup=null;
    }

    nextBonusAt = Math.floor(score) + 1000;
  }

  function hitCrash(){
    if(invulnT>0) return;
    sfx("crash");

    // combo reset on crash (addictive punishment)
    combo = 0; comboTimer = 0;
    hudCombo.style.display="none";

    if(buffInvisibility>0 && !inBonus) return;

    if(buffShield>0 && !inBonus){
      buffShield -= 1;
      score = Math.max(0, score - 40);
      invulnT = 0.8;
      toast("Shield saved you!");
      return;
    }

    lives -= 1;
    if(lives > 0){
      toast("Life lost!");
      score = Math.max(0, score - 80);
      invulnT = 1.2;
      return;
    }

    gameOver();
  }

  function gameOver(){
    running=false;
    paused=true;
    overlay.style.display="grid";
    pauseBgm();

    profile.bankCoins += runCoins;
    runCoins = 0;

    const sc=Math.floor(score);
    // commit ghost only if this run is best
    if(sc > (profile.bestScore||0)){
      profile.bestScore=sc;
      commitGhostIfBest();
    }
    saveProfile();
    syncHomeUI();

    const canRevive = !reviveUsed && profile.bankCoins >= 100;
    reviveBtn.disabled = !canRevive;
    reviveHint.textContent = canRevive ? "Revive available." : (!reviveUsed ? "Not enough coins for revive." : "Revive already used in this run.");
  }

  function updateMissionsProgress(){
    for(const m of profile.missions){
      if(m.type==="passCars") m.progress = Math.max(m.progress, passedCars);
      if(m.type==="collectCoins") m.progress = Math.max(m.progress, runCoins);
      if(m.type==="closeCalls") m.progress = Math.max(m.progress, closeCalls);
    }
  }

  function syncHUD(){
    hudScore.textContent = Math.floor(score);
    hudBest.textContent = profile.bestScore || 0;
    hudRunCoins.textContent = runCoins;
    hudLives.textContent = lives;
    hudRank.textContent = rankFor(profile.bestScore||0);

    if(inBonus) hudBonusT.textContent = bonusT.toFixed(1);

    // combo display
    if(combo>0){
      hudCombo.style.display="inline-flex";
      hudComboV.textContent = `x${comboMult().toFixed(2)}`;
    }else{
      hudCombo.style.display="none";
    }

    // ghost indicator
    hudGhost.style.display = ghostPlay ? "inline-flex" : "none";

    menuPlayer.textContent = profile.name || "Gamer";
    menuBank.textContent = profile.bankCoins || 0;
    menuBest.textContent = profile.bestScore || 0;
    menuRank.textContent = rankFor(profile.bestScore||0);
  }

  // Countdown
  let last=performance.now();

  // Nitro warp streaks
  const streaks = Array.from({length: 38}, () => ({
    x: Math.random(), y: Math.random(),
    l: rand(0.18, 0.55),
    s: rand(420, 920)
  }));
  function drawWarp(intensity){
    if(intensity<=0) return;
    ctx.save();
    ctx.globalAlpha = 0.55 * intensity;
    ctx.beginPath();
    ctx.rect(roadX(), 0, roadW(), vh);
    ctx.clip();

    ctx.lineWidth = 2;
    ctx.strokeStyle = `rgba(255,255,255,${0.18*intensity})`;
    for(const st of streaks){
      const x = roadX() + st.x*roadW();
      const y = (st.y*vh + (performance.now()*0.001*st.s)) % (vh+200) - 100;
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x, y + st.l*vh*0.22);
      ctx.stroke();
    }
    ctx.restore();
  }

  function update(dt){
    // Countdown (3,2,1,GO)
    if(countdown && !countdown.done){
      countdown.t += dt;
      if(countdown.t > 0.9){
        countdown.phase++;
        countdown.t=0;
        if(countdown.phase>=4){
          countdown.done=true;
          countdown.onDone?.();
        }
      }
    }

    invulnT = Math.max(0, invulnT - dt);

    // Difficulty ramp
    speed += DIFF.accel * dt;
    const easyWindow = clamp(score / 600, 0, 1);
    const spawnRate = (DIFF.spawnBase + (Math.floor(score) * DIFF.spawnRamp)) * (0.65 + 0.35*easyWindow);

    // Buff timers
    if(!inBonus){
      buffMagnet = Math.max(0, buffMagnet - dt);
      buffSlowmo = Math.max(0, buffSlowmo - dt);
      buffInvisibility  = Math.max(0, buffInvisibility  - dt);
    }

    // Input: joystick + keyboard (both supported)
    const kLeft  = keys.has("arrowleft") || keys.has("a");
    const kRight = keys.has("arrowright")|| keys.has("d");
    const kNitro = keys.has("arrowup") || keys.has("w");
    const kDrift = keys.has("shift");

    // Joystick mapping:
    // x: steer
    // y: up = nitro (negative y)
    const jx = joy.x;
    const jy = joy.y;

    const steerAxis = clamp((kLeft?-1:0) + (kRight?1:0) + jx, -1, 1);
    const nitroAxis = kNitro || (jy < -0.55);
    const driftAxis = kDrift || (Math.abs(steerAxis) > 0.82); // hard turn = drift bonus feel

    // Nitro
    nitroActive = nitroAxis && nitro > 0.02 && !inBonus;
    if(nitroActive) nitro = Math.max(0, nitro - dt*0.22);
    else nitro = Math.min(1.8, nitro + dt*0.14);

    const effectiveSpeed = speed + (nitroActive ? 105 : 0);

    // Obstacles remain easy early
    const obstacleFactor = 0.55 + clamp(score / 6000, 0, 0.45);
    const obstacleSpeed = effectiveSpeed * obstacleFactor;

    // Player movement (continuous, joystick premium feel)
    // Lower early, slightly faster later, still controlled
    const steerSpeed = lerp(520, 760, clamp(score/4200, 0, 1));
    const targetVx = steerAxis * steerSpeed;
    player.vx = lerp(player.vx, targetVx, 1 - Math.pow(0.0008, dt)); // smooth response
    player.x += player.vx * dt;

    // soft-centering when no input (feels nice)
    if(Math.abs(steerAxis) < 0.05){
      const mid = roadX() + roadW()/2;
      player.x = lerp(player.x, mid, dt*0.65);
    }

    enforceRoadBarrier();

    // Road scroll
    roadScroll += effectiveSpeed*dt;
    if(roadScroll>60) roadScroll-=60;

    // Combo decay
    decayCombo(dt);

    // Bonus logic
    if(!inBonus && Math.floor(score) >= nextBonusAt) startBonus();
    if(inBonus){
      bonusT -= dt;
      hudBonusT.textContent = bonusT.toFixed(1);
      if(bonusT <= 0) endBonus();
    }

    // Spawns
    if(!inBonus){
      spawnT += dt * spawnRate * (0.70 + effectiveSpeed/950);
      if(spawnT>=1){
        spawnT=0;
        spawnTraffic();
        if(score > 1200 && Math.random()<0.12) spawnTraffic();
      }
    }

    coinT += dt * (0.86 + effectiveSpeed/1150);
    if(coinT>=1){
      coinT=0;
      spawnCoin();
      if(Math.random()<0.34) spawnCoin();
    }

    pickT += dt * 0.33;
    if(pickT>=1){
      pickT=0;
      if(Math.random()<0.62) spawnPickup();
    }

    // Move traffic
    const obstacleScale = (!inBonus && buffSlowmo>0) ? 0.20 : 1.0;
    for(let i=traffic.length-1;i>=0;i--){
      const t=traffic[i];

      if(!t.passed && t.y > player.y + player.h*0.6){
        t.passed=true; passedCars++;
      }

      t.cd -= dt;
      const laneChangeRate = DIFF.laneChangeRate + clamp(score/3200, 0, 0.09);
      const laneChangeSpeed = DIFF.laneChangeSpeed + clamp(score/4200, 0, 2.0);

      if(t.cd<=0 && Math.random()<laneChangeRate){
        const dir = Math.random()<0.5 ? -1 : 1;
        const next = clamp(t.targetLane + dir, 0, laneCount-1);
        const safe = !traffic.some(o=>o!==t && o.targetLane===next && Math.abs(o.y - t.y) < t.h*1.1);
        if(safe) t.targetLane=next;
        t.cd = rand(0.85, 1.9);
      }

      const tx=laneCenter(t.targetLane);
      t.x += (tx - t.x) * dt * laneChangeSpeed;

      t.y += obstacleSpeed * dt * t.rel * obstacleScale;

      if(t.y > vh + 220) traffic.splice(i,1);
    }

    // Coins (MAGNET VACUUM ALL LANES)
    for(let i=coins.length-1;i>=0;i--){
      const c=coins[i];
      c.y += effectiveSpeed*dt*0.90;

      if(!inBonus && buffMagnet>0){
        const dx = (player.x - c.x);
        const dy = (player.y - c.y);
        const pull = 6.5 + clamp(score/2500, 0, 2.0);
        c.x += dx * dt * pull;
        c.y += dy * dt * (pull * 0.55);

        const d = Math.hypot(player.x - c.x, player.y - c.y);
        const collectR = Math.max(18, player.w*0.75);
        if(d < collectR){
          coins.splice(i,1);
          if(inBonus) bonusCollected.coins += c.val;
          else runCoins += c.val;
          sfx("coin");
          // combo reward for magnet vacuum feels good but not too much
          if(!inBonus && Math.random()<0.10) addCombo(1);
          continue;
        }
      }else{
        c.x += (laneCenter(c.lane) - c.x)*dt*2.0;
      }

      if(c.y > vh+140) coins.splice(i,1);
    }

    // Pickups
    for(let i=pickups.length-1;i>=0;i--){
      const p=pickups[i];
      p.y += effectiveSpeed*dt*0.88;
      p.x += (laneCenter(p.lane) - p.x)*dt*2.0;
      if(p.y > vh+90) pickups.splice(i,1);
    }

    // Score + multiplier (core addiction loop)
    const mult = comboMult();
    // base scoring
    let gain = dt * (24 + clamp(effectiveSpeed/55, 0, 10));
    if(nitroActive) gain += dt*7;
    if(driftAxis && Math.abs(steerAxis) > 0.25) gain += dt*6; // drift skill reward
    score += gain * mult;

    // Drift increases combo (skill)
    if(driftAxis && Math.abs(steerAxis) > 0.75 && !inBonus){
      if(Math.random() < 0.08) addCombo(1);
    }

    // Close calls (near miss = huge addiction)
    if(!inBonus){
      for(const t of traffic){
        const d = distRect(player.x,player.y,player.w,player.h, t.x,t.y,t.w,t.h);
        if(d>0 && d<8){
          // anti-farm: only occasionally + unique car id
          if(t.id !== lastNearMissId && Math.random()<0.16){
            lastNearMissId = t.id;
            closeCalls++;
            addCombo(2);
            score += 10 * mult;
            toastTop("üî• Near miss! +Combo");
          }
        }
      }
    }

    // Collect coins (normal overlap)
    for(let i=coins.length-1;i>=0;i--){
      const c=coins[i];
      if(rectHit(player.x,player.y,player.w*0.92,player.h*0.92, c.x,c.y, c.r*2, c.r*2)){
        coins.splice(i,1);
        if(inBonus) bonusCollected.coins += c.val;
        else runCoins += c.val;
        sfx("coin");
        if(!inBonus && Math.random()<0.10) addCombo(1);
      }
    }

    // Collect pickups
    for(let i=pickups.length-1;i>=0;i--){
      const p=pickups[i];
      if(rectHit(player.x,player.y,player.w*0.92,player.h*0.92, p.x,p.y, p.r*2, p.r*2)){
        pickups.splice(i,1);
        applyPickup(p.type);
        sfx("pickup");
        if(!inBonus) addCombo(1);
      }
    }

    // Collisions
    if(!inBonus && invulnT<=0){
      for(const t of traffic){
        if(rectHit(player.x,player.y,player.w,player.h, t.x,t.y,t.w,t.h)){
          hitCrash();
          break;
        }
      }
    }

    // Missions + saving
    updateMissionsProgress();

    // Praise popups
    if(!praised1000 && Math.floor(score) >= 1000){
      praised1000 = true;
      toastTop("üéâ Well done! 1,000+ points!");
    }
    if(!praised50cars && passedCars >= 50){
      praised50cars = true;
      toastTop("üî• Amazing! 50 cars dodged!");
    }

    // best score updates
    const sc=Math.floor(score);
    if(sc > (profile.bestScore||0)){
      profile.bestScore=sc;
      saveProfileThrottled(dt);
    }
    saveProfileThrottled(dt);

    // Ghost record
    recordGhost(dt);

    // Trail points
    if(nitroActive || Math.abs(player.vx) > 100 || mult > 1.2){
      // more trail when intense
      if(Math.random() < 0.70) addTrailPoint();
    }else if(Math.random() < 0.25){
      addTrailPoint();
    }

    syncHUD();
  }

  function drawGhost(){
    if(!ghostPlay) return;
    ghostPlay.t += (1/60); // approximate; this is visual only
    const idx = Math.floor(ghostPlay.t / ghostPlay.dt);
    if(idx <= 0 || idx >= ghostPlay.xs.length) return;

    const gx = ghostPlay.xs[idx];
    const w = player.w*0.98;
    const h = player.h*0.98;
    const gy = player.y;

    drawCar(gx, gy, w, h, false, "rgba(124,255,234,.55)", getSkin().hex, 0.30);
  }

  function draw(){
    drawRoad();

    const skin = getSkin();

    // Warp effect under entities
    drawWarp(nitroActive ? 1 : 0);

    // coins/pickups
    for(const c of coins) drawCoin(c);
    for(const p of pickups) drawPickup(p);

    // traffic
    for(const t of traffic){
      drawCar(t.x, t.y, t.w, t.h, false, "rgba(255,106,223,.60)");
    }

    // ghost
    drawGhost();

    // trail + player
    drawTrail(skin);
    drawCar(player.x, player.y, player.w, player.h, true, "rgba(124,255,234,.95)", skin.hex);

    // countdown
    if(countdown && !countdown.done){
      ctx.save();
      ctx.fillStyle="rgba(0,0,0,.35)";
      ctx.fillRect(0,0,vw,vh);
      ctx.fillStyle="rgba(255,255,255,.95)";
      ctx.textAlign="center";
      ctx.textBaseline="middle";
      ctx.font = "900 64px Orbitron, system-ui, sans-serif";
      const text = (countdown.phase===0) ? "3" : (countdown.phase===1) ? "2" : (countdown.phase===2) ? "1" : "GO!";
      ctx.fillText(text, vw/2, vh/2);
      ctx.restore();
    }
  }

  function loop(now){
    const dt = Math.min(0.033, (now-last)/1000);
    last=now;
    if(running && !paused) update(dt);
    draw();
    requestAnimationFrame(loop);
  }

  function restartRun(){
    resizeCanvas();
    layoutPlayer();
    resetRunState();
    running=true;
    paused=false;
    countdown=null;
    cinematicCountdown(()=>{});
    syncHUD();
    closeMenu();
  }

  reviveBtn.addEventListener("click", async ()=>{
    if(reviveUsed) return;
    if(profile.bankCoins < 100) return toast("Not enough coins.");
    profile.bankCoins -= 100;
    reviveUsed=true;
    saveProfile();

    lives = 1;
    running=true;
    paused=false;
    overlay.style.display="none";
    invulnT = 1.6;
    toast("Revived!");
    syncHomeUI();
    syncHUD();
    playBgm();
  });

  // =========================
  // UI wiring
  // =========================
  function goHow(){ document.getElementById("how").scrollIntoView({behavior:"smooth"}); }

  feedbackBtn.addEventListener("click", ()=>openInstagramDM("daily__discipline.01"));
  fbBtn2.addEventListener("click", ()=>openInstagramDM("daily__discipline.01"));
  howBtn.addEventListener("click", goHow);

  saveNameBtn.addEventListener("click", ()=>{
    const nm = (nameInput.value||"").trim().slice(0,18);
    profile.name = nm || "Gamer";
    saveProfile();
    syncHomeUI();
    toast("Name saved!");
  });

  claimBonusBtn.addEventListener("click", ()=>{
    const r = claimDailyBonus();
    syncHomeUI();
    toast(r.msg);
  });

  crateBtn.addEventListener("click", ()=>openDailyCrate());
  crateBtn2.addEventListener("click", ()=>openDailyCrate());

  playBtn.addEventListener("click", ()=>startRun());
  playFromTop.addEventListener("click", ()=>startRun());

  menuBtn.addEventListener("click", ()=>{
    if(!running && paused) return;
    if(paused) closeMenu(); else openMenu();
  });

  resumeBtn.addEventListener("click", ()=>{ if(!running) return; closeMenu(); });
  restartBtn.addEventListener("click", ()=>restartRun());

  exitBtn.addEventListener("click", async ()=>{
    // If ended mid-run, keep best updates + ghost commit handled in gameOver.
    // Submit best score online.
    await submitScoreOnline();
    await syncLeaderboard();
    exitToHome();
  });

  shareBtn.addEventListener("click", async ()=>{
    const r = rankFor(profile.bestScore||0);
    const text = `I scored ${profile.bestScore} (${r}) in Neon Highway Racer! üèéÔ∏èüî• Beat me:\n${location.href}`;
    try{
      if(navigator.share) await navigator.share({title:"Neon Highway Racer", text, url:location.href});
      else if(navigator.clipboard){ await navigator.clipboard.writeText(text); toast("Copied share text!"); }
      else prompt("Copy:", text);
    }catch{}
  });

  fsBtn.addEventListener("click", ()=>requestFS());

  document.addEventListener("visibilitychange", ()=>{
    if(document.hidden){
      pauseBgm();
      if(running && !paused) openMenu();
    }else{
      if(running && !paused) playBgm();
    }
  });

  // =========================
  // INIT
  // =========================
  ensureDailyMissions();
  syncHomeUI();
  bonusInfo.textContent = bonusPreview();
  nameInput.value = (profile.name && profile.name !== "Gamer") ? profile.name : "";

  renderMissions(missionsEl);
  renderMissions(missions2El);

  renderShop(shopEl);
  renderShop(shop2El);

  renderSkins(skinsEl);
  renderSkins(skins2El);

  syncCrateUI();
  syncLeaderboard();

  resizeCanvas();
  layoutPlayer();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
