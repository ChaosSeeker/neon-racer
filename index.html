<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Neon Highway Racer: Mythic Edition</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#02040a;
      --panel:#0b1230;
      --text:#eaf0ff; --muted:#9fb0e6;
      --a:#7cffea; --p:#ff6adf; --g:#ffd24d; --r:#ff4b5c;
      --common:#9fb0e6; --rare:#7cffea; --epic:#ff6adf; --legend:#ffd24d; --mythic:#ff3333;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family: 'Orbitron', sans-serif;}
    body{
      background: radial-gradient(circle at 50% 0%, #1a2a7a 0%, var(--bg) 75%);
      color:var(--text);
      overflow:hidden;
    }

    /* AAA Homepage Styling */
    .app{height:100%; display:flex; flex-direction:column;}
    .home{
      flex:1; overflow:auto; padding:30px; display:grid; gap:25px; align-content:start;
      background: linear-gradient(rgba(2,4,10,0.8), rgba(2,4,10,0.8)), url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
    }
    .hero{
      border: 2px solid var(--a);
      background: linear-gradient(135deg, rgba(124,255,234,0.15), rgba(255,106,223,0.1));
      border-radius:30px; padding:50px; text-align:center;
      box-shadow: 0 0 60px rgba(124,255,234,0.2);
    }
    .hero h1 { font-size: 52px; margin: 0; letter-spacing: 4px; text-shadow: 0 0 20px var(--a); }
    .hero .muted { font-size: 18px; margin-bottom: 25px; }

    .topbar{
      padding:15px 25px; background:rgba(11,18,48,.9); border-bottom:1px solid rgba(255,255,255,.1);
      backdrop-filter: blur(15px); display:flex; justify-content:space-between; align-items:center;
    }
    
    button{
      cursor:pointer; color:#000; background:var(--a); border:none; border-radius:12px;
      padding:12px 24px; font-weight:900; font-family:'Orbitron'; transition:0.2s;
    }
    button:hover{ transform: scale(1.05); box-shadow: 0 0 15px var(--a); }
    button:disabled{ opacity:0.4; cursor:not-allowed; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
    .card{ border:1px solid rgba(255,255,255,.1); background:rgba(11,18,48,.6); border-radius:20px; padding:20px; backdrop-filter: blur(10px); }
    
    .shopGrid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:20px; margin-top:15px; }
    .item{
      border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,0.03);
      border-radius:24px; padding:20px; display:flex; flex-direction:column; gap:12px;
    }
    .veh-preview {
      height: 120px; border-radius: 15px; display: flex; align-items: center; justify-content: center;
      position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);
    }

    .gameScreen{position:fixed; inset:0; display:none; background:#000;}
    .hud{ position:absolute; top:20px; left:20px; right:20px; display:flex; justify-content:space-between; pointer-events:none; z-index:100; }
    .pill{ background:rgba(11,18,48,0.8); border:1px solid var(--a); padding:10px 18px; border-radius:30px; display:flex; gap:10px; backdrop-filter:blur(5px); }

    canvas{ width:100%; height:100%; display:block; }
    
    .toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:var(--panel); border:1px solid var(--a); padding:12px 25px; border-radius:15px; z-index:1000; display:none; }
  </style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="brand"><h1>NEON HIGHWAY</h1></div>
    <div class="actions" style="display:flex; gap:15px; align-items:center;">
      <span class="pill">ðŸª™ <b id="bankCoins">0</b></span>
      <button id="playBtn">START ENGINE</button>
    </div>
  </div>

  <div class="home" id="home">
    <div class="hero">
      <h1>ASCEND THE LEGACY</h1>
      <p class="muted">5 Lanes. Infinite Speed. Zero Mercy.</p>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Daily Crate</h3>
        <button id="crateBtn">OPEN CRATE</button>
        <p id="crateInfo" class="small"></p>
      </div>
      <div class="card">
        <h3>Referral Task</h3>
        <p class="small">Invite 3 friends to submit a score.</p>
        <div id="referralStatus">Progress: 0/3</div>
        <button onclick="toast('Invite link copied!')" style="margin-top:10px; background:var(--p)">COPY LINK</button>
      </div>
    </div>

    <div class="card">
      <h2>Vehicle Showroom</h2>
      <div class="shopGrid" id="skins"></div>
    </div>
  </div>

  <div class="gameScreen" id="gameScreen">
    <div class="hud">
      <div style="display:flex; gap:10px;">
        <div class="pill">SCORE <b id="hudScore">0</b></div>
        <div class="pill">ARMOR <b id="hudArmor">0</b></div>
        <div class="pill" id="hudShieldPill" style="display:none">SHIELD ACTIVE</div>
      </div>
    </div>
    <canvas id="game"></canvas>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(() => {
  // CONFIGURATION
  const laneCount = 5; // 
  const VEHICLES = [
    { key:"v_sports", name:"Neon Dart", cost:0, hex:["#4df6ff","#ff5cd6"], speedMult: 1.0, driftMult: 1.0, armor: 0, rarity:"common" },
    { key:"v_drifter", name:"Drift King", cost:1200, hex:["#ff3366","#ff9933"], speedMult: 1.05, driftMult: 1.8, armor: 0, rarity:"rare" },
    { key:"v_suv", name:"Interceptor", cost:3000, hex:["#222222","#ff2e4d"], speedMult: 1.10, driftMult: 0.6, armor: 1, rarity:"epic" },
    { key:"v_tank", name:"Rhino Tank", cost:6000, hex:["#556b2f","#8b4513"], speedMult: 0.85, driftMult: 0.1, armor: 3, rarity:"legendary" }, // 
    { key:"v_mythic", name:"Void Runner", cost:15000, hex:["#ff0000","#000000"], speedMult: 1.35, driftMult: 2.0, armor: 5, rarity:"mythic" }
  ];

  // PROFILE
  let profile = JSON.parse(localStorage.getItem("neon_pro_v5") || "null") || {
    bankCoins: 500, bestScore: 0, ownedSkins: ["v_sports"], skin: "v_sports", referrals: 0
  };

  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  let vw, vh, running = false, score = 0, runCoins = 0, runArmor = 0, buffShield = 0;
  let player = { x: 0, y: 0, w: 40, h: 75, vx: 0 };
  let traffic = [], speed = 100, invulnT = 0;
  const keys = new Set();

  // UTILS
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const roadW = () => vw * 0.75; // 
  const roadX = () => (vw - roadW()) / 2; // 
  const laneW = () => roadW() / laneCount; // 
  const laneCenter = (l) => roadX() + laneW() * (l + 0.5); // [cite: 190]

  function toast(m) { const t = document.getElementById("toast"); t.textContent = m; t.style.display="block"; setTimeout(()=>t.style.display="none", 2000); }
  function save() { localStorage.setItem("neon_pro_v5", JSON.stringify(profile)); }

  // UI RENDERING
  function syncUI() {
    document.getElementById("bankCoins").textContent = profile.bankCoins;
    const shelf = document.getElementById("skins");
    shelf.innerHTML = "";
    VEHICLES.forEach(v => {
      const owned = profile.ownedSkins.includes(v.key);
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="veh-preview" style="background:linear-gradient(135deg, ${v.hex[0]}44, ${v.hex[1]}44)">
            <div style="width:30px; height:55px; background:linear-gradient(${v.hex[0]}, ${v.hex[1]}); border-radius:5px; box-shadow:0 0 15px ${v.hex[0]}"></div>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <b style="color:var(--${v.rarity})">${v.name}</b>
            <span class="small">${owned ? "OWNED" : v.cost + " ðŸª™"}</span>
        </div>
        <button ${owned && profile.skin === v.key ? "disabled" : ""} onclick="selectVehicle('${v.key}')">
            ${owned ? (profile.skin === v.key ? "SELECTED" : "EQUIP") : "BUY"}
        </button>
      `;
      shelf.appendChild(div);
    });
  }

  window.selectVehicle = (key) => {
    const v = VEHICLES.find(x => x.key === key);
    if (!profile.ownedSkins.includes(key)) {
      if (profile.bankCoins >= v.cost) {
        profile.bankCoins -= v.cost;
        profile.ownedSkins.push(key);
        toast("Vehicle Unlocked!");
      } else return toast("Insufficient Coins");
    }
    profile.skin = key;
    save(); syncUI();
  };

  // CRATE LOGIC 
  document.getElementById("crateBtn").onclick = () => {
    const today = new Date().toDateString();
    if (profile.lastCrate === today) return toast("Come back tomorrow!");
    
    // Restricted Pool: Coins 10-200, Skins/Vehicles Common-Epic only
    const roll = Math.random();
    if (roll < 0.7) {
      const amt = Math.floor(Math.random() * 191) + 10;
      profile.bankCoins += amt;
      toast(`Crate opened: +${amt} Coins!`);
    } else {
      const pool = VEHICLES.filter(v => ["common","rare","epic"].includes(v.rarity));
      const reward = pool[Math.floor(Math.random() * pool.length)];
      if (!profile.ownedSkins.includes(reward.key)) {
        profile.ownedSkins.push(reward.key);
        toast(`Unlocked: ${reward.name}!`);
      } else {
        profile.bankCoins += 300;
        toast("Duplicate: +300 Coins compensation.");
      }
    }
    profile.lastCrate = today;
    save(); syncUI();
  };

  // GAME ENGINE
  function spawnTraffic() {
    const lane = Math.floor(Math.random() * laneCount);
    //  Fix: Obstacle cars pick a lane and stay in it (no tracing)
    traffic.push({
      x: laneCenter(lane),
      y: -100,
      lane: lane,
      speed: speed * (0.6 + Math.random() * 0.4),
      w: 40, h: 75,
      color: "#ff4b5c"
    });
  }

  function update(dt) {
    if (!running) return;
    invulnT = Math.max(0, invulnT - dt);
    
    // Difficulty Scaling [cite: 302]
    const difficultyMod = score > 2000 ? 1.5 : 1.0;
    speed += 5 * dt * difficultyMod;
    
    // Player Movement
    const steer = (keys.has("a") || keys.has("arrowleft") ? -1 : 0) + (keys.has("d") || keys.has("arrowright") ? 1 : 0);
    player.vx = steer * 400 * VEHICLES.find(v=>v.key===profile.skin).speedMult;
    player.x = clamp(player.x + player.vx * dt, roadX() + 20, roadX() + roadW() - 20);

    // Traffic [cite: 334]
    if (Math.random() < 0.02 * (score > 2000 ? 1.2 : 1)) {
        if (traffic.length < (score > 2000 ? 8 : 5)) spawnTraffic();
    }

    traffic.forEach((t, i) => {
      t.y += t.speed * dt;
      if (t.y > vh) traffic.splice(i, 1);

      // Collision [cite: 205, 357]
      if (invulnT <= 0 && Math.abs(player.x - t.x) < 35 && Math.abs(player.y - t.y) < 70) {
        if (runArmor > 0) {
          runArmor--;
          traffic.splice(i, 1);
          invulnT = 0.8;
          toast("Armor Blocked Crash!");
        } else {
            //  Shield Fix: Uses shield powerup if available
            if (buffShield > 0) {
                buffShield = 0;
                invulnT = 1.0;
                traffic.splice(i, 1);
                toast("Shield Consumed!");
            } else {
                running = false;
                profile.bankCoins += Math.floor(score/10);
                save(); syncUI();
                document.getElementById("home").style.display = "grid";
                document.getElementById("gameScreen").style.display = "none";
                toast("Game Over!");
            }
        }
      }
    });

    score += dt * 50;
    document.getElementById("hudScore").textContent = Math.floor(score);
    document.getElementById("hudArmor").textContent = runArmor;
  }

  function draw() {
    ctx.fillStyle = "#050814";
    ctx.fillRect(0, 0, vw, vh);

    // Road [cite: 231]
    ctx.fillStyle = "#111a33";
    ctx.fillRect(roadX(), 0, roadW(), vh);
    
    ctx.strokeStyle = "rgba(124,255,234,0.3)";
    ctx.setLineDash([20, 20]);
    for(let i=1; i<laneCount; i++) {
      ctx.beginPath();
      ctx.moveTo(roadX() + i * laneW(), 0);
      ctx.lineTo(roadX() + i * laneW(), vh);
      ctx.stroke();
    }
    ctx.setLineDash([]);

    // Player [cite: 243]
    const skin = VEHICLES.find(v => v.key === profile.skin);
    ctx.fillStyle = skin.hex[0];
    ctx.shadowBlur = 15; ctx.shadowColor = skin.hex[0];
    ctx.fillRect(player.x - 20, player.y - 37, 40, 75);
    ctx.shadowBlur = 0;

    // Traffic [cite: 264]
    ctx.fillStyle = "#ff4b5c";
    traffic.forEach(t => ctx.fillRect(t.x - 20, t.y - 37, 40, 75));
  }

  function loop(now) {
    const dt = 1/60;
    update(dt);
    draw();
    requestAnimationFrame(loop);
  }

  function startRun() {
    vw = canvas.width = window.innerWidth;
    vh = canvas.height = window.innerHeight;
    const skin = VEHICLES.find(v => v.key === profile.skin);
    player.x = vw/2; player.y = vh * 0.8;
    runArmor = skin.armor;
    score = 0; traffic = []; running = true;
    document.getElementById("home").style.display = "none";
    document.getElementById("gameScreen").style.display = "block";
  }

  window.addEventListener("keydown", e => keys.add(e.key.toLowerCase()));
  window.addEventListener("keyup", e => keys.delete(e.key.toLowerCase()));
  document.getElementById("playBtn").onclick = startRun;

  syncUI();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
